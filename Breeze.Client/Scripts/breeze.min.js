(function(definition){if(typeof exports==="object"){module.exports=definition()}else if(typeof define==="function"){define(definition)}else{breeze=definition()}})(function(){var breeze={version:"1.4.1",metadataVersion:"1.0.5"};var __hasOwnProperty=uncurry(Object.prototype.hasOwnProperty);var __arraySlice=uncurry(Array.prototype.slice);function __objectForEach(obj,kvFn){for(var key in obj){if(__hasOwnProperty(obj,key)){kvFn(key,obj[key])}}}function __objectFirst(obj,kvPredicate){for(var key in obj){if(__hasOwnProperty(obj,key)){var value=obj[key];if(kvPredicate(key,value)){return{key:key,value:value}}}}return null}function __objectMapToArray(obj,kvFn){var results=[];for(var key in obj){if(__hasOwnProperty(obj,key)){var result=kvFn?kvFn(key,obj[key]):obj[key];if(result!==undefined){results.push(result)}}}return results}function __propEq(propertyName,value){return function(obj){return obj[propertyName]===value}}function __pluck(propertyName){return function(obj){return obj[propertyName]}}function __getOwnPropertyValues(source){var result=[];for(var name in source){if(__hasOwnProperty(source,name)){result.push(source[name])}}return result}function __extend(target,source){if(!source)return target;for(var name in source){if(__hasOwnProperty(source,name)){target[name]=source[name]}}return target}function __updateWithDefaults(target,defaults){for(var name in defaults){if(target[name]===undefined){target[name]=defaults[name]}}return target}function __setAsDefault(target,ctor){ctor.defaultInstance=__updateWithDefaults(new ctor(target),ctor.defaultInstance);return target}function __toJson(source,template){var target={};for(var propName in template){if(!(propName in source))continue;var value=source[propName];var defaultValue=template[propName];if(value==defaultValue)continue;if(Array.isArray(value)&&value.length===0)continue;if(typeof defaultValue==="function"){value=defaultValue(value)}else if(typeof value==="object"){if(value&&value.parentEnum){value=value.name}}if(value===undefined)continue;target[propName]=value}return target}function __resolveProperties(sources,propertyNames){var r={};var length=sources.length;propertyNames.forEach(function(pn){for(var i=0;i<length;i++){var src=sources[i];if(src){var val=src[pn];if(val!==undefined){r[pn]=val;break}}}});return r}function __toArray(item){if(!item){return[]}else if(Array.isArray(item)){return item}else{return[item]}}function __arrayFirst(array,predicate){for(var i=0,j=array.length;i<j;i++){if(predicate(array[i])){return array[i]}}return null}function __arrayIndexOf(array,predicate){for(var i=0,j=array.length;i<j;i++){if(predicate(array[i]))return i}return-1}function __arrayRemoveItem(array,predicateOrItem,shouldRemoveMultiple){var predicate=__isFunction(predicateOrItem)?predicateOrItem:undefined;var lastIx=array.length-1;var removed=false;for(var i=lastIx;i>=0;i--){if(predicate?predicate(array[i]):array[i]===predicateOrItem){array.splice(i,1);removed=true;if(!shouldRemoveMultiple){return removed}}}return removed}function __arrayZip(a1,a2,callback){var result=[];var n=Math.min(a1.length,a2.length);for(var i=0;i<n;++i){result.push(callback(a1[i],a2[i]))}return result}function __arrayDistinct(array){array=array||[];var result=[];for(var i=0,j=array.length;i<j;i++){if(result.indexOf(array[i])<0)result.push(array[i])}return result}function __arrayEquals(a1,a2,equalsFn){if(!a1||!a2)return false;if(a1.length!==a2.length)return false;for(var i=0;i<a1.length;i++){if(Array.isArray(a1[i])){if(!__arrayEquals(a1[i],a2[i]))return false}else{if(equalsFn){if(!equalsFn(a1[i],a2[i]))return false}else{if(a1[i]!==a2[i])return false}}}return true}function __getArray(source,propName){var arr=source[propName];if(!arr){arr=[];source[propName]=arr}return arr}function __requireLib(libNames,errMessage){var arrNames=libNames.split(";");for(var i=0,j=arrNames.length;i<j;i++){var lib=__requireLibCore(arrNames[i]);if(lib)return lib}if(errMessage){throw new Error("Unable to initialize "+libNames+".  "+errMessage||"")}}function __requireLibCore(libName){var lib;try{if(this.window){var window=this.window;lib=window[libName];if(lib)return lib;if(window.require){lib=window.require(libName)}if(lib)return lib}if(require){lib=require(libName)}}catch(e){}return lib}function __using(obj,property,tempValue,fn){var originalValue=obj[property];if(tempValue===originalValue){return fn()}obj[property]=tempValue;try{return fn()}finally{if(originalValue===undefined){delete obj[property]}else{obj[property]=originalValue}}}function __wrapExecution(startFn,endFn,fn){var state;try{state=startFn();return fn()}catch(e){if(typeof state==="object"){state.error=e}throw e}finally{endFn(state)}}function __memoize(fn){return function(){var args=__arraySlice(arguments),hash="",i=args.length,currentArg=null;while(i--){currentArg=args[i];hash+=currentArg===Object(currentArg)?JSON.stringify(currentArg):currentArg;fn.memoize||(fn.memoize={})}return hash in fn.memoize?fn.memoize[hash]:fn.memoize[hash]=fn.apply(this,args)}}function __getUuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})}function __durationToSeconds(duration){if(typeof duration!=="string")throw new Error("Invalid ISO8601 duration '"+duration+"'");var struct=/^P((\d+Y)?(\d+M)?(\d+D)?)?(T(\d+H)?(\d+M)?(\d+S)?)?$/.exec(duration);if(!struct)throw new Error("Invalid ISO8601 duration '"+duration+"'");var ymdhmsIndexes=[2,3,4,6,7,8];var factors=[31104e3,2592e3,86400,3600,60,1];var seconds=0;for(var i=0;i<6;i++){var digit=struct[ymdhmsIndexes[i]];digit=digit?+digit.replace(/[A-Za-z]+/g,""):0;seconds+=digit*factors[i]}return seconds}function __classof(o){if(o===null){return"null"}if(o===undefined){return"undefined"}return Object.prototype.toString.call(o).slice(8,-1).toLowerCase()}function __isDate(o){return __classof(o)==="date"&&!isNaN(o.getTime())}function __isFunction(o){return __classof(o)==="function"}function __isGuid(value){return typeof value==="string"&&/[a-fA-F\d]{8}-(?:[a-fA-F\d]{4}-){3}[a-fA-F\d]{12}/.test(value)}function __isDuration(value){return typeof value==="string"&&/^(-|)?P[T]?[\d\.,\-]+[YMDTHS]/.test(value)}function __isEmpty(obj){if(obj===null||obj===undefined){return true}for(var key in obj){if(__hasOwnProperty(obj,key)){return false}}return true}function __isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}function __stringStartsWith(str,prefix){if(!str||!prefix)return false;return str.indexOf(prefix,0)===0}function __stringEndsWith(str,suffix){if(!str||!suffix)return false;return str.indexOf(suffix,str.length-suffix.length)!==-1}function __formatString(string){var args=arguments;var pattern=RegExp("%([1-"+(arguments.length-1)+"])","g");return string.replace(pattern,function(match,index){return args[index]})}function uncurry(f){var call=Function.call;return function(){return call.apply(f,arguments)}}if(!Object.create){Object.create=function(parent){var F=function(){};F.prototype=parent;return new F}}var core={};core.objectForEach=__objectForEach;core.extend=__extend;core.propEq=__propEq;core.pluck=__pluck;core.arrayEquals=__arrayEquals;core.arrayFirst=__arrayFirst;core.arrayIndexOf=__arrayIndexOf;core.arrayRemoveItem=__arrayRemoveItem;core.arrayZip=__arrayZip;core.requireLib=__requireLib;core.using=__using;core.memoize=__memoize;core.getUuid=__getUuid;core.durationToSeconds=__durationToSeconds;core.isDate=__isDate;core.isGuid=__isGuid;core.isDuration=__isDuration;core.isFunction=__isFunction;core.isEmpty=__isEmpty;core.isNumeric=__isNumeric;core.stringStartsWith=__stringStartsWith;core.stringEndsWith=__stringEndsWith;core.formatString=__formatString;core.parent=breeze;breeze.core=core;var Param=function(){var ctor=function(v,name){this.v=v;this.name=name;this._contexts=[null]};var proto=ctor.prototype;proto.isObject=function(){return this.isTypeOf("object")};proto.isBoolean=function(){return this.isTypeOf("boolean")};proto.isString=function(){return this.isTypeOf("string")};proto.isNonEmptyString=function(){return addContext(this,{fn:isNonEmptyString,msg:"must be a nonEmpty string"})};function isNonEmptyString(context,v){if(v==null)return false;return typeof v==="string"&&v.length>0}proto.isNumber=function(){return this.isTypeOf("number")};proto.isFunction=function(){return this.isTypeOf("function")};proto.isTypeOf=function(typeName){return addContext(this,{fn:isTypeOf,typeName:typeName,msg:__formatString("must be a '%1'",typeName)})};function isTypeOf(context,v){if(v==null)return false;if(typeof v===context.typeName)return true;return false}proto.isInstanceOf=function(type,typeName){typeName=typeName||type.prototype._$typeName;return addContext(this,{fn:isInstanceOf,type:type,typeName:typeName,msg:__formatString("must be an instance of '%1'",typeName)})};function isInstanceOf(context,v){if(v==null)return false;return v instanceof context.type}proto.hasProperty=function(propertyName){return addContext(this,{fn:hasProperty,propertyName:propertyName,msg:__formatString("must have a '%1' property ",propertyName)})};function hasProperty(context,v){if(v==null)return false;return v[context.propertyName]!==undefined}proto.isEnumOf=function(enumType){return addContext(this,{fn:isEnumOf,enumType:enumType,msg:__formatString("must be an instance of the '%1' enumeration",enumType.name)})};function isEnumOf(context,v){if(v==null)return false;return context.enumType.contains(v)}proto.isRequired=function(allowNull){return addContext(this,{fn:isRequired,allowNull:allowNull,msg:"is required"})};function isRequired(context,v){if(context.allowNull){return v!==undefined}else{return v!=null}}proto.isOptional=function(){var context={fn:isOptional,prevContext:null,msg:isOptionalMessage};return addContext(this,context)};function isOptional(context,v){if(v==null)return true;var prevContext=context.prevContext;if(prevContext){return prevContext.fn(prevContext,v)}else{return true}}function isOptionalMessage(context,v){var prevContext=context.prevContext;var element=prevContext?" or it "+getMessage(prevContext,v):"";return"is optional"+element}proto.isNonEmptyArray=function(){return this.isArray(true)};proto.isArray=function(mustNotBeEmpty){var context={fn:isArray,mustNotBeEmpty:mustNotBeEmpty,prevContext:null,msg:isArrayMessage};return addContext(this,context)};function isArray(context,v){if(!Array.isArray(v)){return false}if(context.mustNotBeEmpty){if(v.length===0)return false}var prevContext=context.prevContext;if(!prevContext)return true;return v.every(function(v1){return prevContext.fn(prevContext,v1)})}function isArrayMessage(context,v){var arrayDescr=context.mustNotBeEmpty?"a nonEmpty array":"an array";var prevContext=context.prevContext;var element=prevContext?" where each element "+getMessage(prevContext,v):"";return" must be "+arrayDescr+element}function getMessage(context,v){var msg=context.msg;if(typeof msg==="function"){msg=msg(context,v)}return msg}proto.or=function(){this._contexts.push(null);this._context=null;return this};proto.check=function(defaultValue){var ok=exec(this);if(ok===undefined)return;if(!ok){throw new Error(this.getMessage())}if(this.v!==undefined){return this.v}else{return defaultValue}};proto._addContext=function(context){return addContext(this,context)};function addContext(that,context){if(that._context){var curContext=that._context;while(curContext.prevContext!=null){curContext=curContext.prevContext}if(curContext.prevContext===null){curContext.prevContext=context;return that}else if(context.prevContext===null){context.prevContext=that._context}else{throw new Error("Illegal construction - use 'or' to combine checks")}}return setContext(that,context)}function setContext(that,context){that._contexts[that._contexts.length-1]=context;that._context=context;return that}function exec(self){var contexts=self._contexts;if(contexts[contexts.length-1]==null){contexts.pop()}if(contexts.length===0){return undefined}return contexts.some(function(context){return context.fn(context,self.v)})}proto.getMessage=function(){var that=this;var message=this._contexts.map(function(context){return getMessage(context,that.v)}).join(", or it ");return __formatString(this.MESSAGE_PREFIX,this.name)+" "+message};proto.withDefault=function(defaultValue){this.defaultValue=defaultValue;return this};proto.whereParam=function(propName){return this.parent.whereParam(propName)};proto.applyAll=function(instance,checkOnly,allowUnknownProperty){var parentTypeName=instance._$typeName;allowUnknownProperty=allowUnknownProperty||parentTypeName&&this.parent.config._$typeName===parentTypeName;var clone=__extend({},this.parent.config);this.parent.params.forEach(function(p){if(!allowUnknownProperty)delete clone[p.name];try{p.check()}catch(e){throwConfigError(instance,e.message)}!checkOnly&&p._applyOne(instance)});if(!allowUnknownProperty){for(var key in clone){if(clone[key]!==undefined){throwConfigError(instance,__formatString("Unknown property: '%1'.",key))}}}};function throwConfigError(instance,message){throw new Error(__formatString("Error configuring an instance of '%1'. %2",instance&&instance._$typeName||"object",message))}proto._applyOne=function(instance){if(this.v!==undefined){instance[this.name]=this.v}else{if(this.defaultValue!==undefined){instance[this.name]=this.defaultValue}}};proto.MESSAGE_PREFIX="The '%1' parameter ";return ctor}();var assertParam=function(v,name){return new Param(v,name)};var ConfigParam=function(){var ctor=function(config){if(typeof config!=="object"){throw new Error("Configuration parameter should be an object, instead it is a: "+typeof config)}this.config=config;this.params=[]};var proto=ctor.prototype;proto.whereParam=function(propName){var param=new Param(this.config[propName],propName);param.parent=this;this.params.push(param);return param};return ctor}();var assertConfig=function(config){return new ConfigParam(config)};core.Param=Param;core.assertParam=assertParam;core.assertConfig=assertConfig;var Enum=function(){var ctor=function(name,methodObj){this.name=name;var prototype=new EnumSymbol(methodObj);prototype.parentEnum=this;this._symbolPrototype=prototype;if(methodObj){Object.keys(methodObj).forEach(function(key){prototype[key]=methodObj[key]})}};var proto=ctor.prototype;ctor.isSymbol=function(obj){return obj instanceof EnumSymbol};proto.fromName=function(name){return this[name]};proto.addSymbol=function(propertiesObj){var newSymbol=Object.create(this._symbolPrototype);if(propertiesObj){Object.keys(propertiesObj).forEach(function(key){newSymbol[key]=propertiesObj[key]})}setTimeout(function(){newSymbol.getName()},0);return newSymbol};proto.seal=function(){this.getSymbols().forEach(function(sym){return sym.getName()})};proto.getSymbols=function(){return this.getNames().map(function(key){return this[key]},this)};proto.getNames=function(){var result=[];for(var key in this){if(this.hasOwnProperty(key)){if(key!=="name"&&key.substr(0,1)!=="_"&&!__isFunction(this[key])){result.push(key)}}}return result};proto.contains=function(sym){if(!(sym instanceof EnumSymbol)){return false}return this[sym.getName()]===sym};function EnumSymbol(){}EnumSymbol.prototype.getName=function(){if(!this.name){var that=this;this.name=__arrayFirst(this.parentEnum.getNames(),function(name){return that.parentEnum[name]===that})}return this.name};EnumSymbol.prototype.toString=function(){return this.getName()};EnumSymbol.prototype.toJSON=function(){return{_$typeName:this.parentEnum.name,name:this.name}};return ctor}();core.Enum=Enum;var Event=function(){var __eventNameMap={};var __nextUnsubKey=1;var ctor=function(name,publisher,defaultErrorCallback){assertParam(name,"eventName").isNonEmptyString().check();assertParam(publisher,"publisher").isObject().check();this.name=name;__eventNameMap[name]=true;this.publisher=publisher;if(defaultErrorCallback){this._defaultErrorCallback=defaultErrorCallback}};var proto=ctor.prototype;proto.publish=function(data,publishAsync,errorCallback){if(!ctor._isEnabled(this.name,this.publisher))return false;if(publishAsync===true){setTimeout(publishCore,0,this,data,errorCallback)}else{publishCore(this,data,errorCallback)}return true};function publishCore(that,data,errorCallback){var subscribers=that._subscribers;if(!subscribers)return true;subscribers.forEach(function(s){try{s.callback(data)}catch(e){e.context="unable to publish on topic: "+that.name;if(errorCallback){errorCallback(e)}else if(that._defaultErrorCallback){that._defaultErrorCallback(e)}else{fallbackErrorHandler(e)}}})}proto.publishAsync=function(data,errorCallback){this.publish(data,true,errorCallback)};proto.subscribe=function(callback){if(!this._subscribers){this._subscribers=[]}var unsubKey=__nextUnsubKey;this._subscribers.push({unsubKey:unsubKey,callback:callback});++__nextUnsubKey;return unsubKey};proto.unsubscribe=function(unsubKey){if(!this._subscribers)return false;var subs=this._subscribers;var ix=__arrayIndexOf(subs,function(s){return s.unsubKey===unsubKey});if(ix!==-1){subs.splice(ix,1);if(subs.length===0){this._subscribers=null}return true}else{return false}};proto.clear=function(){this._subscribers=null};ctor.bubbleEvent=function(target,getParentFn){target._getEventParent=getParentFn};ctor.enable=function(eventName,obj,isEnabled){assertParam(eventName,"eventName").isNonEmptyString().check();assertParam(obj,"obj").isObject().check();assertParam(isEnabled,"isEnabled").isBoolean().isOptional().or().isFunction().check();if(!obj._$eventMap){obj._$eventMap={}}obj._$eventMap[eventName]=isEnabled};ctor.isEnabled=function(eventName,obj){assertParam(eventName,"eventName").isNonEmptyString().check();assertParam(obj,"obj").isObject().check();if(!obj._getEventParent){throw new Error("This object does not support event enabling/disabling")}return ctor._isEnabled(obj,eventName)};ctor._isEnabled=function(eventName,obj){var isEnabled=null;var eventMap=obj._$eventMap;if(eventMap){isEnabled=eventMap[eventName]}if(isEnabled!=null){if(typeof isEnabled==="function"){return isEnabled(obj)}else{return!!isEnabled}}else{var parent=obj._getEventParent&&obj._getEventParent();if(parent){return ctor._isEnabled(eventName,parent)}else{return true}}};function fallbackErrorHandler(e){}return ctor}();core.Event=Event;var __config=function(){var __config={};__config.functionRegistry={};__config.typeRegistry={};__config.objectRegistry={};__config.interfaceInitialized=new Event("interfaceInitialized",__config);var InterfaceDef=function(name){this.name=name;this.defaultInstance=null;this._implMap={}};InterfaceDef.prototype.registerCtor=function(adapterName,ctor){this._implMap[adapterName.toLowerCase()]={ctor:ctor,defaultInstance:null}};InterfaceDef.prototype.getImpl=function(adapterName){return this._implMap[adapterName.toLowerCase()]};InterfaceDef.prototype.getFirstImpl=function(){var kv=__objectFirst(this._implMap,function(){return true});return kv?kv.value:null};__config.interfaceRegistry={ajax:new InterfaceDef("ajax"),modelLibrary:new InterfaceDef("modelLibrary"),dataService:new InterfaceDef("dataService")};__config.interfaceRegistry.modelLibrary.getDefaultInstance=function(){if(!this.defaultInstance){throw new Error("Unable to locate the default implementation of the '"+this.name+"' interface.  Possible options are 'ko', 'backingStore' or 'backbone'. See the breeze.config.initializeAdapterInstances method.")}return this.defaultInstance};__config.setProperties=function(config){assertConfig(config).whereParam("remoteAccessImplementation").isOptional().whereParam("trackingImplementation").isOptional().whereParam("ajaxImplementation").isOptional().applyAll(config);if(config.remoteAccessImplementation){__config.initializeAdapterInstance("dataService",config.remoteAccessImplementation)}if(config.trackingImplementation){__config.initializeAdapterInstance("modelLibrary",config.trackingImplementation)}if(config.ajaxImplementation){__config.initializeAdapterInstance("ajax",config.ajaxImplementation)}};__config.registerAdapter=function(interfaceName,adapterCtor){assertParam(interfaceName,"interfaceName").isNonEmptyString().check();assertParam(adapterCtor,"adapterCtor").isFunction().check();var impl=new adapterCtor;var implName=impl.name;if(!implName){throw new Error("Unable to locate a 'name' property on the constructor passed into the 'registerAdapter' call.")}var idef=getInterfaceDef(interfaceName);idef.registerCtor(implName,adapterCtor)};__config.getAdapter=function(interfaceName,adapterName){var idef=getInterfaceDef(interfaceName);if(adapterName){var impl=idef.getImpl(adapterName);return impl?impl.ctor:null}else{return idef.defaultInstance?idef.defaultInstance._$impl.ctor:null}};__config.initializeAdapterInstances=function(config){assertConfig(config).whereParam("dataService").isOptional().whereParam("modelLibrary").isOptional().whereParam("ajax").isOptional().applyAll(this,false);return __objectMapToArray(config,__config.initializeAdapterInstance)};__config.initializeAdapterInstance=function(interfaceName,adapterName,isDefault){isDefault=isDefault===undefined?true:isDefault;assertParam(interfaceName,"interfaceName").isNonEmptyString().check();assertParam(adapterName,"adapterName").isNonEmptyString().check();assertParam(isDefault,"isDefault").isBoolean().check();var idef=getInterfaceDef(interfaceName);var impl=idef.getImpl(adapterName);if(!impl){throw new Error("Unregistered adapter.  Interface: "+interfaceName+" AdapterName: "+adapterName)}return initializeAdapterInstanceCore(idef,impl,isDefault)};__config.getAdapterInstance=function(interfaceName,adapterName){var idef=getInterfaceDef(interfaceName);var impl;if(adapterName&&adapterName!==""){impl=idef.getImpl(adapterName);return impl?impl.defaultInstance:null}else{if(idef.defaultInstance){return idef.defaultInstance}else{impl=idef.getFirstImpl();if(impl.defaultInstance){return impl.defaultInstance}else{return initializeAdapterInstanceCore(idef,impl,true)}}}};__config.registerFunction=function(fn,fnName){assertParam(fn,"fn").isFunction().check();assertParam(fnName,"fnName").isString().check();fn.prototype._$fnName=fnName;__config.functionRegistry[fnName]=fn};__config._storeObject=function(obj,type,name){var key=(typeof type==="string"?type:type.prototype._$typeName)+"."+name;__config.objectRegistry[key]=obj};__config._fetchObject=function(type,name){if(!name)return undefined;var key=(typeof type==="string"?type:type.prototype._$typeName)+"."+name;var result=__config.objectRegistry[key];if(!result){throw new Error("Unable to locate a registered object by the name: "+key)}return result};__config.registerType=function(ctor,typeName){assertParam(ctor,"ctor").isFunction().check();assertParam(typeName,"typeName").isString().check();ctor.prototype._$typeName=typeName;__config.typeRegistry[typeName]=ctor};__config.stringifyPad="  ";function initializeAdapterInstanceCore(interfaceDef,impl,isDefault){var instance=impl.defaultInstance;if(!instance){instance=new impl.ctor;impl.defaultInstance=instance;instance._$impl=impl}instance.initialize();if(isDefault){interfaceDef.defaultInstance=instance}__config.interfaceInitialized.publish({interfaceName:interfaceDef.name,instance:instance,isDefault:true});if(instance.checkForRecomposition){__config.interfaceInitialized.subscribe(function(interfaceInitializedArgs){instance.checkForRecomposition(interfaceInitializedArgs)})}return instance}function getInterfaceDef(interfaceName){var lcName=interfaceName.toLowerCase();var kv=__objectFirst(__config.interfaceRegistry||{},function(k,v){return k.toLowerCase()===lcName});if(!kv){throw new Error("Unknown interface name: "+interfaceName)}return kv.value}return __config}();var __modelLibraryDef=__config.interfaceRegistry.modelLibrary;core.config=__config;breeze.config=__config;var observableArray=function(){var mixin={};mixin.push=function(){if(this._inProgress){return-1}var goodAdds=this._getGoodAdds(__arraySlice(arguments));if(!goodAdds.length){return this.length}this._beforeChange();var result=Array.prototype.push.apply(this,goodAdds);processAdds(this,goodAdds);return result};mixin._push=function(){if(this._inProgress){return-1}var goodAdds=__arraySlice(arguments);this._beforeChange();var result=Array.prototype.push.apply(this,goodAdds);processAdds(this,goodAdds);return result};mixin.unshift=function(){var goodAdds=this._getGoodAdds(__arraySlice(arguments));if(!goodAdds.length){return this.length}this._beforeChange();var result=Array.prototype.unshift.apply(this,goodAdds);processAdds(this,__arraySlice(goodAdds));return result};mixin.pop=function(){this._beforeChange();var result=Array.prototype.pop.apply(this);processRemoves(this,[result]);return result};mixin.shift=function(){this._beforeChange();var result=Array.prototype.shift.apply(this);processRemoves(this,[result]);return result};mixin.splice=function(){var goodAdds=this._getGoodAdds(__arraySlice(arguments,2));var newArgs=__arraySlice(arguments,0,2).concat(goodAdds);this._beforeChange();var result=Array.prototype.splice.apply(this,newArgs);processRemoves(this,result);if(goodAdds.length){processAdds(this,goodAdds)}return result};mixin.getEntityAspect=function(){return this.parent.entityAspect||this.parent.complexAspect.getEntityAspect()};mixin._getEventParent=function(){return this.getEntityAspect()};mixin._getPendingPubs=function(){var em=this.getEntityAspect().entityManager;return em&&em._pendingPubs};mixin._beforeChange=function(){};function updateEntityState(obsArray){var entityAspect=obsArray.getEntityAspect();if(entityAspect.entityState.isUnchanged()){entityAspect.setModified()}if(entityAspect.entityState.isModified()&&!obsArray._origValues){obsArray._origValues=obsArray.slice(0)}}function processAdds(obsArray,adds){obsArray._processAdds(adds);publish(obsArray,"arrayChanged",{array:obsArray,added:adds})}function processRemoves(obsArray,removes){obsArray._processRemoves(removes);publish(obsArray,"arrayChanged",{array:obsArray,removed:removes})}function publish(publisher,eventName,eventArgs){var pendingPubs=publisher._getPendingPubs();if(pendingPubs){if(!publisher._pendingArgs){publisher._pendingArgs=eventArgs;pendingPubs.push(function(){publisher[eventName].publish(publisher._pendingArgs);publisher._pendingArgs=null})}else{combineArgs(publisher._pendingArgs,eventArgs)}}else{publisher[eventName].publish(eventArgs)}}function combineArgs(target,source){for(var key in source){if(key!=="array"&&target.hasOwnProperty(key)){var sourceValue=source[key];var targetValue=target[key];if(targetValue){if(!Array.isArray(targetValue)){throw new Error("Cannot combine non array args")}Array.prototype.push.apply(targetValue,sourceValue)}else{target[key]=sourceValue}}}}function initializeParent(obsArray,parent,parentProperty){obsArray.parent=parent;obsArray.parentProperty=parentProperty}return{mixin:mixin,publish:publish,updateEntityState:updateEntityState,initializeParent:initializeParent}}();var Validator=function(){var INT16_MIN=-32768;var INT16_MAX=32767;var INT32_MIN=-2147483648;var INT32_MAX=2147483647;var BYTE_MIN=0;var BYTE_MAX=255;var rootContext={displayName:function(context){if(context.property){return context.property.displayName||context.propertyName||context.property.name}else{return"Value"}}};var ctor=function(name,valFn,context){this._baseContext=context||{};this._baseContext.name=name;context=__extend(Object.create(rootContext),this._baseContext);context.messageTemplate=context.messageTemplate||ctor.messageTemplates[name];this.name=name;this.valFn=valFn;this.context=context};var proto=ctor.prototype;proto._$typeName="Validator";proto.validate=function(value,additionalContext){var currentContext;if(additionalContext){currentContext=__extend(Object.create(this.context),additionalContext)}else{currentContext=this.context}this.currentContext=currentContext;try{if(this.valFn(value,currentContext)){return null}else{currentContext.value=value;return new ValidationError(this,currentContext,this.getMessage())}}catch(e){return new ValidationError(this,currentContext,"Exception occured while executing this validator: "+this.name)}};proto.getMessage=function(){try{var context=this.currentContext;var message=context.message;if(message){if(typeof message==="function"){return message(context)}else{return message}}else if(context.messageTemplate){return formatTemplate(context.messageTemplate,context)}else{return"invalid value: "+this.name||"{unnamed validator}"}}catch(e){return"Unable to format error message"+e.toString()}};proto.toJSON=function(){return this._baseContext};ctor.fromJSON=function(json){var validatorName="Validator."+json.name;var fn=__config.functionRegistry[validatorName];if(!fn){throw new Error("Unable to locate a validator named:"+json.name)}return fn(json)};ctor.register=function(validator){__config.registerFunction(function(){return validator},"Validator."+validator.name)};ctor.registerFactory=function(validatorFn,name){__config.registerFunction(validatorFn,"Validator."+name)};ctor.messageTemplates={bool:"'%displayName%' must be a 'true' or 'false' value",creditCard:"The %displayName% is not a valid credit card number",date:"'%displayName%' must be a date",duration:"'%displayName%' must be a ISO8601 duration string, such as 'P3H24M60S'",emailAddress:"The %displayName% '%value%' is not a valid email address",guid:"'%displayName%' must be a GUID",integer:"'%displayName%' must be an integer",integerRange:"'%displayName%' must be an integer between the values of %minValue% and %maxValue%",maxLength:"'%displayName%' must be a string with less than %maxLength% characters",number:"'%displayName%' must be a number",phone:"The %displayName% '%value%' is not a valid phone number",regularExpression:"The %displayName% '%value%' does not match '%expression%'",required:"'%displayName%' is required",string:"'%displayName%' must be a string",stringLength:"'%displayName%' must be a string with between %minLength% and %maxLength% characters",url:"The %displayName% '%value%' is not a valid url"};ctor.required=function(){var valFn=function(v,ctx){if(typeof v==="string"){if(ctx&&ctx.allowEmptyStrings)return true;return v.length>0}else{return v!=null}};return new ctor("required",valFn)};ctor.maxLength=function(context){var valFn=function(v,ctx){if(v==null)return true;if(typeof v!=="string")return false;return v.length<=ctx.maxLength};return new ctor("maxLength",valFn,context)};ctor.stringLength=function(context){var valFn=function(v,ctx){if(v==null)return true;if(typeof v!=="string")return false;if(ctx.minLength!=null&&v.length<ctx.minLength)return false;if(ctx.maxLength!=null&&v.length>ctx.maxLength)return false;return true};return new ctor("stringLength",valFn,context)};ctor.string=function(){var valFn=function(v){if(v==null)return true;return typeof v==="string"};return new ctor("string",valFn)};ctor.guid=function(){var valFn=function(v){if(v==null)return true;return __isGuid(v)};return new ctor("guid",valFn)};ctor.duration=function(){var valFn=function(v){if(v==null)return true;return __isDuration(v)};return new ctor("duration",valFn)};ctor.number=ctor.double=ctor.single=function(context){var valFn=function(v,ctx){if(v==null)return true;if(typeof v==="string"&&ctx&&ctx.allowString){v=parseInt(v,10)}return typeof v==="number"&&!isNaN(v)};return new ctor("number",valFn,context)};ctor.integer=ctor.int64=function(context){var valFn=function(v,ctx){if(v==null)return true;if(typeof v==="string"&&ctx&&ctx.allowString){v=parseInt(v,10)}return typeof v==="number"&&!isNaN(v)&&Math.floor(v)===v};return new ctor("integer",valFn,context)};ctor.int32=function(context){return intRangeValidatorCtor("int32",INT32_MIN,INT32_MAX,context)()};ctor.int16=function(context){return intRangeValidatorCtor("int16",INT16_MIN,INT16_MAX,context)()};ctor.byte=function(context){return intRangeValidatorCtor("byte",BYTE_MIN,BYTE_MAX,context)()};ctor.bool=function(){var valFn=function(v){if(v==null)return true;return v===true||v===false};return new ctor("bool",valFn)};ctor.none=function(){var valFn=function(v){return true};return new ctor("none",valFn)};ctor.date=function(){var valFn=function(v){if(v==null)return true;if(typeof v==="string"){try{return!isNaN(Date.parse(v))
}catch(e){return false}}else{return __isDate(v)}};return new ctor("date",valFn)};ctor.creditCard=function(context){function valFn(v){if(v==null||v==="")return true;if(typeof v!=="string")return false;v=v.replace(/(\-|\s)/g,"");if(!v||/\D/.test(v))return false;return luhn(v)}return new ctor("creditCard",valFn,context)};function luhn(a,b,c,d,e){for(d=+a[b=a.length-1],e=0;b--;)c=+a[b],d+=++e%2?2*c%10+(c>4):c;return!(d%10)}ctor.regularExpression=function(context){function valFn(v,ctx){if(v==null||v==="")return true;if(typeof v!=="string")return false;try{var re=new RegExp(ctx.expression)}catch(e){throw new Error("Missing or invalid expression parameter to regExp validator")}return re.test(v)}return new ctor("regularExpression",valFn,context)};ctor.emailAddress=function(context){var reEmailAddress=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/;return makeRegExpValidator("emailAddress",reEmailAddress,null,context)};ctor.phone=function(context){var rePhone=/^((\+|(0(\d+)?[-/.\s]?))[1-9]\d{0,2}[-/.\s]?)?((\(\d{1,6}\)|\d{1,6})[-/.\s]?)?(\d+[-/.\s]?)+\d+$/;return makeRegExpValidator("phone",rePhone,null,context)};ctor.url=function(context){var reUrlProtocolRequired=/^(https?|ftp):\/\/(((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|([a-zA-Z][\-a-zA-Z0-9]*)|((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/;return makeRegExpValidator("url",reUrlProtocolRequired,null,context)};ctor.makeRegExpValidator=makeRegExpValidator;function makeRegExpValidator(validatorName,expression,defaultMessage,context){if(defaultMessage){ctor.messageTemplates[validatorName]=defaultMessage}var re=typeof expression==="string"?new RegExp(expression):expression;var valFn=function(v){if(v==null||v==="")return true;if(typeof v!=="string")return false;return re.test(v)};return new ctor(validatorName,valFn,context)}__objectForEach(ctor,function(key,value){if(typeof value!=="function"){return}if(key==="fromJSON"||key==="register"||key==="registerFactory"||key==="makeRegExpValidator"){return}__config.registerFunction(value,"Validator."+key)});function formatTemplate(template,vars,ownPropertiesOnly){if(!vars)return template;return template.replace(/%([^%]+)%/g,function(_,key){var valOrFn;if(ownPropertiesOnly){valOrFn=vars.hasOwnProperty(key)?vars[key]:""}else{valOrFn=vars[key]}if(valOrFn){if(__isFunction(valOrFn)){return valOrFn(vars)}else{return valOrFn}}else{return""}})}function intRangeValidatorCtor(validatorName,minValue,maxValue,context){ctor.messageTemplates[validatorName]=__formatString("'%displayName%' must be an integer between the values of %1 and %2",minValue,maxValue);return function(){var valFn=function(v,ctx){if(v==null)return true;if(typeof v==="string"&&ctx&&ctx.allowString){v=parseInt(v,0)}if(typeof v==="number"&&!isNaN(v)&&Math.floor(v)===v){if(minValue!=null&&v<minValue){return false}if(maxValue!=null&&v>maxValue){return false}return true}else{return false}};return new ctor(validatorName,valFn,context)}}return ctor}();var ValidationError=function(){var ctor=function(validator,context,errorMessage,key){assertParam(validator,"validator").isOptional().isInstanceOf(Validator).check();assertParam(errorMessage,"errorMessage").isNonEmptyString().check();assertParam(key,"key").isOptional().isNonEmptyString().check();this.validator=validator;var context=context||{};this.context=context;this.errorMessage=errorMessage;this.property=context.property;this.propertyName=context.propertyName||context.property&&context.property.name;if(key){this.key=key}else{this.key=ValidationError.getKey(validator||errorMessage,this.propertyName)}this.isServerError=false};ctor.getKey=function(validatorOrErrorName,propertyName){return(validatorOrErrorName.name||validatorOrErrorName)+(propertyName?":"+propertyName:"")};return ctor}();breeze.Validator=Validator;breeze.ValidationError=ValidationError;var ValidationOptions=function(){var ctor=function(config){updateWithConfig(this,config)};var proto=ctor.prototype;proto._$typeName="ValidationOptions";proto.using=function(config){if(!config)return this;var result=new ValidationOptions(this);updateWithConfig(result,config);return result};proto.setAsDefault=function(){return __setAsDefault(this,ctor)};ctor.defaultInstance=new ctor({validateOnAttach:true,validateOnSave:true,validateOnQuery:false,validateOnPropertyChange:true});function updateWithConfig(obj,config){if(config){assertConfig(config).whereParam("validateOnAttach").isBoolean().isOptional().whereParam("validateOnSave").isBoolean().isOptional().whereParam("validateOnQuery").isBoolean().isOptional().whereParam("validateOnPropertyChange").isBoolean().isOptional().applyAll(obj)}return obj}return ctor}();breeze.ValidationOptions=ValidationOptions;breeze.makeComplexArray=function(){var complexArrayMixin={};complexArrayMixin._getGoodAdds=function(adds){return getGoodAdds(this,adds)};complexArrayMixin._beforeChange=function(){observableArray.updateEntityState(this)};complexArrayMixin._processAdds=function(adds){processAdds(this,adds)};complexArrayMixin._processRemoves=function(removes){processRemoves(this,removes)};complexArrayMixin._rejectChanges=function(){if(!this._origValues)return;var that=this;this.forEach(function(co){clearAspect(co,that)});this.length=0;this._origValues.forEach(function(co){that.push(co)});Array.prototype.push.apply(this,this._origValues)};complexArrayMixin._acceptChanges=function(){this._origValues=null};function getGoodAdds(complexArray,adds){return adds.filter(function(a){return a.parent!==complexArray.parent})}function processAdds(complexArray,adds){adds.forEach(function(a){if(a.parent!=null){throw new Error("The complexObject is already attached. Either clone it or remove it from its current owner")}setAspect(a,complexArray)})}function processRemoves(complexArray,removes){removes.forEach(function(a){clearAspect(a,complexArray)})}function clearAspect(co,arr){var coAspect=co.complexAspect;if(coAspect.parent!==arr.parent)return null;coAspect.parent=null;coAspect.parentProperty=null;return coAspect}function setAspect(co,arr){var coAspect=co.complexAspect;if(coAspect.parent===arr.parent)return null;coAspect.parent=arr.parent;coAspect.parentProperty=arr.parentProperty;return coAspect}function makeComplexArray(arr,parent,parentProperty){observableArray.initializeParent(arr,parent,parentProperty);arr.arrayChanged=new Event("arrayChanged",arr);__extend(arr,observableArray.mixin);return __extend(arr,complexArrayMixin)}return makeComplexArray}();var EntityAction=function(){var entityActionMethods={isAttach:function(){return!!this.isAttach},isDetach:function(){return!!this.isDetach},isModification:function(){return!!this.isModification}};var EntityAction=new Enum("EntityAction",entityActionMethods);EntityAction.Attach=EntityAction.addSymbol({isAttach:true});EntityAction.AttachOnQuery=EntityAction.addSymbol({isAttach:true});EntityAction.AttachOnImport=EntityAction.addSymbol({isAttach:true});EntityAction.Detach=EntityAction.addSymbol({isDetach:true});EntityAction.MergeOnQuery=EntityAction.addSymbol({isModification:true});EntityAction.MergeOnImport=EntityAction.addSymbol({isModification:true});EntityAction.MergeOnSave=EntityAction.addSymbol({isModification:true});EntityAction.PropertyChange=EntityAction.addSymbol({isModification:true});EntityAction.EntityStateChange=EntityAction.addSymbol();EntityAction.AcceptChanges=EntityAction.addSymbol();EntityAction.RejectChanges=EntityAction.addSymbol({isModification:true});EntityAction.Clear=EntityAction.addSymbol({isDetach:true});EntityAction.seal();return EntityAction}();breeze.EntityAction=EntityAction;var EntityAspect=function(){var ctor=function(entity){if(entity===null){var nullInstance=EntityAspect._nullInstance;if(nullInstance)return nullInstance;EntityAspect._nullInstance=this}else if(entity===undefined){throw new Error("The EntityAspect ctor requires an entity as its only argument.")}else if(entity.entityAspect){return entity.entityAspect}if(!(this instanceof EntityAspect)){return new EntityAspect(entity)}this.entity=entity;this.entityGroup=null;this.entityManager=null;this.entityState=EntityState.Detached;this.isBeingSaved=false;this.originalValues={};this.hasValidationErrors=false;this._validationErrors={};this.validationErrorsChanged=new Event("validationErrorsChanged",this);this.propertyChanged=new Event("propertyChanged",this);if(entity!=null){entity.entityAspect=this;var entityType=entity.entityType;if(!entityType){var typeName=entity.prototype._$typeName;if(!typeName){throw new Error("This entity is not registered as a valid EntityType")}else{throw new Error("Metadata for this entityType has not yet been resolved: "+typeName)}}var entityCtor=entityType.getEntityCtor();__modelLibraryDef.getDefaultInstance().startTracking(entity,entityCtor.prototype)}};var proto=ctor.prototype;Event.bubbleEvent(proto,function(){return this.entityManager});proto.getKey=function(forceRefresh){forceRefresh=assertParam(forceRefresh,"forceRefresh").isBoolean().isOptional().check(false);if(forceRefresh||!this._entityKey){var entityType=this.entity.entityType;var keyProps=entityType.keyProperties;var values=keyProps.map(function(p){return this.entity.getProperty(p.name)},this);this._entityKey=new EntityKey(entityType,values)}return this._entityKey};proto.acceptChanges=function(){var em=this.entityManager;if(this.entityState.isDeleted()){em.detachEntity(this.entity)}else{this.setUnchanged()}em.entityChanged.publish({entityAction:EntityAction.AcceptChanges,entity:this.entity})};proto.rejectChanges=function(){var entity=this.entity;var entityManager=this.entityManager;__using(entityManager,"isRejectingChanges",true,function(){rejectChangesCore(entity)});if(this.entityState.isAdded()){entityManager.detachEntity(entity);entityManager._notifyStateChange(entity,false)}else{if(this.entityState.isDeleted()){this.entityManager._linkRelatedEntities(entity)}this.setUnchanged();this.propertyChanged.publish({entity:entity,propertyName:null});this.entityManager.entityChanged.publish({entityAction:EntityAction.RejectChanges,entity:entity})}};function rejectChangesCore(target){var aspect=target.entityAspect||target.complexAspect;var stype=target.entityType||target.complexType;var originalValues=aspect.originalValues;for(var propName in originalValues){target.setProperty(propName,originalValues[propName])}stype.complexProperties.forEach(function(cp){var cos=target.getProperty(cp.name);if(cp.isScalar){rejectChangesCore(cos)}else{cos._rejectChanges();cos.forEach(function(co){rejectChangesCore(co)})}})}proto.getPropertyPath=function(propName){return propName};proto.setUnchanged=function(){clearOriginalValues(this.entity);delete this.hasTempKey;this.entityState=EntityState.Unchanged;this.entityManager._notifyStateChange(this.entity,false)};function clearOriginalValues(target){var aspect=target.entityAspect||target.complexAspect;aspect.originalValues={};var stype=target.entityType||target.complexType;stype.complexProperties.forEach(function(cp){var cos=target.getProperty(cp.name);if(cp.isScalar){clearOriginalValues(cos)}else{cos._acceptChanges();cos.forEach(function(co){clearOriginalValues(co)})}})}proto.setModified=function(){this.entityState=EntityState.Modified;this.entityManager._notifyStateChange(this.entity,true)};proto.setDeleted=function(){var em=this.entityManager;var entity=this.entity;if(this.entityState.isAdded()){em.detachEntity(entity);em._notifyStateChange(entity,false)}else{this.entityState=EntityState.Deleted;removeFromRelations(entity,EntityState.Deleted);em._notifyStateChange(entity,true)}};proto.setDetached=function(){var group=this.entityGroup;if(!group){return false}var entity=this.entity;group.detachEntity(entity);removeFromRelations(entity,EntityState.Detached);this.entityManager.entityChanged.publish({entityAction:EntityAction.Detach,entity:entity});this._detach();return true};proto.loadNavigationProperty=function(navigationProperty,callback,errorCallback){var entity=this.entity;var navProperty=entity.entityType._checkNavProperty(navigationProperty);var query=EntityQuery.fromEntityNavigation(entity,navProperty,callback,errorCallback);return entity.entityAspect.entityManager.executeQuery(query,callback,errorCallback)};proto.validateEntity=function(){var ok=true;this._processValidationOpAndPublish(function(that){ok=validateTarget(that.entity)});return ok};function validateTarget(target){var ok=true;var stype=target.entityType||target.complexType;var aspect=target.entityAspect||target.complexAspect;var entityAspect=target.entityAspect||target.complexAspect.getEntityAspect();stype.getProperties().forEach(function(p){var value=target.getProperty(p.name);var propName=aspect.getPropertyPath(p.name);if(p.validators.length>0){var context={entity:entityAspect.entity,property:p,propertyName:propName};ok=entityAspect._validateProperty(value,context)&&ok}if(p.isComplexProperty){if(p.isScalar){ok=validateTarget(value)&&ok}else{}}});stype.validators.forEach(function(validator){ok=validate(entityAspect,validator,aspect.entity)&&ok});return ok}proto.validateProperty=function(property,context){var value=this.getPropertyValue(property);if(value&&value.complexAspect){return validateTarget(value)}context=context||{};context.entity=this.entity;if(typeof property==="string"){context.property=this.entity.entityType.getProperty(property,true);context.propertyName=property}else{context.property=property;context.propertyName=property.name}return this._validateProperty(value,context)};proto.getValidationErrors=function(property){assertParam(property,"property").isOptional().isEntityProperty().or().isString().check();var result=__getOwnPropertyValues(this._validationErrors);if(property){var propertyName=typeof property==="string"?property:property.name;result=result.filter(function(ve){return ve.property.name===propertyName})}return result};proto.addValidationError=function(validationError){assertParam(validationError,"validationError").isInstanceOf(ValidationError).check();this._processValidationOpAndPublish(function(that){that._addValidationError(validationError)})};proto.removeValidationError=function(validationErrorOrKey){assertParam(validationErrorOrKey,"validationErrorOrKey").isString().or().isInstanceOf(ValidationError).or().isInstanceOf(Validator).check();var key=typeof validationErrorOrKey==="string"?validationErrorOrKey:validationErrorOrKey.key;this._processValidationOpAndPublish(function(that){that._removeValidationError(key)})};proto.clearValidationErrors=function(){this._processValidationOpAndPublish(function(that){__objectForEach(that._validationErrors,function(key,valError){if(valError){delete that._validationErrors[key];that._pendingValidationResult.removed.push(valError)}});that.hasValidationErrors=!__isEmpty(this._validationErrors)})};proto.getParentKey=function(navigationProperty){var fkNames=navigationProperty.foreignKeyNames;if(fkNames.length===0)return null;var that=this;var fkValues=fkNames.map(function(fkn){return that.entity.getProperty(fkn)});return new EntityKey(navigationProperty.entityType,fkValues)};proto.getPropertyValue=function(property){assertParam(property,"property").isString().or().isEntityProperty().check();var value;if(typeof property==="string"){var propNames=property.trim().split(".");var propName=propNames.shift();value=this.entity;value=value.getProperty(propName);while(propNames.length>0){propName=propNames.shift();value=value.getProperty(propName)}}else{if(!(property.parentType instanceof EntityType)){throw new Error("The validateProperty method does not accept a 'property' parameter whose parentType is a ComplexType; "+"Pass a 'property path' string as the 'property' parameter instead ")}value=this.entity.getProperty(property.name)}return value};proto._detach=function(){this.entityGroup=null;this.entityManager=null;this.entityState=EntityState.Detached;this.originalValues={};this._validationErrors={};this.hasValidationErrors=false;this.validationErrorsChanged.clear();this.propertyChanged.clear()};proto._validateProperty=function(value,context){var ok=true;this._processValidationOpAndPublish(function(that){context.property.validators.forEach(function(validator){ok=validate(that,validator,value,context)&&ok})});return ok};proto._processValidationOpAndPublish=function(validationFn){if(this._pendingValidationResult){validationFn(this)}else{try{this._pendingValidationResult={entity:this.entity,added:[],removed:[]};validationFn(this);if(this._pendingValidationResult.added.length>0||this._pendingValidationResult.removed.length>0){this.validationErrorsChanged.publish(this._pendingValidationResult);this.entityManager&&this.entityManager.validationErrorsChanged.publish(this._pendingValidationResult)}}finally{this._pendingValidationResult=undefined}}};proto._addValidationError=function(validationError){this._validationErrors[validationError.key]=validationError;this.hasValidationErrors=true;this._pendingValidationResult.added.push(validationError)};proto._removeValidationError=function(key){var valError=this._validationErrors[key];if(valError){delete this._validationErrors[key];this.hasValidationErrors=!__isEmpty(this._validationErrors);this._pendingValidationResult.removed.push(valError)}};function removeFromRelations(entity,entityState){var isDeleted=entityState.isDeleted();if(isDeleted){removeFromRelationsCore(entity,true)}else{__using(entity.entityAspect.entityManager,"isLoading",true,function(){removeFromRelationsCore(entity,false)})}}function removeFromRelationsCore(entity,isDeleted){entity.entityType.navigationProperties.forEach(function(np){var inverseNp=np.inverse;if(!inverseNp)return;var npValue=entity.getProperty(np.name);if(np.isScalar){if(npValue){if(inverseNp.isScalar){clearNp(npValue,inverseNp,isDeleted)}else{var collection=npValue.getProperty(inverseNp.name);if(collection.length){__arrayRemoveItem(collection,entity)}}entity.setProperty(np.name,null)}}else{npValue.slice(0).forEach(function(v){if(inverseNp.isScalar){clearNp(v,inverseNp,isDeleted)}else{}});npValue.length=0}})}function clearNp(entity,np,relatedIsDeleted){if(relatedIsDeleted){entity.setProperty(np.name,null)}else{var em=entity.entityAspect.entityManager;var fkNames=np.foreignKeyNames;if(fkNames){var fkVals=fkNames.map(function(fkName){return entity.getProperty(fkName)})}entity.setProperty(np.name,null);if(fkNames){fkNames.forEach(function(fkName,i){entity.setProperty(fkName,fkVals[i])})}}}function validate(aspect,validator,value,context){var ve=validator.validate(value,context);if(ve){aspect._addValidationError(ve);return false}else{var key=ValidationError.getKey(validator,context?context.propertyName:null);aspect._removeValidationError(key);return true}}return ctor}();var ComplexAspect=function(){var ctor=function(complexObject,parent,parentProperty){if(!complexObject){throw new Error("The  ComplexAspect ctor requires an entity as its only argument.")}if(complexObject.complexAspect){return complexObject.complexAspect}if(!(this instanceof ComplexAspect)){return new ComplexAspect(complexObject,parent,parentProperty)}this.complexObject=complexObject;complexObject.complexAspect=this;this.originalValues={};if(parent!=null){this.parent=parent;this.parentProperty=parentProperty}var complexType=complexObject.complexType;if(!complexType){var typeName=complexObject.prototype._$typeName;if(!typeName){throw new Error("This entity is not registered as a valid ComplexType")}else{throw new Error("Metadata for this complexType has not yet been resolved: "+typeName)}}var complexCtor=complexType.getCtor();__modelLibraryDef.getDefaultInstance().startTracking(complexObject,complexCtor.prototype)};var proto=ctor.prototype;proto.getEntityAspect=function(){var parent=this.parent;if(!parent)return new EntityAspect(null);var entityAspect=parent.entityAspect;while(parent&&!entityAspect){parent=parent.complexAspect&&parent.complexAspect.parent;entityAspect=parent&&parent.entityAspect}return entityAspect||new EntityAspect(null)};proto.getPropertyPath=function(propName){var parent=this.parent;if(!parent)return null;var aspect=parent.complexAspect||parent.entityAspect;return aspect.getPropertyPath(this.parentProperty.name+"."+propName)};return ctor}();breeze.EntityAspect=EntityAspect;breeze.ComplexAspect=ComplexAspect;var EntityKey=function(){var ENTITY_KEY_DELIMITER=":::";var ctor=function(entityType,keyValues){assertParam(entityType,"entityType").isInstanceOf(EntityType).check();var subtypes=entityType.getSelfAndSubtypes();if(subtypes.length>1){this._subtypes=subtypes.filter(function(st){return st.isAbstract===false})}if(!Array.isArray(keyValues)){keyValues=__arraySlice(arguments,1)}this.entityType=entityType;entityType.keyProperties.forEach(function(kp,i){if(kp.dataType===DataType.Guid){keyValues[i]=keyValues[i]&&keyValues[i].toLowerCase()}});this.values=keyValues;this._keyInGroup=createKeyString(keyValues)};ctor._$typeName="EntityKey";var proto=ctor.prototype;proto.toJSON=function(){return{entityType:this.entityType.name,values:this.values}};ctor.fromJSON=function(json,metadataStore){var et=metadataStore._getEntityType(json.entityType,true);return new EntityKey(et,json.values)};proto.equals=function(entityKey){if(!(entityKey instanceof EntityKey))return false;return this.entityType===entityKey.entityType&&__arrayEquals(this.values,entityKey.values)};proto.toString=function(){return this.entityType.name+"-"+this._keyInGroup};ctor.equals=function(k1,k2){if(!(k1 instanceof EntityKey))return false;return k1.equals(k2)};proto._isEmpty=function(){return this.values.join("").length===0};ctor.createKeyString=createKeyString;function createKeyString(keyValues){return keyValues.join(ENTITY_KEY_DELIMITER)}return ctor}();breeze.EntityKey=EntityKey;var EntityState=function(){var entityStateMethods={isUnchanged:function(){return this===EntityState.Unchanged},isAdded:function(){return this===EntityState.Added},isModified:function(){return this===EntityState.Modified},isDeleted:function(){return this===EntityState.Deleted},isDetached:function(){return this===EntityState.Detached},isUnchangedOrModified:function(){return this===EntityState.Unchanged||this===EntityState.Modified},isAddedModifiedOrDeleted:function(){return this===EntityState.Added||this===EntityState.Modified||this===EntityState.Deleted}};var EntityState=new Enum("EntityState",entityStateMethods);EntityState.Unchanged=EntityState.addSymbol();EntityState.Added=EntityState.addSymbol();EntityState.Modified=EntityState.addSymbol();EntityState.Deleted=EntityState.addSymbol();EntityState.Detached=EntityState.addSymbol();EntityState.seal();return EntityState}();breeze.EntityState=EntityState;breeze.makePrimitiveArray=function(){var primitiveArrayMixin={};primitiveArrayMixin._getGoodAdds=function(adds){return adds};primitiveArrayMixin._beforeChange=function(){var entityAspect=this.getEntityAspect();if(entityAspect.entityState.isUnchanged()){entityAspect.setModified()}if(entityAspect.entityState.isModified()&&!this._origValues){this._origValues=this.slice(0)}};primitiveArrayMixin._processAdds=function(adds){};primitiveArrayMixin._processRemoves=function(removes){};primitiveArrayMixin._rejectChanges=function(){if(!this._origValues)return;this.length=0;Array.prototype.push.apply(this,this._origValues)};primitiveArrayMixin._acceptChanges=function(){this._origValues=null};function makePrimitiveArray(arr,parent,parentProperty){observableArray.initializeParent(arr,parent,parentProperty);arr.arrayChanged=new Event("arrayChanged",arr);__extend(arr,observableArray.mixin);return __extend(arr,primitiveArrayMixin)}return makePrimitiveArray}();breeze.makeRelationArray=function(){var relationArrayMixin={};relationArrayMixin.load=function(callback,errorCallback){var parent=this.parentEntity;var query=EntityQuery.fromEntityNavigation(this.parentEntity,this.navigationProperty);var em=parent.entityAspect.entityManager;return em.executeQuery(query,callback,errorCallback)};relationArrayMixin._getEventParent=function(){return this.parentEntity.entityAspect};relationArrayMixin._getPendingPubs=function(){var em=this.parentEntity.entityAspect.entityManager;return em&&em._pendingPubs};relationArrayMixin._getGoodAdds=function(adds){return getGoodAdds(this,adds)};relationArrayMixin._processAdds=function(adds){processAdds(this,adds)};relationArrayMixin._processRemoves=function(removes){processRemoves(this,removes)};function getGoodAdds(relationArray,adds){var goodAdds=checkForDups(relationArray,adds);if(!goodAdds.length){return goodAdds}var parentEntity=relationArray.parentEntity;var entityManager=parentEntity.entityAspect.entityManager;if(entityManager&&!entityManager.isLoading){goodAdds.forEach(function(add){if(add.entityAspect.entityState.isDetached()){relationArray._inProgress=true;try{entityManager.attachEntity(add,EntityState.Added)}finally{relationArray._inProgress=false}}})}return goodAdds}function processAdds(relationArray,adds){var parentEntity=relationArray.parentEntity;var np=relationArray.navigationProperty;var addsInProcess=relationArray._addsInProcess;var invNp=np.inverse;var startIx=addsInProcess.length;try{adds.forEach(function(childEntity){addsInProcess.push(childEntity);if(invNp){childEntity.setProperty(invNp.name,parentEntity)}else{var pks=parentEntity.entityType.keyProperties;np.invForeignKeyNames.forEach(function(fk,i){childEntity.setProperty(fk,parentEntity.getProperty(pks[i].name))})}})}finally{addsInProcess.splice(startIx,adds.length)}}function processRemoves(relationArray,removes){var inp=relationArray.navigationProperty.inverse;if(inp){removes.forEach(function(childEntity){childEntity.setProperty(inp.name,null)})}}function checkForDups(relationArray,adds){var parentEntity=relationArray.parentEntity;var navProp=relationArray.navigationProperty;var inverseProp=navProp.inverse;var goodAdds;if(inverseProp){goodAdds=adds.filter(function(a){if(relationArray._addsInProcess.indexOf(a)>=0){return false}var inverseValue=a.getProperty(inverseProp.name);return inverseValue!==parentEntity})}else{var fkPropNames=navProp.invForeignKeyNames;var keyProps=parentEntity.entityType.keyProperties;goodAdds=adds.filter(function(a){if(relationArray._addsInProcess.indexOf(a)>=0){return false}return fkPropNames.some(function(fk,i){var keyProp=keyProps[i].name;var keyVal=parentEntity.getProperty(keyProp);var fkVal=a.getProperty(fk);return keyVal!==fkVal})})}return goodAdds}function makeRelationArray(arr,parentEntity,navigationProperty){arr.parentEntity=parentEntity;arr.navigationProperty=navigationProperty;arr.arrayChanged=new Event("arrayChanged",arr);arr._addsInProcess=[];__extend(arr,observableArray.mixin);return __extend(arr,relationArrayMixin)}return makeRelationArray}();function defaultPropertyInterceptor(property,newValue,rawAccessorFn){if(newValue===undefined)newValue=null;var oldValue=rawAccessorFn();var dataType=property.dataType;if(dataType&&dataType.parse){if(Array.isArray(newValue)&&!property.isScalar){newValue=newValue.map(function(nv){return dataType.parse(nv,typeof nv)})}else{newValue=dataType.parse(newValue,typeof newValue)}}if(newValue===oldValue||dataType&&dataType.isDate&&newValue&&oldValue&&newValue.valueOf()===oldValue.valueOf()){return}var that=this;var propName=property.name;var localAspect,key,relatedEntity;var entityAspect=this.entityAspect;if(entityAspect){localAspect=entityAspect}else{localAspect=this.complexAspect;entityAspect=localAspect.getEntityAspect()}var propPath=localAspect.getPropertyPath(propName);var inProcess=entityAspect._inProcess;if(inProcess){if(inProcess.indexOf(property)>=0)return;inProcess.push(property)}else{inProcess=[property];entityAspect._inProcess=inProcess}var entity=entityAspect.entity;try{var entityManager=entityAspect.entityManager;if(entityAspect.entityState.isUnchangedOrModified()){if(localAspect.originalValues[propName]===undefined&&property.isDataProperty&&!property.isComplexProperty){localAspect.originalValues[propName]=oldValue!==undefined?oldValue:property.defaultValue}}if(property.isComplexProperty){if(property.isScalar){if(!newValue){throw new Error(__formatString("You cannot set the '%1' property to null because it's datatype is the ComplexType: '%2'",property.name,property.dataType.name))}if(!oldValue){var ctor=dataType.getCtor();oldValue=new ctor;rawAccessorFn(oldValue)}dataType.dataProperties.forEach(function(dp){var pn=dp.name;var nv=newValue.getProperty(pn);oldValue.setProperty(pn,nv)})}else{throw new Error(__formatString("You cannot set the non-scalar complex property: '%1' on the type: '%2'."+"Instead get the property and use array functions like 'push' or 'splice' to change its contents.",property.name,property.parentType.name))}}else if(property.isDataProperty){if(!property.isScalar){throw new Error("Nonscalar data properties are readonly - items may be added or removed but the collection may not be changed.")}if(property.isPartOfKey&&!this.complexAspect&&entityManager&&!entityManager.isLoading){var keyProps=this.entityType.keyProperties;var values=keyProps.map(function(p){if(p===property){return newValue}else{return this.getProperty(p.name)}},this);var newKey=new EntityKey(this.entityType,values);if(entityManager.findEntityByKey(newKey)){throw new Error("An entity with this key is already in the cache: "+newKey.toString())}var oldKey=this.entityAspect.getKey();var eg=entityManager._findEntityGroup(this.entityType);eg._replaceKey(oldKey,newKey)}var relatedNavProp=property.relatedNavigationProperty;if(relatedNavProp&&entityManager){if(newValue!=null){key=new EntityKey(relatedNavProp.entityType,[newValue]);relatedEntity=entityManager.findEntityByKey(key);if(relatedEntity){this.setProperty(relatedNavProp.name,relatedEntity)}else{entityManager._unattachedChildrenMap.addChild(key,relatedNavProp,this)}}else{this.setProperty(relatedNavProp.name,null)}}else if(property.inverseNavigationProperty&&entityManager&&!entityManager._inKeyFixup){var invNavProp=property.inverseNavigationProperty;if(oldValue!=null){key=new EntityKey(invNavProp.parentType,[oldValue]);relatedEntity=entityManager.findEntityByKey(key);if(relatedEntity){if(invNavProp.isScalar){relatedEntity.setProperty(invNavProp.name,null)}else{var relatedArray=relatedEntity.getProperty(invNavProp.name);
relatedArray.splice(relatedArray.indexOf(this),1)}}}if(newValue!=null){key=new EntityKey(invNavProp.parentType,[newValue]);relatedEntity=entityManager.findEntityByKey(key);if(relatedEntity){if(invNavProp.isScalar){relatedEntity.setProperty(invNavProp.name,this)}else{relatedEntity.getProperty(invNavProp.name).push(this)}}else{entityManager._unattachedChildrenMap.addChild(key,invNavProp,this)}}}rawAccessorFn(newValue);if(entityManager&&!entityManager.isLoading){if(entityAspect.entityState.isUnchanged()&&!property.isUnmapped){entityAspect.setModified()}if(entityManager.validationOptions.validateOnPropertyChange){entityAspect._validateProperty(newValue,{entity:entity,property:property,propertyName:propPath,oldValue:oldValue})}}if(property.isPartOfKey&&!this.complexAspect){var propertyIx=this.entityType.keyProperties.indexOf(property);this.entityType.navigationProperties.forEach(function(np){var inverseNp=np.inverse;var fkNames=inverseNp?inverseNp.foreignKeyNames:np.invForeignKeyNames;if(fkNames.length===0)return;var npValue=that.getProperty(np.name);var fkName=fkNames[propertyIx];if(np.isScalar){if(!npValue)return;npValue.setProperty(fkName,newValue)}else{npValue.forEach(function(iv){iv.setProperty(fkName,newValue)})}});entityAspect.getKey(true)}}else{if(!property.isScalar){throw new Error("Nonscalar navigation properties are readonly - entities can be added or removed but the collection may not be changed.")}var inverseProp=property.inverse;if(newValue!=null){var newAspect=newValue.entityAspect;if(entityManager){if(newAspect.entityState.isDetached()){if(!entityManager.isLoading){entityManager.attachEntity(newValue,EntityState.Added)}}else{if(newAspect.entityManager!==entityManager){throw new Error("An Entity cannot be attached to an entity in another EntityManager. One of the two entities must be detached first.")}}}else{if(newAspect&&newAspect.entityManager){entityManager=newAspect.entityManager;if(!entityManager.isLoading){entityManager.attachEntity(entityAspect.entity,EntityState.Added)}}}}if(inverseProp){if(inverseProp.isScalar){if(oldValue!=null){oldValue.setProperty(inverseProp.name,null)}if(newValue!=null){newValue.setProperty(inverseProp.name,this)}}else{if(oldValue!=null){var oldSiblings=oldValue.getProperty(inverseProp.name);var ix=oldSiblings.indexOf(this);if(ix!==-1){oldSiblings.splice(ix,1)}}if(newValue!=null){var siblings=newValue.getProperty(inverseProp.name);siblings.push(this)}}}else if(property.invForeignKeyNames&&entityManager&&!entityManager._inKeyFixup){var invForeignKeyNames=property.invForeignKeyNames;if(newValue!=null){var pkValues=this.entityAspect.getKey().values;invForeignKeyNames.forEach(function(fkName,i){newValue.setProperty(fkName,pkValues[i])})}else{if(oldValue!=null){invForeignKeyNames.forEach(function(fkName){var fkProp=oldValue.entityType.getProperty(fkName);if(!fkProp.isPartOfKey){oldValue.setProperty(fkName,null)}})}}}rawAccessorFn(newValue);if(entityManager&&!entityManager.isLoading){if(entityAspect.entityState.isUnchanged()&&!property.isUnmapped){entityAspect.setModified()}if(entityManager.validationOptions.validateOnPropertyChange){entityAspect._validateProperty(newValue,{entity:this,property:property,propertyName:propPath,oldValue:oldValue})}}if(property.relatedDataProperties){if(!entityAspect.entityState.isDeleted()){var inverseKeyProps=property.entityType.keyProperties;inverseKeyProps.forEach(function(keyProp,i){var relatedDataProp=property.relatedDataProperties[i];if(newValue||!relatedDataProp.isPartOfKey){var relatedValue=newValue?newValue.getProperty(keyProp.name):relatedDataProp.defaultValue;that.setProperty(relatedDataProp.name,relatedValue)}})}}}var propChangedArgs={entity:entity,parent:this,property:property,propertyName:propPath,oldValue:oldValue,newValue:newValue};if(entityManager){if(!entityManager.isLoading&&!entityManager.isRejectingChanges){entityAspect.propertyChanged.publish(propChangedArgs);entityManager.entityChanged.publish({entityAction:EntityAction.PropertyChange,entity:entity,args:propChangedArgs})}}else{entityAspect.propertyChanged.publish(propChangedArgs)}}finally{inProcess.pop()}}var DataService=function(){var ctor=function(config){updateWithConfig(this,config)};var proto=ctor.prototype;proto._$typeName="DataService";proto.using=function(config){if(!config)return this;var result=new DataService(this);return updateWithConfig(result,config)};ctor.resolve=function(dataServices){dataServices.push({hasServerMetadata:true,useJsonp:false});var ds=new DataService(__resolveProperties(dataServices,["serviceName","adapterName","hasServerMetadata","jsonResultsAdapter","useJsonp"]));if(!ds.serviceName){throw new Error("Unable to resolve a 'serviceName' for this dataService")}ds.adapterInstance=ds.adapterInstance||__config.getAdapterInstance("dataService",ds.adapterName);ds.jsonResultsAdapter=ds.jsonResultsAdapter||ds.adapterInstance.jsonResultsAdapter;return ds};function updateWithConfig(obj,config){if(config){assertConfig(config).whereParam("serviceName").isOptional().whereParam("adapterName").isString().isOptional().whereParam("hasServerMetadata").isBoolean().isOptional().whereParam("jsonResultsAdapter").isInstanceOf(JsonResultsAdapter).isOptional().whereParam("useJsonp").isBoolean().isOptional().applyAll(obj);obj.serviceName=obj.serviceName&&DataService._normalizeServiceName(obj.serviceName);obj.adapterInstance=obj.adapterName&&__config.getAdapterInstance("dataService",obj.adapterName)}return obj}ctor._normalizeServiceName=function(serviceName){serviceName=serviceName.trim();if(serviceName.substr(-1)!=="/"){return serviceName+"/"}else{return serviceName}};proto.toJSON=function(){return __toJson(this,{serviceName:null,adapterName:null,hasServerMetadata:null,jsonResultsAdapter:function(v){return v&&v.name},useJsonp:null})};ctor.fromJSON=function(json){json.jsonResultsAdapter=__config._fetchObject(JsonResultsAdapter,json.jsonResultsAdapter);return new DataService(json)};proto.makeUrl=function(suffix){var url=this.serviceName;if(core.stringEndsWith(url,"/")){url=url.substr(0,url.length-1)}suffix="/"+suffix;if(!core.stringEndsWith(url,suffix)){url=url+suffix}return url};return ctor}();var JsonResultsAdapter=function(){var ctor=function(config){if(arguments.length!==1){throw new Error("The JsonResultsAdapter ctor should be called with a single argument that is a configuration object.")}assertConfig(config).whereParam("name").isNonEmptyString().whereParam("extractResults").isFunction().isOptional().withDefault(extractResultsDefault).whereParam("visitNode").isFunction().applyAll(this);__config._storeObject(this,proto._$typeName,this.name)};var proto=ctor.prototype;proto._$typeName="JsonResultsAdapter";function extractResultsDefault(data){return data.results}return ctor}();breeze.DataService=DataService;breeze.JsonResultsAdapter=JsonResultsAdapter;var DataType=function(){var dataTypeMethods={};var constants={stringPrefix:"K_",nextNumber:-1,nextNumberIncrement:-1};var getNextString=function(){return constants.stringPrefix+getNextNumber().toString()};var getNextNumber=function(){var result=constants.nextNumber;constants.nextNumber+=constants.nextNumberIncrement;return result};var getNextGuid=function(){return __getUuid()};var getNextDateTime=function(){return new Date};var coerceToString=function(source,sourceTypeName){return source==null?source:source.toString()};var coerceToInt=function(source,sourceTypeName){if(sourceTypeName==="string"){var src=source.trim();if(src==="")return null;var val=parseInt(src,10);return isNaN(val)?source:val}else if(sourceTypeName==="number"){return Math.round(source)}return source};var coerceToFloat=function(source,sourceTypeName){if(sourceTypeName==="string"){var src=source.trim();if(src==="")return null;var val=parseFloat(src);return isNaN(val)?source:val}return source};var coerceToDate=function(source,sourceTypeName){var val;if(sourceTypeName==="string"){var src=source.trim();if(src==="")return null;val=new Date(Date.parse(src));return __isDate(val)?val:source}else if(sourceTypeName==="number"){val=new Date(source);return __isDate(val)?val:source}return source};var coerceToBool=function(source,sourceTypeName){if(sourceTypeName==="string"){var src=source.trim().toLowerCase();if(src==="false"||src===""){return false}else if(src==="true"){return true}else{return source}}return source};var fmtString=function(val){return val==null?null:"'"+val+"'"};var fmtInt=function(val){return val==null?null:typeof val==="string"?parseInt(val,10):val};var makeFloatFmt=function(fmtSuffix){return function(val){if(val==null)return null;if(typeof val==="string"){val=parseFloat(val)}return val+fmtSuffix}};var fmtDateTime=function(val){if(val==null)return null;try{return"datetime'"+val.toISOString()+"'"}catch(e){throwError("'%1' is not a valid dateTime",val)}};var fmtDateTimeOffset=function(val){if(val==null)return null;try{return"datetimeoffset'"+val.toISOString()+"'"}catch(e){throwError("'%1' is not a valid dateTime",val)}};var fmtTime=function(val){if(val==null)return null;if(!__isDuration(val)){throwError("'%1' is not a valid ISO 8601 duration",val)}return"time'"+val+"'"};var fmtGuid=function(val){if(val==null)return null;if(!__isGuid(val)){throwError("'%1' is not a valid guid",val)}return"guid'"+val+"'"};var fmtBoolean=function(val){if(val==null)return null;if(typeof val==="string"){return val.trim().toLowerCase()==="true"}else{return!!val}};var fmtBinary=function(val){if(val==null)return val;return"binary'"+val+"'"};var fmtUndefined=function(val){return val};function throwError(msg,val){msg=__formatString(msg,val);throw new Error(msg)}var DataType=new Enum("DataType",dataTypeMethods);DataType.String=DataType.addSymbol({defaultValue:"",parse:coerceToString,fmtOData:fmtString,getNext:getNextString});DataType.Int64=DataType.addSymbol({defaultValue:0,isNumeric:true,isInteger:true,quoteJsonOData:true,parse:coerceToInt,fmtOData:fmtInt,getNext:getNextNumber});DataType.Int32=DataType.addSymbol({defaultValue:0,isNumeric:true,isInteger:true,parse:coerceToInt,fmtOData:fmtInt,getNext:getNextNumber});DataType.Int16=DataType.addSymbol({defaultValue:0,isNumeric:true,isInteger:true,parse:coerceToInt,fmtOData:fmtInt,getNext:getNextNumber});DataType.Byte=DataType.addSymbol({defaultValue:0,isNumeric:true,isInteger:true,parse:coerceToInt,fmtOData:fmtInt});DataType.Decimal=DataType.addSymbol({defaultValue:0,isNumeric:true,quoteJsonOData:true,parse:coerceToFloat,fmtOData:makeFloatFmt("m"),getNext:getNextNumber});DataType.Double=DataType.addSymbol({defaultValue:0,isNumeric:true,parse:coerceToFloat,fmtOData:makeFloatFmt("d"),getNext:getNextNumber});DataType.Single=DataType.addSymbol({defaultValue:0,isNumeric:true,parse:coerceToFloat,fmtOData:makeFloatFmt("f"),getNext:getNextNumber});DataType.DateTime=DataType.addSymbol({defaultValue:new Date(1900,0,1),isDate:true,parse:coerceToDate,fmtOData:fmtDateTime,getNext:getNextDateTime});DataType.DateTimeOffset=DataType.addSymbol({defaultValue:new Date(1900,0,1),isDate:true,parse:coerceToDate,fmtOData:fmtDateTimeOffset,getNext:getNextDateTime});DataType.Time=DataType.addSymbol({defaultValue:"PT0S",fmtOData:fmtTime});DataType.Boolean=DataType.addSymbol({defaultValue:false,parse:coerceToBool,fmtOData:fmtBoolean});DataType.Guid=DataType.addSymbol({defaultValue:"00000000-0000-0000-0000-000000000000",fmtOData:fmtGuid,getNext:getNextGuid});DataType.Binary=DataType.addSymbol({defaultValue:null,fmtOData:fmtBinary});DataType.Undefined=DataType.addSymbol({defaultValue:undefined,fmtOData:fmtUndefined});DataType.seal();DataType.fromEdmDataType=function(typeName){var dt=null;var parts=typeName.split(".");if(parts.length>1){var simpleName=parts[1];if(simpleName==="image"){dt=DataType.Byte}else if(parts.length===2){dt=DataType.fromName(simpleName)||DataType.Undefined}else{dt=DataType.String}}return dt};DataType.fromValue=function(val){if(__isDate(val))return DataType.DateTime;switch(typeof val){case"string":if(__isGuid(val))return DataType.Guid;else if(__isDuration(val)&&val.length>3)return DataType.Time;return DataType.String;case"boolean":return DataType.Boolean;case"number":return DataType.Int32}return DataType.Undefined};var _localTimeRegex=/.\d{3}$/;DataType.parseDateAsUTC=function(source){if(typeof source==="string"){var isLocalTime=_localTimeRegex.test(source);source=isLocalTime?source+"Z":source}source=new Date(Date.parse(source));return source};DataType.parseDateFromServer=DataType.parseDateAsUTC;DataType.constants=constants;DataType.getSymbols().forEach(function(sym){sym.validatorCtor=getValidatorCtor(sym)});function getValidatorCtor(symbol){switch(symbol){case DataType.String:return Validator.string;case DataType.Int64:return Validator.int64;case DataType.Int32:return Validator.int32;case DataType.Int16:return Validator.int16;case DataType.Decimal:return Validator.number;case DataType.Double:return Validator.number;case DataType.Single:return Validator.number;case DataType.DateTime:return Validator.date;case DataType.DateTimeOffset:return Validator.date;case DataType.Boolean:return Validator.bool;case DataType.Guid:return Validator.guid;case DataType.Byte:return Validator.byte;case DataType.Binary:return Validator.none;case DataType.Time:return Validator.duration;case DataType.Undefined:return Validator.none}}return DataType}();breeze.DataType=DataType;var Q=__requireLib("Q","See https://github.com/kriskowal/q ");var MetadataStore=function(){var __id=0;var ctor=function(config){config=config||{};assertConfig(config).whereParam("namingConvention").isOptional().isInstanceOf(NamingConvention).withDefault(NamingConvention.defaultInstance).whereParam("localQueryComparisonOptions").isOptional().isInstanceOf(LocalQueryComparisonOptions).withDefault(LocalQueryComparisonOptions.defaultInstance).applyAll(this);this.dataServices=[];this._resourceEntityTypeMap={};this._structuralTypeMap={};this._shortNameMap={};this._ctorRegistry={};this._incompleteTypeMap={};this._incompleteComplexTypeMap={};this._id=__id++};var proto=ctor.prototype;proto._$typeName="MetadataStore";ctor.ANONTYPE_PREFIX="_IB_";proto.addDataService=function(dataService,shouldOverwrite){assertParam(dataService,"dataService").isInstanceOf(DataService).check();assertParam(shouldOverwrite,"shouldOverwrite").isBoolean().isOptional().check();var ix=this._getDataServiceIndex(dataService.serviceName);if(ix>=0){if(!!shouldOverwrite){this.dataServices[ix]=dataService}else{throw new Error("A dataService with this name '"+dataService.serviceName+"' already exists in this MetadataStore")}}else{this.dataServices.push(dataService)}};proto._getDataServiceIndex=function(serviceName){return __arrayIndexOf(this.dataServices,function(ds){return ds.serviceName===serviceName})};proto.addEntityType=function(structuralType){if(!(structuralType instanceof EntityType||structuralType instanceof ComplexType)){structuralType=structuralType.isComplexType?new ComplexType(structuralType):new EntityType(structuralType)}if(!structuralType.isComplexType){if(structuralType.keyProperties.length===0&&!structuralType.isAbstract){throw new Error("Unable to add "+structuralType.name+" to this MetadataStore.  An EntityType must have at least one property designated as a key property - See the 'DataProperty.isPartOfKey' property.")}}structuralType.metadataStore=this;if(!structuralType.isAnonymous){this._structuralTypeMap[structuralType.name]=structuralType;this._shortNameMap[structuralType.shortName]=structuralType.name}structuralType.getProperties().forEach(function(property){structuralType._updateNames(property);if(!property.isUnmapped){structuralType._mappedPropertiesCount++}});structuralType._updateCps();if(!structuralType.isComplexType){structuralType._updateNps();var defResourceName=structuralType.defaultResourceName||structuralType.baseEntityType&&structuralType.baseEntityType.defaultResourceName;if(defResourceName&&!this.getEntityTypeNameForResourceName(defResourceName)){this.setEntityTypeForResourceName(defResourceName,structuralType.name)}structuralType.defaultResourceName=defResourceName;structuralType.getEntityCtor()}if(structuralType.baseEntityType){structuralType.baseEntityType.subtypes.push(structuralType)}};proto.exportMetadata=function(){var result=JSON.stringify({metadataVersion:breeze.metadataVersion,namingConvention:this.namingConvention.name,localQueryComparisonOptions:this.localQueryComparisonOptions.name,dataServices:this.dataServices,structuralTypes:__objectMapToArray(this._structuralTypeMap),resourceEntityTypeMap:this._resourceEntityTypeMap},null,__config.stringifyPad);return result};proto.importMetadata=function(exportedMetadata){this._deferredTypes={};var json=typeof exportedMetadata==="string"?JSON.parse(exportedMetadata):exportedMetadata;if(json.schema){return CsdlMetadataParser.parse(this,json.schema)}if(json.metadataVersion&&json.metadataVersion!==breeze.metadataVersion){var msg=__formatString("Cannot import metadata with a different 'metadataVersion' (%1) than the current 'breeze.metadataVersion' (%2) ",json.metadataVersion,breeze.metadataVersion);throw new Error(msg)}var ncName=json.namingConvention;var lqcoName=json.localQueryComparisonOptions;if(this.isEmpty()){this.namingConvention=__config._fetchObject(NamingConvention,ncName)||this.namingConvention;this.localQueryComparisonOptions=__config._fetchObject(LocalQueryComparisonOptions,lqcoName)||this.localQueryComparisonOptions}else{if(ncName&&this.namingConvention.name!==ncName){throw new Error("Cannot import metadata with a different 'namingConvention' from the current MetadataStore")}if(lqcoName&&this.localQueryComparisonOptions.name!==lqcoName){throw new Error("Cannot import metadata with different 'localQueryComparisonOptions' from the current MetadataStore")}}var that=this;json.dataServices&&json.dataServices.forEach(function(ds){ds=DataService.fromJSON(ds);that.addDataService(ds,true)});var structuralTypeMap=this._structuralTypeMap;json.structuralTypes.forEach(function(stype){structuralTypeFromJson(that,stype)});__extend(this._resourceEntityTypeMap,json.resourceEntityTypeMap);__extend(this._incompleteTypeMap,json.incompleteTypeMap);return this};ctor.importMetadata=function(exportedString){var ms=new MetadataStore;ms.importMetadata(exportedString);return ms};proto.hasMetadataFor=function(serviceName){return!!this.getDataService(serviceName)};proto.getDataService=function(serviceName){assertParam(serviceName,"serviceName").isString().check();serviceName=DataService._normalizeServiceName(serviceName);return __arrayFirst(this.dataServices,function(ds){return ds.serviceName===serviceName})};proto.fetchMetadata=function(dataService,callback,errorCallback){assertParam(dataService,"dataService").isString().or().isInstanceOf(DataService).check();assertParam(callback,"callback").isFunction().isOptional().check();assertParam(errorCallback,"errorCallback").isFunction().isOptional().check();if(typeof dataService==="string"){dataService=this.getDataService(dataService)||new DataService({serviceName:dataService})}dataService=DataService.resolve([dataService]);if(this.hasMetadataFor(dataService.serviceName)){throw new Error("Metadata for a specific serviceName may only be fetched once per MetadataStore. ServiceName: "+dataService.serviceName)}return dataService.adapterInstance.fetchMetadata(this,dataService).then(function(rawMetadata){if(callback)callback(rawMetadata);return Q.resolve(rawMetadata)}).fail(function(error){if(errorCallback)errorCallback(error);return Q.reject(error)})};proto.trackUnmappedType=function(entityCtor,interceptor){assertParam(entityCtor,"entityCtor").isFunction().check();assertParam(interceptor,"interceptor").isFunction().isOptional().check();var entityType=new EntityType(this);entityType._setCtor(entityCtor,interceptor)};proto.registerEntityTypeCtor=function(structuralTypeName,aCtor,initializationFn){assertParam(structuralTypeName,"structuralTypeName").isString().check();assertParam(aCtor,"aCtor").isFunction().isOptional().check();assertParam(initializationFn,"initializationFn").isOptional().isFunction().or().isString().check();var qualifiedTypeName=getQualifiedTypeName(this,structuralTypeName,false);var typeName=qualifiedTypeName||structuralTypeName;this._ctorRegistry[typeName]={ctor:aCtor,initFn:initializationFn};if(qualifiedTypeName){var stype=this._structuralTypeMap[qualifiedTypeName];stype&&stype.getCtor(true)}};proto.toQueryString=function(query){if(!query){throw new Error("query cannot be empty")}if(typeof query==="string"){return query}else if(query instanceof EntityQuery){return query._toUri(this)}else{throw new Error("unable to recognize query parameter as either a string or an EntityQuery")}};proto.isEmpty=function(){return __isEmpty(this._structuralTypeMap)};proto.getEntityType=function(structuralTypeName,okIfNotFound){assertParam(structuralTypeName,"structuralTypeName").isString().check();assertParam(okIfNotFound,"okIfNotFound").isBoolean().isOptional().check(false);return this._getEntityType(structuralTypeName,okIfNotFound)};proto._getEntityType=function(typeName,okIfNotFound){var qualTypeName=getQualifiedTypeName(this,typeName,false);var type=this._structuralTypeMap[qualTypeName];if(!type){if(okIfNotFound)return null;var msg=__formatString("Unable to locate a 'Type' by the name: '%1'. Be sure to execute a query or call fetchMetadata first.",typeName);throw new Error(msg)}if(type.length){var typeNames=type.join(",");throw new Error("There are multiple types with this 'shortName': "+typeNames)}return type};proto.getEntityTypes=function(){return getTypesFromMap(this._structuralTypeMap)};proto.getIncompleteNavigationProperties=function(){return __objectMapToArray(this._incompleteTypeMap,function(key,value){return value})};proto.getEntityTypeNameForResourceName=function(resourceName){assertParam(resourceName,"resourceName").isString().check();return this._resourceEntityTypeMap[resourceName]};proto.setEntityTypeForResourceName=function(resourceName,entityTypeOrName){assertParam(resourceName,"resourceName").isString().check();assertParam(entityTypeOrName,"entityTypeOrName").isInstanceOf(EntityType).or().isString().check();var entityTypeName;if(entityTypeOrName instanceof EntityType){entityTypeName=entityTypeOrName.name}else{entityTypeName=getQualifiedTypeName(this,entityTypeOrName,true)}this._resourceEntityTypeMap[resourceName]=entityTypeName;var entityType=this._getEntityType(entityTypeName,true);if(entityType&&!entityType.defaultResourceName){entityType.defaultResourceName=resourceName}};proto._checkEntityType=function(entity){if(entity.entityType)return;var typeName=entity.prototype._$typeName;if(!typeName){throw new Error("This entity has not been registered. See the MetadataStore.registerEntityTypeCtor method")}var entityType=this._getEntityType(typeName);if(entityType){entity.entityType=entityType}};function getTypesFromMap(typeMap){var types=[];for(var key in typeMap){var value=typeMap[key];if(key===value.name){types.push(typeMap[key])}}return types}function structuralTypeFromJson(metadataStore,json){var typeName=qualifyTypeName(json.shortName,json.namespace);var stype=metadataStore._getEntityType(typeName,true);if(stype)return stype;var config={shortName:json.shortName,namespace:json.namespace,isAbstract:json.isAbstract,autoGeneratedKeyType:AutoGeneratedKeyType.fromName(json.autoGeneratedKeyType),defaultResourceName:json.defaultResourceName};stype=json.isComplexType?new ComplexType(config):new EntityType(config);if(json.baseTypeName){stype.baseTypeName=json.baseTypeName;var baseEntityType=metadataStore._getEntityType(json.baseTypeName,true);if(baseEntityType){completeStructuralTypeFromJson(metadataStore,json,stype,baseEntityType)}else{__getArray(metadataStore._deferredTypes,json.baseTypeName).push({json:json,stype:stype})}}else{completeStructuralTypeFromJson(metadataStore,json,stype,null)}return stype}function completeStructuralTypeFromJson(metadataStore,json,stype,baseEntityType){if(json.validators){stype.validators=json.validators.map(Validator.fromJSON)}if(baseEntityType){stype.baseEntityType=baseEntityType;baseEntityType.dataProperties.forEach(function(dp){var newDp=new DataProperty(dp);newDp.isInherited=true;stype.addProperty(newDp)});baseEntityType.navigationProperties.forEach(function(np){var newNp=new NavigationProperty(np);newNp.isInherited=true;stype.addProperty(newNp)})}json.dataProperties.forEach(function(dp){stype.addProperty(DataProperty.fromJSON(dp))});var isEntityType=!json.isComplexType;if(isEntityType){json.navigationProperties&&json.navigationProperties.forEach(function(np){stype.addProperty(NavigationProperty.fromJSON(np))})}metadataStore.addEntityType(stype);var deferredTypes=metadataStore._deferredTypes;var deferrals=deferredTypes[stype.name];if(deferrals){deferrals.forEach(function(d){completeStructuralTypeFromJson(metadataStore,d.json,d.stype,stype)});delete deferredTypes[stype.name]}}function getQualifiedTypeName(metadataStore,structTypeName,throwIfNotFound){if(isQualifiedTypeName(structTypeName))return structTypeName;var result=metadataStore._shortNameMap[structTypeName];if(!result&&throwIfNotFound){throw new Error("Unable to locate 'entityTypeName' of: "+structTypeName)}return result}return ctor}();var CsdlMetadataParser=function(){function parse(metadataStore,schemas){metadataStore._entityTypeResourceMap={};__toArray(schemas).forEach(function(schema){if(schema.cSpaceOSpaceMapping){var mappings=JSON.parse(schema.cSpaceOSpaceMapping);var newMap={};mappings.forEach(function(mapping){newMap[mapping[0]]=mapping[1]});schema.cSpaceOSpaceMapping=newMap}if(schema.entityContainer){__toArray(schema.entityContainer).forEach(function(container){__toArray(container.entitySet).forEach(function(entitySet){var entityTypeName=parseTypeName(entitySet.entityType,schema).typeName;metadataStore.setEntityTypeForResourceName(entitySet.name,entityTypeName);metadataStore._entityTypeResourceMap[entityTypeName]=entitySet.name})})}if(schema.complexType){__toArray(schema.complexType).forEach(function(ct){var complexType=parseCsdlComplexType(ct,schema,metadataStore)})}if(schema.entityType){__toArray(schema.entityType).forEach(function(et){var entityType=parseCsdlEntityType(et,schema,metadataStore)})}});var badNavProps=metadataStore.getIncompleteNavigationProperties();if(badNavProps.length>0){throw new Error("Bad nav properties")}return metadataStore}function parseCsdlEntityType(csdlEntityType,schema,metadataStore){var shortName=csdlEntityType.name;var ns=getNamespaceFor(shortName,schema);var entityType=new EntityType({shortName:shortName,namespace:ns,isAbstract:csdlEntityType.abstract&&csdlEntityType.abstract==="true"});if(csdlEntityType.baseType){var baseTypeName=parseTypeName(csdlEntityType.baseType,schema).typeName;entityType.baseTypeName=baseTypeName;var baseEntityType=metadataStore._getEntityType(baseTypeName,true);if(baseEntityType){completeParseCsdlEntityType(entityType,csdlEntityType,schema,metadataStore,baseEntityType)}else{var deferrals=metadataStore._deferredTypes[baseTypeName];if(!deferrals){deferrals=[];metadataStore._deferredTypes[baseTypeName]=deferrals}deferrals.push({entityType:entityType,csdlEntityType:csdlEntityType})}}else{completeParseCsdlEntityType(entityType,csdlEntityType,schema,metadataStore,null)}return entityType}function completeParseCsdlEntityType(entityType,csdlEntityType,schema,metadataStore,baseEntityType){var baseKeyNamesOnServer=[];if(baseEntityType){entityType.baseEntityType=baseEntityType;entityType.autoGeneratedKeyType=baseEntityType.autoGeneratedKeyType;baseKeyNamesOnServer=baseEntityType.keyProperties.map(__pluck("name"));baseEntityType.dataProperties.forEach(function(dp){var newDp=new DataProperty(dp);newDp.isInherited=true;entityType.addProperty(newDp)});baseEntityType.navigationProperties.forEach(function(np){var newNp=new NavigationProperty(np);newNp.isInherited=true;entityType.addProperty(newNp)})}var keyNamesOnServer=csdlEntityType.key?__toArray(csdlEntityType.key.propertyRef).map(__pluck("name")):[];keyNamesOnServer=baseKeyNamesOnServer.concat(keyNamesOnServer);__toArray(csdlEntityType.property).forEach(function(prop){parseCsdlDataProperty(entityType,prop,schema,keyNamesOnServer)});__toArray(csdlEntityType.navigationProperty).forEach(function(prop){parseCsdlNavProperty(entityType,prop,schema)});metadataStore.addEntityType(entityType);entityType.defaultResourceName=metadataStore._entityTypeResourceMap[entityType.name];var deferredTypes=metadataStore._deferredTypes;var deferrals=deferredTypes[entityType.name];if(deferrals){deferrals.forEach(function(d){completeParseCsdlEntityType(d.entityType,d.csdlEntityType,schema,metadataStore,entityType)});delete deferredTypes[entityType.name]}}function parseCsdlComplexType(csdlComplexType,schema,metadataStore){var shortName=csdlComplexType.name;var ns=getNamespaceFor(shortName,schema);var complexType=new ComplexType({shortName:shortName,namespace:ns});__toArray(csdlComplexType.property).forEach(function(prop){parseCsdlDataProperty(complexType,prop,schema)});metadataStore.addEntityType(complexType);return complexType}function parseCsdlDataProperty(parentType,csdlProperty,schema,keyNamesOnServer){var dp;var typeParts=csdlProperty.type.split(".");if(typeParts.length===2){dp=parseCsdlSimpleProperty(parentType,csdlProperty,keyNamesOnServer)}else{if(isEnumType(csdlProperty,schema)){dp=parseCsdlSimpleProperty(parentType,csdlProperty,keyNamesOnServer);if(dp){dp.enumType=csdlProperty.type}}else{dp=parseCsdlComplexProperty(parentType,csdlProperty,schema)}}if(dp){parentType.addProperty(dp);addValidators(dp)}return dp}function parseCsdlSimpleProperty(parentType,csdlProperty,keyNamesOnServer){var dataType=DataType.fromEdmDataType(csdlProperty.type);if(dataType==null){parentType.warnings.push("Unable to recognize DataType for property: "+csdlProperty.name+" DateType: "+csdlProperty.type);return null}var isNullable=csdlProperty.nullable==="true"||csdlProperty.nullable==null;var isPartOfKey=keyNamesOnServer!=null&&keyNamesOnServer.indexOf(csdlProperty.name)>=0;if(isPartOfKey&&parentType.autoGeneratedKeyType===AutoGeneratedKeyType.None){if(isIdentityProperty(csdlProperty)){parentType.autoGeneratedKeyType=AutoGeneratedKeyType.Identity}}var maxLength=csdlProperty.maxLength;maxLength=maxLength==null||maxLength==="Max"?null:parseInt(maxLength,10);var dp=new DataProperty({nameOnServer:csdlProperty.name,dataType:dataType,isNullable:isNullable,isPartOfKey:isPartOfKey,maxLength:maxLength,concurrencyMode:csdlProperty.concurrencyMode});if(dataType===DataType.Undefined){dp.rawTypeName=csdlProperty.type}return dp}function parseCsdlComplexProperty(parentType,csdlProperty,schema){var complexTypeName=parseTypeName(csdlProperty.type,schema).typeName;var dp=new DataProperty({nameOnServer:csdlProperty.name,complexTypeName:complexTypeName,isNullable:false});return dp}function parseCsdlNavProperty(entityType,csdlProperty,schema){var association=getAssociation(csdlProperty,schema);var toEnd=__arrayFirst(association.end,function(assocEnd){return assocEnd.role===csdlProperty.toRole});var isScalar=toEnd.multiplicity!=="*";var dataType=parseTypeName(toEnd.type,schema).typeName;var constraint=association.referentialConstraint;if(!constraint){return}var cfg={nameOnServer:csdlProperty.name,entityTypeName:dataType,isScalar:isScalar,associationName:association.name};var principal=constraint.principal;var dependent=constraint.dependent;var propRefs;if(csdlProperty.fromRole===principal.role){propRefs=__toArray(principal.propertyRef);cfg.invForeignKeyNamesOnServer=propRefs.map(__pluck("name"))}else{propRefs=__toArray(dependent.propertyRef);cfg.foreignKeyNamesOnServer=propRefs.map(__pluck("name"))}var np=new NavigationProperty(cfg);entityType.addProperty(np);return np}function isEnumType(csdlProperty,schema){if(!schema.enumType)return false;var enumTypes=__toArray(schema.enumType);var typeParts=csdlProperty.type.split(".");var baseTypeName=typeParts[typeParts.length-1];return enumTypes.some(function(enumType){return enumType.name===baseTypeName})}function addValidators(dataProperty){var typeValidator;if(!dataProperty.isNullable){dataProperty.validators.push(Validator.required())
}if(dataProperty.isComplexProperty)return;if(dataProperty.dataType===DataType.String){if(dataProperty.maxLength){var validatorArgs={maxLength:dataProperty.maxLength};typeValidator=Validator.maxLength(validatorArgs)}else{typeValidator=Validator.string()}}else{typeValidator=dataProperty.dataType.validatorCtor()}dataProperty.validators.push(typeValidator)}function isIdentityProperty(csdlProperty){var propName=__arrayFirst(Object.keys(csdlProperty),function(pn){return pn.indexOf("StoreGeneratedPattern")>=0});if(propName){return csdlProperty[propName]==="Identity"}else{var extensions=csdlProperty.extensions;if(!extensions){return false}var identityExtn=__arrayFirst(extensions,function(extension){return extension.name==="StoreGeneratedPattern"&&extension.value==="Identity"});return!!identityExtn}}function getAssociation(csdlNavProperty,schema){var assocName=parseTypeName(csdlNavProperty.relationship,schema).shortTypeName;var assocs=schema.association;if(!assocs)return null;if(!Array.isArray(assocs)){assocs=[assocs]}var association=__arrayFirst(assocs,function(assoc){return assoc.name===assocName});return association}function parseTypeName(entityTypeName,schema){if(!entityTypeName){return null}if(__stringStartsWith(entityTypeName,MetadataStore.ANONTYPE_PREFIX)){return{shortTypeName:entityTypeName,namespace:"",typeName:entityTypeName,isAnonymous:true}}var entityTypeNameNoAssembly=entityTypeName.split(",")[0];var nameParts=entityTypeNameNoAssembly.split(".");if(nameParts.length>1){var shortName=nameParts[nameParts.length-1];var ns;if(schema){ns=getNamespaceFor(shortName,schema)}else{var namespaceParts=nameParts.slice(0,nameParts.length-1);ns=namespaceParts.join(".")}return{shortTypeName:shortName,namespace:ns,typeName:qualifyTypeName(shortName,ns)}}else{return{shortTypeName:entityTypeName,namespace:"",typeName:entityTypeName}}}function getNamespaceFor(shortName,schema){var ns;var mapping=schema.cSpaceOSpaceMapping;if(mapping){var fullName=mapping[schema.namespace+"."+shortName];ns=fullName&&fullName.substr(0,fullName.length-(shortName.length+1))}return ns||schema.namespace}var normalizeTypeName=__memoize(function(rawTypeName){return rawTypeName&&parseTypeName(rawTypeName).typeName});return{parse:parse,normalizeTypeName:normalizeTypeName}}();var EntityType=function(){var __nextAnonIx=0;var ctor=function(config){if(arguments.length>1){throw new Error("The EntityType ctor has a single argument that is either a 'MetadataStore' or a configuration object.")}if(config._$typeName==="MetadataStore"){this.metadataStore=config;this.shortName="Anon_"+ ++__nextAnonIx;this.namespace="";this.isAnonymous=true}else{assertConfig(config).whereParam("shortName").isNonEmptyString().whereParam("namespace").isString().isOptional().withDefault("").whereParam("baseTypeName").isString().isOptional().whereParam("isAbstract").isBoolean().isOptional().withDefault(false).whereParam("autoGeneratedKeyType").isEnumOf(AutoGeneratedKeyType).isOptional().withDefault(AutoGeneratedKeyType.None).whereParam("defaultResourceName").isNonEmptyString().isOptional().withDefault(null).whereParam("dataProperties").isOptional().whereParam("navigationProperties").isOptional().applyAll(this)}this.name=qualifyTypeName(this.shortName,this.namespace);this.dataProperties=[];this.navigationProperties=[];this.complexProperties=[];this.keyProperties=[];this.foreignKeyProperties=[];this.concurrencyProperties=[];this.unmappedProperties=[];this.validators=[];this.warnings=[];this._mappedPropertiesCount=0;this.subtypes=[];addProperties(this,config.dataProperties,DataProperty);addProperties(this,config.navigationProperties,NavigationProperty)};var proto=ctor.prototype;proto._$typeName="EntityType";proto.setProperties=function(config){assertConfig(config).whereParam("autoGeneratedKeyType").isEnumOf(AutoGeneratedKeyType).isOptional().whereParam("defaultResourceName").isString().isOptional().applyAll(this);if(config.defaultResourceName){this.defaultResourceName=config.defaultResourceName}};proto.isSubtypeOf=function(entityType){assertParam(entityType,"entityType").isInstanceOf(EntityType).check();var baseType=this;do{if(baseType===entityType)return true;baseType=baseType.baseEntityType}while(baseType);return false};proto.getSelfAndSubtypes=function(){var result=[this];this.subtypes.forEach(function(st){var subtypes=st.getSelfAndSubtypes();result.push.apply(result,subtypes)});return result};proto.addProperty=function(property){assertParam(property,"dataProperty").isInstanceOf(DataProperty).or().isInstanceOf(NavigationProperty).check();if(this.metadataStore&&!property.isUnmapped){throw new Error("The '"+this.name+"' EntityType has already been added to a MetadataStore and therefore no additional properties may be added to it.")}if(property.parentType){if(property.parentType!==this){throw new Error("This dataProperty has already been added to "+property.parentType.name)}else{return this}}property.parentType=this;if(property.isDataProperty){this._addDataProperty(property)}else{this._addNavigationProperty(property)}return this};proto.createEntity=function(initialValues){var instance=this._createInstanceCore();if(initialValues){__objectForEach(initialValues,function(key,value){instance.setProperty(key,value)})}this._initializeInstance(instance);return instance};proto._createInstanceCore=function(){var aCtor=this.getEntityCtor();var instance=new aCtor;new EntityAspect(instance);return instance};proto._initializeInstance=function(instance){if(this.baseEntityType){this.baseEntityType._initializeInstance(instance)}var initFn=this.initializationFn;if(initFn){if(typeof initFn==="string"){initFn=instance[initFn]}initFn(instance)}if(instance.entityAspect){instance.entityAspect._initialized=true}};proto.getCtor=proto.getEntityCtor=function(forceRefresh){if(this._ctor&&!forceRefresh)return this._ctor;var ctorRegistry=this.metadataStore._ctorRegistry;var r=ctorRegistry[this.name]||ctorRegistry[this.shortName]||{};var aCtor=r.ctor||this._ctor;if(!aCtor){var createCtor=__modelLibraryDef.getDefaultInstance().createCtor;aCtor=createCtor?createCtor(this):createEmptyCtor()}this.initializationFn=r.initFn;aCtor.prototype._$typeName=this.name;this._setCtor(aCtor);return aCtor};function createEmptyCtor(){return function(){}}proto._setCtor=function(aCtor,interceptor){var proto=aCtor.prototype;extra=proto._$extra||{};proto._$extra=extra;if(!extra.initialized){var instance=new aCtor;calcUnmappedProperties(this,instance)}if(this._$typeName==="EntityType"){proto.entityType=this}else{proto.complexType=this}proto._$interceptor=interceptor||defaultPropertyInterceptor;__modelLibraryDef.getDefaultInstance().initializeEntityPrototype(proto);extra.initialized=true;this._ctor=aCtor};proto.addValidator=function(validator,property){assertParam(validator,"validator").isInstanceOf(Validator).check();assertParam(property,"property").isOptional().isString().or().isEntityProperty().check();if(property){if(typeof property==="string"){property=this.getProperty(property,true)}property.validators.push(validator)}else{this.validators.push(validator)}};proto.getProperties=function(){return this.dataProperties.concat(this.navigationProperties)};proto.getPropertyNames=function(){return this.getProperties().map(__pluck("name"))};proto.getDataProperty=function(propertyName,isServerName){var propName=isServerName?"nameOnServer":"name";return __arrayFirst(this.dataProperties,__propEq(propName,propertyName))};proto.getNavigationProperty=function(propertyName,isServerName){var propName=isServerName?"nameOnServer":"name";return __arrayFirst(this.navigationProperties,__propEq(propName,propertyName))};proto.getProperty=function(propertyPath,throwIfNotFound){throwIfNotFound=throwIfNotFound||false;var propertyNames=Array.isArray(propertyPath)?propertyPath:propertyPath.trim().split(".");var propertyName=propertyNames[0];var prop=__arrayFirst(this.getProperties(),__propEq("name",propertyName));if(propertyNames.length===1){if(prop){return prop}else if(throwIfNotFound){throw new Error("unable to locate property: "+propertyName+" on entityType: "+this.name)}else{return null}}else{if(prop){propertyNames.shift();var nextParentType=prop.isNavigationProperty?prop.entityType:prop.dataType;if(nextParentType){return nextParentType.getProperty(propertyNames,throwIfNotFound)}else{throw new Error("should not get here - unknown property type for: "+prop.name)}}else{if(throwIfNotFound){throw new Error("unable to locate property: "+propertyName+" on type: "+this.name)}else{return null}}}};proto.toString=function(){return this.name};proto.toJSON=function(){return __toJson(this,{shortName:null,namespace:null,baseTypeName:null,isAbstract:false,autoGeneratedKeyType:null,defaultResourceName:null,dataProperties:localPropsOnly,navigationProperties:localPropsOnly,validators:null})};function localPropsOnly(props){return props.filter(function(prop){return!prop.isInherited})}proto._clientPropertyPathToServer=function(propertyPath){var fn=this.metadataStore.namingConvention.clientPropertyNameToServer;var that=this;var serverPropPath=propertyPath.split(".").map(function(propName){var prop=that.getProperty(propName);return fn(propName,prop)}).join("/");return serverPropPath};proto._updateNames=function(property){var nc=this.metadataStore.namingConvention;updateClientServerNames(nc,property,"name");if(property.isNavigationProperty){updateClientServerNames(nc,property,"foreignKeyNames");updateClientServerNames(nc,property,"invForeignKeyNames")}};function updateClientServerNames(nc,parent,clientPropName){var serverPropName=clientPropName+"OnServer";var clientName=parent[clientPropName];if(clientName&&clientName.length){if(parent.isUnmapped)return;var serverNames=__toArray(clientName).map(function(cName){var sName=nc.clientPropertyNameToServer(cName,parent);var testName=nc.serverPropertyNameToClient(sName,parent);if(cName!==testName){throw new Error("NamingConvention for this client property name does not roundtrip properly:"+cName+"-->"+testName)}return sName});parent[serverPropName]=Array.isArray(clientName)?serverNames:serverNames[0]}else{var serverName=parent[serverPropName];if(!serverName||serverName.length===0)return;var clientNames=__toArray(serverName).map(function(sName){var cName=nc.serverPropertyNameToClient(sName,parent);var testName=nc.clientPropertyNameToServer(cName,parent);if(sName!==testName){throw new Error("NamingConvention for this server property name does not roundtrip properly:"+sName+"-->"+testName)}return cName});parent[clientPropName]=Array.isArray(serverName)?clientNames:clientNames[0]}}proto._checkNavProperty=function(navigationProperty){if(navigationProperty.isNavigationProperty){if(navigationProperty.parentType!==this){throw new Error(__formatString("The navigationProperty '%1' is not a property of entity type '%2'",navigationProperty.name,this.name))}return navigationProperty}if(typeof navigationProperty==="string"){var np=this.getProperty(navigationProperty);if(np&&np.isNavigationProperty)return np}throw new Error("The 'navigationProperty' parameter must either be a NavigationProperty or the name of a NavigationProperty")};proto._addDataProperty=function(dp){this.dataProperties.push(dp);if(dp.isPartOfKey){this.keyProperties.push(dp)}if(dp.isComplexProperty){this.complexProperties.push(dp)}if(dp.concurrencyMode&&dp.concurrencyMode!=="None"){this.concurrencyProperties.push(dp)}if(dp.isUnmapped){this.unmappedProperties.push(dp)}};proto._addNavigationProperty=function(np){this.navigationProperties.push(np);if(!isQualifiedTypeName(np.entityTypeName)){np.entityTypeName=qualifyTypeName(np.entityTypeName,this.namespace)}};proto._updateCps=function(){var metadataStore=this.metadataStore;var incompleteMap=metadataStore._incompleteComplexTypeMap;this.complexProperties.forEach(function(cp){if(cp.complexType)return;if(!resolveCp(cp,metadataStore)){__getArray(incompleteMap,cp.complexTypeName).push(cp)}});if(this.isComplexType){(incompleteMap[this.name]||[]).forEach(function(cp){resolveCp(cp,metadataStore)});delete incompleteMap[this.name]}};function resolveCp(cp,metadataStore){var complexType=metadataStore._getEntityType(cp.complexTypeName,true);if(!complexType)return false;if(!(complexType instanceof ComplexType)){throw new Error("Unable to resolve ComplexType with the name: "+cp.complexTypeName+" for the property: "+property.name)}cp.dataType=complexType;cp.defaultValue=null;return true}proto._updateNps=function(){var metadataStore=this.metadataStore;var incompleteMap=metadataStore._incompleteTypeMap;this.navigationProperties.forEach(function(np){if(np.entityType)return;if(!resolveNp(np,metadataStore)){__getArray(incompleteMap,np.entityTypeName).push(np)}});(incompleteMap[this.name]||[]).forEach(function(np){resolveNp(np,metadataStore)});delete incompleteMap[this.name]};function resolveNp(np,metadataStore){var entityType=metadataStore._getEntityType(np.entityTypeName,true);if(!entityType)return false;np.entityType=entityType;var invNp=__arrayFirst(entityType.navigationProperties,function(altNp){return altNp.associationName===np.associationName&&(altNp.name!==np.name||altNp.entityTypeName!==np.entityTypeName)});np.inverse=invNp;if(!invNp){np.invForeignKeyNames.forEach(function(invFkName){var fkProp=entityType.getDataProperty(invFkName);var invEntityType=np.parentType;fkProp.inverseNavigationProperty=__arrayFirst(invEntityType.navigationProperties,function(np){return np.invForeignKeyNames&&np.invForeignKeyNames.indexOf(fkProp.name)>=0});addUniqueItem(entityType.foreignKeyProperties,fkProp)})}resolveRelated(np);return true}function addUniqueItem(collection,item){var ix=collection.indexOf(item);if(ix===-1)collection.push(item)}function resolveRelated(np){var fkNames=np.foreignKeyNames;if(fkNames.length===0)return;var parentEntityType=np.parentType;var fkProps=fkNames.map(function(fkName){return parentEntityType.getDataProperty(fkName)});var fkPropCollection=parentEntityType.foreignKeyProperties;fkProps.forEach(function(dp){addUniqueItem(fkPropCollection,dp);dp.relatedNavigationProperty=np;if(np.relatedDataProperties){np.relatedDataProperties.push(dp)}else{np.relatedDataProperties=[dp]}})}function calcUnmappedProperties(stype,instance){var metadataPropNames=stype.getPropertyNames();var trackablePropNames=__modelLibraryDef.getDefaultInstance().getTrackablePropertyNames(instance);trackablePropNames.forEach(function(pn){if(metadataPropNames.indexOf(pn)===-1){var newProp=new DataProperty({name:pn,dataType:DataType.Undefined,isNullable:true,isUnmapped:true});if(stype.subtypes){stype.getSelfAndSubtypes().forEach(function(st){st.addProperty(new DataProperty(newProp))})}else{stype.addProperty(newProp)}}})}return ctor}();var ComplexType=function(){var ctor=function(config){if(arguments.length>1){throw new Error("The ComplexType ctor has a single argument that is a configuration object.")}assertConfig(config).whereParam("shortName").isNonEmptyString().whereParam("namespace").isString().isOptional().withDefault("").whereParam("dataProperties").isOptional().whereParam("isComplexType").isOptional().isBoolean().applyAll(this);this.name=qualifyTypeName(this.shortName,this.namespace);this.isComplexType=true;this.dataProperties=[];this.complexProperties=[];this.validators=[];this.concurrencyProperties=[];this.unmappedProperties=[];this.navigationProperties=[];this.keyProperties=[];addProperties(this,config.dataProperties,DataProperty)};var proto=ctor.prototype;proto._createInstanceCore=function(parent,parentProperty){var aCtor=this.getCtor();var instance=new aCtor;new ComplexAspect(instance,parent,parentProperty);return instance};proto.addProperty=function(dataProperty){assertParam(dataProperty,"dataProperty").isInstanceOf(DataProperty).check();if(this.metadataStore&&!dataProperty.isUnmapped){throw new Error("The '"+this.name+"' ComplexType has already been added to a MetadataStore and therefore no additional properties may be added to it.")}if(dataProperty.parentType){if(dataProperty.parentType!==this){throw new Error("This dataProperty has already been added to "+property.parentType.name)}else{return this}}this._addDataProperty(dataProperty);return this};proto.getProperties=function(){return this.dataProperties};proto.addValidator=EntityType.prototype.addValidator;proto.getProperty=EntityType.prototype.getProperty;proto.getPropertyNames=EntityType.prototype.getPropertyNames;proto.createInstance=EntityType.prototype.createEntity;proto._addDataProperty=EntityType.prototype._addDataProperty;proto._updateNames=EntityType.prototype._updateNames;proto._updateCps=EntityType.prototype._updateCps;proto._initializeInstance=EntityType.prototype._initializeInstance;proto.getCtor=EntityType.prototype.getEntityCtor;proto._setCtor=EntityType.prototype._setCtor;proto.toJSON=function(){return __toJson(this,{shortName:null,namespace:null,isComplexType:null,dataProperties:null,validators:null})};proto._$typeName="ComplexType";return ctor}();var DataProperty=function(){var ctor=function(config){assertConfig(config).whereParam("name").isString().isOptional().whereParam("nameOnServer").isString().isOptional().whereParam("dataType").isEnumOf(DataType).isOptional().or().isString().or().isInstanceOf(ComplexType).whereParam("complexTypeName").isOptional().whereParam("isNullable").isBoolean().isOptional().withDefault(true).whereParam("isScalar").isOptional().withDefault(true).whereParam("defaultValue").isOptional().whereParam("isPartOfKey").isBoolean().isOptional().whereParam("isUnmapped").isBoolean().isOptional().whereParam("concurrencyMode").isString().isOptional().whereParam("maxLength").isNumber().isOptional().whereParam("validators").isInstanceOf(Validator).isArray().isOptional().withDefault([]).whereParam("enumType").isOptional().whereParam("rawTypeName").isOptional().applyAll(this);var hasName=!!(this.name||this.nameOnServer);if(!hasName){throw new Error("A DataProperty must be instantiated with either a 'name' or a 'nameOnServer' property")}if(this.complexTypeName){this.isComplexProperty=true;this.dataType=null}else if(typeof this.dataType==="string"){var dt=DataType.fromName(this.dataType);if(!dt){throw new Error("Unable to find a DataType enumeration by the name of: "+this.dataType)}this.dataType=dt}else if(!this.dataType){this.dataType=DataType.String}if(this.defaultValue==null){if(this.isNullable){this.defaultValue=null}else{if(this.isComplexProperty){}else if(this.dataType===DataType.Binary){this.defaultValue="AAAAAAAAJ3U="}else{this.defaultValue=this.dataType.defaultValue;if(this.defaultValue==null){throw new Error("A nonnullable DataProperty cannot have a null defaultValue. Name: "+this.name)}}}}if(this.isComplexProperty){this.isScalar=this.isScalar==null||this.isScalar===true}};var proto=ctor.prototype;proto._$typeName="DataProperty";proto.isDataProperty=true;proto.isNavigationProperty=false;proto.toJSON=function(){return __toJson(this,{name:null,dataType:function(v){return v&&v.parentEnum?v.name:undefined},complexTypeName:null,isNullable:true,defaultValue:null,isPartOfKey:false,isUnmapped:false,concurrencyMode:null,maxLength:null,validators:null,enumType:null,rawTypeName:null,isScalar:true})};ctor.fromJSON=function(json){json.dataType=DataType.fromName(json.dataType);if(json.defaultValue&&json.dataType&&json.dataType.isDate){json.defaultValue=new Date(Date.parse(json.defaultValue))}if(json.validators){json.validators=json.validators.map(Validator.fromJSON)}return new DataProperty(json)};return ctor}();var NavigationProperty=function(){var ctor=function(config){assertConfig(config).whereParam("name").isString().isOptional().whereParam("nameOnServer").isString().isOptional().whereParam("entityTypeName").isString().whereParam("isScalar").isBoolean().whereParam("associationName").isString().isOptional().whereParam("foreignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("foreignKeyNamesOnServer").isArray().isString().isOptional().withDefault([]).whereParam("invForeignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("invForeignKeyNamesOnServer").isArray().isString().isOptional().withDefault([]).whereParam("validators").isInstanceOf(Validator).isArray().isOptional().withDefault([]).applyAll(this);var hasName=!!(this.name||this.nameOnServer);if(!hasName){throw new Error("A Navigation property must be instantiated with either a 'name' or a 'nameOnServer' property")}};var proto=ctor.prototype;proto._$typeName="NavigationProperty";proto.isDataProperty=false;proto.isNavigationProperty=true;proto.toJSON=function(){return __toJson(this,{name:null,entityTypeName:null,isScalar:null,associationName:null,validators:null,foreignKeyNames:null,invForeignKeyNames:null})};ctor.fromJSON=function(json){if(json.validators){json.validators=json.validators.map(Validator.fromJSON)}return new NavigationProperty(json)};return ctor}();var AutoGeneratedKeyType=function(){var ctor=new Enum("AutoGeneratedKeyType");ctor.None=ctor.addSymbol();ctor.Identity=ctor.addSymbol();ctor.KeyGenerator=ctor.addSymbol();ctor.seal();return ctor}();(function(){var proto=Param.prototype;proto.isEntity=function(){return this._addContext({fn:isEntity,msg:" must be an entity"})};function isEntity(context,v){if(v==null)return false;return v.entityType!==undefined}proto.isEntityProperty=function(){return this._addContext({fn:isEntityProperty,msg:" must be either a DataProperty or a NavigationProperty"})};function isEntityProperty(context,v){if(v==null)return false;return v.isDataProperty||v.isNavigationProperty}})();function isQualifiedTypeName(entityTypeName){return entityTypeName.indexOf(":#")>=0}function qualifyTypeName(shortName,namespace){return shortName+":#"+namespace}function addProperties(entityType,propObj,ctor){if(!propObj)return;if(Array.isArray(propObj)){propObj.forEach(entityType.addProperty.bind(entityType))}else if(typeof propObj==="object"){for(var key in propObj){if(__hasOwnProperty(propObj,key)){var value=propObj[key];value.name=key;var prop=new ctor(value);entityType.addProperty(prop)}}}else{throw new Error("The 'dataProperties' or 'navigationProperties' values must be either an array of data/nav properties or an object where each property defines a data/nav property")}}breeze.MetadataStore=MetadataStore;breeze.EntityType=EntityType;breeze.ComplexType=ComplexType;breeze.DataProperty=DataProperty;breeze.NavigationProperty=NavigationProperty;breeze.AutoGeneratedKeyType=AutoGeneratedKeyType;MetadataStore.normalizeTypeName=CsdlMetadataParser.normalizeTypeName;var KeyGenerator=function(){var ctor=function(){this._tempIdMap={}};var proto=ctor.prototype;proto.generateTempKeyValue=function(entityType,valueIfAvail){var keyProps=entityType.keyProperties;if(keyProps.length>1){throw new Error("Ids can not be autogenerated for entities with multipart keys")}var keyProp=keyProps[0];var propEntry=getPropEntry(this,keyProp,true);var nextId;if(valueIfAvail!=null){if(!propEntry.keyMap[valueIfAvail.toString()]){nextId=valueIfAvail}}if(nextId===undefined){var dataType=keyProp.dataType;if(dataType.getNext){nextId=dataType.getNext(this);while(propEntry.keyMap[nextId.toString()]!=null){nextId=dataType.getNext(this)}}else{throw new Error("Cannot use a property with a dataType of: "+dataType.toString()+" for id generation")}}propEntry.keyMap[nextId.toString()]=true;return nextId};proto.getTempKeys=function(){var results=[];for(var key in this._tempIdMap){var propEntry=this._tempIdMap[key];var entityType=propEntry.entityType;for(var keyValue in propEntry.keyMap){results.push(new EntityKey(entityType,[keyValue]))}}return results};proto.isTempKey=function(entityKey){var keyProps=entityKey.entityType.keyProperties;if(keyProps.length>1)return false;var keyProp=keyProps[0];var propEntry=getPropEntry(this,keyProp);if(!propEntry){return false}return propEntry.keyMap[entityKey.values[0].toString()]!==undefined};function getPropEntry(that,keyProp,createIfMissing){var key=keyProp.name+".."+keyProp.parentType.name;var propEntry=that._tempIdMap[key];if(!propEntry){if(createIfMissing){propEntry={entityType:keyProp.parentType,propertyName:keyProp.name,keyMap:{}};that._tempIdMap[key]=propEntry}}return propEntry}__config.registerType(ctor,"KeyGenerator");return ctor}();breeze.KeyGenerator=KeyGenerator;var LocalQueryComparisonOptions=function(){var ctor=function(config){assertConfig(config||{}).whereParam("name").isOptional().isString().whereParam("isCaseSensitive").isOptional().isBoolean().whereParam("usesSql92CompliantStringComparison").isBoolean().applyAll(this);if(!this.name){this.name=__getUuid()}__config._storeObject(this,proto._$typeName,this.name)};var proto=ctor.prototype;proto._$typeName="LocalQueryComparisonOptions";ctor.caseInsensitiveSQL=new ctor({name:"caseInsensitiveSQL",isCaseSensitive:false,usesSql92CompliantStringComparison:true});ctor.defaultInstance=new ctor(ctor.caseInsensitiveSQL);proto.setAsDefault=function(){return __setAsDefault(this,ctor)};return ctor}();breeze.LocalQueryComparisonOptions=LocalQueryComparisonOptions;var NamingConvention=function(){var ctor=function(config){assertConfig(config||{}).whereParam("name").isOptional().isString().whereParam("serverPropertyNameToClient").isFunction().whereParam("clientPropertyNameToServer").isFunction().applyAll(this);if(!this.name){this.name=__getUuid()}__config._storeObject(this,proto._$typeName,this.name)};var proto=ctor.prototype;proto._$typeName="NamingConvention";ctor.none=new ctor({name:"noChange",serverPropertyNameToClient:function(serverPropertyName){return serverPropertyName},clientPropertyNameToServer:function(clientPropertyName){return clientPropertyName}});ctor.camelCase=new ctor({name:"camelCase",serverPropertyNameToClient:function(serverPropertyName){return serverPropertyName.substr(0,1).toLowerCase()+serverPropertyName.substr(1)},clientPropertyNameToServer:function(clientPropertyName){return clientPropertyName.substr(0,1).toUpperCase()+clientPropertyName.substr(1)}});ctor.defaultInstance=new ctor(ctor.none);proto.setAsDefault=function(){return __setAsDefault(this,ctor)};return ctor}();breeze.NamingConvention=NamingConvention;var EntityQuery=function(){var ctor=function(resourceName){assertParam(resourceName,"resourceName").isOptional().isString().check();this.resourceName=resourceName;this.entityType=null;this.wherePredicate=null;this.orderByClause=null;this.selectClause=null;this.skipCount=null;this.takeCount=null;this.expandClause=null;this.parameters={};this.inlineCountEnabled=false;this.entityManager=null};var proto=ctor.prototype;proto._$typeName="EntityQuery";proto.from=function(resourceName){assertParam(resourceName,"resourceName").isString().check();var currentName=this.resourceName;if(currentName&&currentName!==resourceName){throw new Error("This query already has an resourceName - the resourceName may only be set once per query")}var eq=this._clone();eq.resourceName=resourceName;return eq};ctor.from=function(resourceName){assertParam(resourceName,"resourceName").isString().check();return new EntityQuery(resourceName)};proto.toType=function(entityType){assertParam(entityType,"entityType").isString().or().isInstanceOf(EntityType).check();var eq=this._clone();eq.resultEntityType=entityType;return eq};proto.where=function(predicate){var eq=this._clone();if(predicate==null){eq.wherePredicate=null;return eq}var pred;if(Predicate.isPredicate(predicate)){pred=predicate}else{pred=Predicate.create(__arraySlice(arguments))}if(eq.entityType)pred.validate(eq.entityType);if(eq.wherePredicate){eq.wherePredicate=new CompositePredicate("and",[eq.wherePredicate,pred])}else{eq.wherePredicate=pred}return eq};proto.orderBy=function(propertyPaths){return orderByCore(this,propertyPaths)};proto.orderByDesc=function(propertyPaths){return orderByCore(this,propertyPaths,true)};proto.select=function(propertyPaths){return selectCore(this,propertyPaths)};proto.skip=function(count){assertParam(count,"count").isOptional().isNumber().check();var eq=this._clone();if(count==null){eq.skipCount=null}else{eq.skipCount=count}return eq};proto.top=function(count){return this.take(count)};proto.take=function(count){assertParam(count,"count").isOptional().isNumber().check();var eq=this._clone();if(count==null){eq.takeCount=null}else{eq.takeCount=count}return eq};proto.expand=function(propertyPaths){return expandCore(this,propertyPaths)};proto.withParameters=function(parameters){assertParam(parameters,"parameters").isObject().check();return withParametersCore(this,parameters)};proto.inlineCount=function(enabled){if(enabled===undefined)enabled=true;var eq=this._clone();eq.inlineCountEnabled=enabled;return eq};proto.using=function(obj){if(!obj)return this;var eq=this._clone();processUsing(eq,{entityManager:null,dataService:null,queryOptions:null,fetchStrategy:function(eq,val){eq.queryOptions=(eq.queryOptions||new QueryOptions).using(val)},mergeStrategy:function(eq,val){eq.queryOptions=(eq.queryOptions||new QueryOptions).using(val)},jsonResultsAdapter:function(eq,val){eq.dataService=(eq.dataService||new DataService).using({jsonResultsAdapter:val})}},obj);return eq};function processUsing(eq,map,value,propertyName){var typeName=value._$typeName||value.parentEnum&&value.parentEnum.name;var key=typeName&&typeName.substr(0,1).toLowerCase()+typeName.substr(1);if(propertyName&&key!=propertyName){throw new Error("Invalid value for property: "+propertyName)}if(key){var fn=map[key];if(fn===undefined){throw new Error("Invalid config property: "+key)}else if(fn===null){eq[key]=value}else{fn(eq,value)}}else{__objectForEach(value,function(propName,val){processUsing(eq,map,val,propName)})}}proto.execute=function(callback,errorCallback){if(!this.entityManager){throw new Error("An EntityQuery must have its EntityManager property set before calling 'execute'")}return this.entityManager.executeQuery(this,callback,errorCallback)};proto.executeLocally=function(){if(!this.entityManager){throw new Error("An EntityQuery must have its EntityManager property set before calling 'executeLocally'")}return this.entityManager.executeQueryLocally(this)};ctor.fromEntities=function(entities){assertParam(entities,"entities").isEntity().or().isNonEmptyArray().isEntity().check();if(!Array.isArray(entities)){entities=__arraySlice(arguments)}var firstEntity=entities[0];var q=new EntityQuery(firstEntity.entityType.defaultResourceName);var preds=entities.map(function(entity){return buildPredicate(entity)});var pred=Predicate.or(preds);q=q.where(pred);var em=firstEntity.entityAspect.entityManager;if(em){q=q.using(em)}return q};ctor.fromEntityKey=function(entityKey){assertParam(entityKey,"entityKey").isInstanceOf(EntityKey).check();var q=new EntityQuery(entityKey.entityType.defaultResourceName);var pred=buildKeyPredicate(entityKey);q=q.where(pred);return q};ctor.fromEntityNavigation=function(entity,navigationProperty){assertParam(entity,"entity").isEntity().check();assertParam(navigationProperty,"navigationProperty").isInstanceOf(NavigationProperty).check();var navProperty=entity.entityType._checkNavProperty(navigationProperty);var q=new EntityQuery(navProperty.entityType.defaultResourceName);var pred=buildNavigationPredicate(entity,navProperty);q=q.where(pred);var em=entity.entityAspect.entityManager;if(em){q=q.using(em)}return q};proto._getFromEntityType=function(metadataStore,throwErrorIfNotFound){var entityType=this.entityType;if(entityType)return entityType;var resourceName=this.resourceName;if(!resourceName){throw new Error("There is no resourceName for this query")}if(metadataStore.isEmpty()){if(throwErrorIfNotFound){throw new Error("There is no metadata available for this query")}else{return null}}var entityTypeName=metadataStore.getEntityTypeNameForResourceName(resourceName);if(entityTypeName){entityType=metadataStore._getEntityType(entityTypeName)}else{entityType=this._getToEntityType(metadataStore,true)}if(!entityType){if(throwErrorIfNotFound){throw new Error(__formatString("Cannot find an entityType for resourceName: '%1'. "+" Consider adding an 'EntityQuery.toType' call to your query or "+"calling the MetadataStore.setEntityTypeForResourceName method to register an entityType for this resourceName.",resourceName))
}else{return null}}this.entityType=entityType;return entityType};proto._getToEntityType=function(metadataStore,skipFromCheck){if(this.resultEntityType instanceof EntityType){return this.resultEntityType}else if(this.resultEntityType){this.resultEntityType=metadataStore._getEntityType(this.resultEntityType,false);return this.resultEntityType}else{return skipFromCheck?null:!this.selectClause&&this._getFromEntityType(metadataStore,false)}};proto._clone=function(){var copy=new EntityQuery;copy.resourceName=this.resourceName;copy.entityType=this.entityType;copy.wherePredicate=this.wherePredicate;copy.orderByClause=this.orderByClause;copy.selectClause=this.selectClause;copy.skipCount=this.skipCount;copy.takeCount=this.takeCount;copy.expandClause=this.expandClause;copy.inlineCountEnabled=this.inlineCountEnabled;copy.parameters=__extend({},this.parameters);copy.queryOptions=this.queryOptions;copy.entityManager=this.entityManager;copy.dataService=this.dataService;copy.resultEntityType=this.resultEntityType;return copy};proto._toUri=function(metadataStore){var entityType=this._getFromEntityType(metadataStore,false);if(!entityType){entityType=new EntityType(metadataStore)}var eq=this;var queryOptions={};queryOptions["$filter"]=toFilterString();queryOptions["$orderby"]=toOrderByString();queryOptions["$skip"]=toSkipString();queryOptions["$top"]=toTopString();queryOptions["$expand"]=toExpandString();queryOptions["$select"]=toSelectString();queryOptions["$inlinecount"]=toInlineCountString();var qoText=toQueryOptionsString(queryOptions);return this.resourceName+qoText;function toFilterString(){var clause=eq.wherePredicate;if(!clause)return;if(eq.entityType){clause.validate(eq.entityType)}return clause.toOdataFragment(entityType)}function toInlineCountString(){if(!eq.inlineCountEnabled)return;return eq.inlineCountEnabled?"allpages":"none"}function toOrderByString(){var clause=eq.orderByClause;if(!clause)return;if(eq.entityType){clause.validate(eq.entityType)}return clause.toOdataFragment(entityType)}function toSelectString(){var clause=eq.selectClause;if(!clause)return;if(eq.entityType){clause.validate(eq.entityType)}return clause.toOdataFragment(entityType)}function toExpandString(){var clause=eq.expandClause;if(!clause)return;return clause.toOdataFragment(entityType)}function toSkipString(){var count=eq.skipCount;if(!count)return;return count.toString()}function toTopString(){var count=eq.takeCount;if(count==null)return;return count.toString()}function toQueryOptionsString(queryOptions){var qoStrings=[];for(var qoName in queryOptions){var qoValue=queryOptions[qoName];if(qoValue!==undefined){if(qoValue instanceof Array){qoValue.forEach(function(qov){qoStrings.push(qoName+"="+encodeURIComponent(qov))})}else{qoStrings.push(qoName+"="+encodeURIComponent(qoValue))}}}if(qoStrings.length>0){return"?"+qoStrings.join("&")}else{return""}}};proto._toFilterFunction=function(entityType){var wherePredicate=this.wherePredicate;if(!wherePredicate)return null;wherePredicate.validate(entityType);return wherePredicate.toFunction(entityType)};proto._toOrderByComparer=function(entityType){var orderByClause=this.orderByClause;if(!orderByClause)return null;return orderByClause.getComparer(entityType)};function normalizePropertyPaths(propertyPaths){assertParam(propertyPaths,"propertyPaths").isOptional().isString().or().isArray().isString().check();if(typeof propertyPaths==="string"){propertyPaths=propertyPaths.split(",")}propertyPaths=propertyPaths.map(function(pp){return pp.trim()});return propertyPaths}function buildPredicate(entity){var entityType=entity.entityType;var predParts=entityType.keyProperties.map(function(kp){return Predicate.create(kp.name,FilterQueryOp.Equals,entity.getProperty(kp.name))});var pred=Predicate.and(predParts);return pred}function orderByCore(that,propertyPaths,isDesc){var newClause;var eq=that._clone();if(propertyPaths==null){eq.orderByClause=null;return eq}propertyPaths=normalizePropertyPaths(propertyPaths);newClause=OrderByClause.create(propertyPaths,isDesc);if(eq.orderByClause){eq.orderByClause.addClause(newClause)}else{eq.orderByClause=newClause}return eq}function selectCore(that,propertyPaths){var eq=that._clone();if(propertyPaths==null){eq.selectClause=null;return eq}propertyPaths=normalizePropertyPaths(propertyPaths);eq.selectClause=new SelectClause(propertyPaths);return eq}function expandCore(that,propertyPaths){var eq=that._clone();if(propertyPaths==null){eq.expandClause=null;return eq}propertyPaths=normalizePropertyPaths(propertyPaths);eq.expandClause=new ExpandClause(propertyPaths);return eq}function withParametersCore(that,parameters){var eq=that._clone();eq.parameters=parameters;return eq}function buildKeyPredicate(entityKey){var keyProps=entityKey.entityType.keyProperties;var preds=__arrayZip(keyProps,entityKey.values,function(kp,v){return Predicate.create(kp.name,FilterQueryOp.Equals,v)});var pred=Predicate.and(preds);return pred}function buildNavigationPredicate(entity,navigationProperty){if(navigationProperty.isScalar){if(navigationProperty.foreignKeyNames.length===0)return null;var relatedKeyValues=navigationProperty.foreignKeyNames.map(function(fkName){return entity.getProperty(fkName)});var entityKey=new EntityKey(navigationProperty.entityType,relatedKeyValues);return buildKeyPredicate(entityKey)}else{var inverseNp=navigationProperty.inverse;var foreignKeyNames=inverseNp?inverseNp.foreignKeyNames:navigationProperty.invForeignKeyNames;if(foreignKeyNames.length===0)return null;var keyValues=entity.entityAspect.getKey().values;var predParts=__arrayZip(foreignKeyNames,keyValues,function(fkName,kv){return Predicate.create(fkName,FilterQueryOp.Equals,kv)});return Predicate.and(predParts)}}return ctor}();var QueryFuncs=function(){var obj={toupper:{fn:function(source){return source.toUpperCase()},dataType:DataType.String},tolower:{fn:function(source){return source.toLowerCase()},dataType:DataType.String},substring:{fn:function(source,pos,length){return source.substring(pos,length)},dataType:DataType.String},substringof:{fn:function(find,source){return source.indexOf(find)>=0},dataType:DataType.Boolean},length:{fn:function(source){return source.length},dataType:DataType.Int32},trim:{fn:function(source){return source.trim()},dataType:DataType.String},concat:{fn:function(s1,s2){return s1.concat(s2)},dataType:DataType.String},replace:{fn:function(source,find,replace){return source.replace(find,replace)},dataType:DataType.String},startswith:{fn:function(source,find){return __stringStartsWith(source,find)},dataType:DataType.Boolean},endswith:{fn:function(source,find){return __stringEndsWith(source,find)},dataType:DataType.Boolean},indexof:{fn:function(source,find){return source.indexOf(find)},dataType:DataType.Int32},round:{fn:function(source){return Math.round(source)},dataType:DataType.Int32},ceiling:{fn:function(source){return Math.ceil(source)},dataType:DataType.Int32},floor:{fn:function(source){return Math.floor(source)},dataType:DataType.Int32},second:{fn:function(source){return source.second},dataType:DataType.Int32},minute:{fn:function(source){return source.minute},dataType:DataType.Int32},day:{fn:function(source){return source.day},dataType:DataType.Int32},month:{fn:function(source){return source.month},dataType:DataType.Int32},year:{fn:function(source){return source.year},dataType:DataType.Int32}};return obj}();var FnNode=function(){var RX_IDENTIFIER=/^[a-z_][\w.$]*$/i;var RX_COMMA_DELIM1=/('[^']*'|[^,]+)/g;var RX_COMMA_DELIM2=/("[^"]*"|[^,]+)/g;var ctor=function(source,tokens,entityType){var parts=source.split(":");this.isRealNode=true;if(parts.length===1){var value=parts[0].trim();this.value=value;var firstChar=value.substr(0,1);var quoted=firstChar==="'"||firstChar==='"';if(quoted){var unquoted=value.substr(1,value.length-2);this.fn=function(entity){return unquoted};this.dataType=DataType.String}else{var mayBeIdentifier=RX_IDENTIFIER.test(value);if(mayBeIdentifier){if(entityType){if(entityType.getProperty(value,false)==null){this.isRealNode=false;return}}this.propertyPath=value;this.fn=createPropFunction(value)}else{if(entityType){this.isRealNode=false;return}this.fn=function(entity){return value};this.dataType=DataType.fromValue(value)}}}else{try{this.fnName=parts[0].trim().toLowerCase();var qf=QueryFuncs[this.fnName];this.localFn=qf.fn;this.dataType=qf.dataType;var that=this;this.fn=function(entity){var resolvedNodes=that.fnNodes.map(function(fnNode){var argVal=fnNode.fn(entity);return argVal});var val=that.localFn.apply(null,resolvedNodes);return val};var argSource=tokens[parts[1]].trim();if(argSource.substr(0,1)==="("){argSource=argSource.substr(1,argSource.length-2)}var commaMatchStr=source.indexOf("'")>=0?RX_COMMA_DELIM1:RX_COMMA_DELIM2;var args=argSource.match(commaMatchStr);this.fnNodes=args.map(function(a){return new FnNode(a,tokens)})}catch(e){this.isRealNode=false}}};var proto=ctor.prototype;ctor.create=function(source,entityType,operator){if(typeof source!=="string"){return null}var regex=/\([^()]*\)/;var m;var tokens=[];var i=0;while(m=regex.exec(source)){var token=m[0];tokens.push(token);var repl=":"+i++;source=source.replace(token,repl)}var node=new FnNode(source,tokens,operator?null:entityType);if(node.isRealNode){if(!node.dataType&&operator&&operator.isStringFn){node.dataType=DataType.String}node._validate(entityType);return node}else{return null}};proto.toString=function(){if(this.fnName){var args=this.fnNodes.map(function(fnNode){return fnNode.toString()});var uri=this.fnName+"("+args.join(",")+")";return uri}else{return this.value}};proto.toOdataFragment=function(entityType){this._validate(entityType);if(this.fnName){var args=this.fnNodes.map(function(fnNode){return fnNode.toOdataFragment(entityType)});var uri=this.fnName+"("+args.join(",")+")";return uri}else{var firstChar=this.value.substr(0,1);if(firstChar==="'"||firstChar==='"'){return this.value}else if(this.value==this.propertyPath){return entityType._clientPropertyPathToServer(this.propertyPath)}else{return this.value}}};proto._validate=function(entityType){if(this.isValidated)return;this.isValidated=true;if(this.propertyPath){if(entityType.isAnonymous)return;var prop=entityType.getProperty(this.propertyPath,true);if(!prop){var msg=__formatString("Unable to resolve propertyPath.  EntityType: '%1'   PropertyPath: '%2'",entityType.name,this.propertyPath);throw new Error(msg)}if(prop.isDataProperty){this.dataType=prop.dataType}else{this.dataType=prop.entityType}}else if(this.fnNodes){this.fnNodes.forEach(function(node){node._validate(entityType)})}};function createPropFunction(propertyPath){var properties=propertyPath.split(".");if(properties.length===1){return function(entity){return entity.getProperty(propertyPath)}}else{return function(entity){return getPropertyPathValue(entity,properties)}}}return ctor}();var FilterQueryOp=function(){var aEnum=new Enum("FilterQueryOp");aEnum.Equals=aEnum.addSymbol({operator:"eq",aliases:["=="]});aEnum.NotEquals=aEnum.addSymbol({operator:"ne",aliases:["!="]});aEnum.GreaterThan=aEnum.addSymbol({operator:"gt",aliases:[">"]});aEnum.LessThan=aEnum.addSymbol({operator:"lt",aliases:["<"]});aEnum.GreaterThanOrEqual=aEnum.addSymbol({operator:"ge",aliases:[">="]});aEnum.LessThanOrEqual=aEnum.addSymbol({operator:"le",aliases:["<="]});aEnum.Contains=aEnum.addSymbol({operator:"substringof",isFunction:true,isStringFn:true});aEnum.StartsWith=aEnum.addSymbol({operator:"startswith",isFunction:true,isStringFn:true});aEnum.EndsWith=aEnum.addSymbol({operator:"endswith",isFunction:true,isStringFn:true});aEnum.IsTypeOf=aEnum.addSymbol({operator:"isof",isFunction:true,aliases:["isTypeOf"]});aEnum.seal();aEnum._map=function(){var map={};aEnum.getSymbols().forEach(function(s){map[s.name.toLowerCase()]=s;map[s.operator.toLowerCase()]=s;if(s.aliases){s.aliases.forEach(function(alias){map[alias.toLowerCase()]=s})}});return map}();aEnum.from=function(op){if(aEnum.contains(op)){return op}else{return aEnum._map[op.toLowerCase()]}};return aEnum}();var BooleanQueryOp=function(){var aEnum=new Enum("BooleanQueryOp");aEnum.And=aEnum.addSymbol({operator:"and",aliases:["&&"]});aEnum.Or=aEnum.addSymbol({operator:"or",aliases:["||"]});aEnum.Not=aEnum.addSymbol({operator:"not",aliases:["~","!"]});aEnum.seal();aEnum._map=function(){var map={};aEnum.getSymbols().forEach(function(s){map[s.name.toLowerCase()]=s;map[s.operator.toLowerCase()]=s;if(s.aliases){s.aliases.forEach(function(alias){map[alias.toLowerCase()]=s})}});return map}();aEnum.from=function(op){if(aEnum.contains(op)){return op}else{return aEnum._map[op.toLowerCase()]}};return aEnum}();var Predicate=function(){var ctor=function(propertyOrExpr,operator,value){if(arguments[0].prototype===true){return this}return new SimplePredicate(propertyOrExpr,operator,value)};var proto=ctor.prototype;ctor.isPredicate=function(o){return o instanceof Predicate};ctor.create=function(property,operator,value){if(Array.isArray(property)){return new SimplePredicate(property[0],property[1],property[2])}else{return new SimplePredicate(property,operator,value)}};ctor.and=function(predicates){predicates=argsToPredicates(arguments);if(predicates.length===0){return null}else if(predicates.length===1){return predicates[0]}else{return new CompositePredicate("and",predicates)}};ctor.or=function(predicates){predicates=argsToPredicates(arguments);if(predicates.length===0){return null}else if(predicates.length===1){return predicates[0]}else{return new CompositePredicate("or",predicates)}};ctor.not=function(predicate){return new CompositePredicate("not",[predicate])};proto.and=function(predicates){predicates=argsToPredicates(arguments);predicates.unshift(this);return ctor.and(predicates)};proto.or=function(predicates){predicates=argsToPredicates(arguments);predicates.unshift(this);return ctor.or(predicates)};proto.not=function(){return new CompositePredicate("not",[this])};function argsToPredicates(argsx){var args;if(argsx.length===1&&Array.isArray(argsx[0])){args=argsx[0]}else{var args=__arraySlice(argsx);if(!Predicate.isPredicate(args[0])){args=[Predicate.create(args)]}}return args.filter(function(arg){return arg!=null})}return ctor}();var SimplePredicate=function(){var ctor=function(propertyOrExpr,operator,value){assertParam(propertyOrExpr,"propertyOrExpr").isString().isOptional().check();if(arguments.length==3&&operator!=null){assertParam(operator,"operator").isEnumOf(FilterQueryOp).or().isString().check();assertParam(value,"value").isRequired(true).check()}else{this._odataExpr=propertyOrExpr;return}this._filterQueryOp=FilterQueryOp.from(operator);if(!this._filterQueryOp){throw new Error("Unknown query operation: "+operator)}if(propertyOrExpr){this._propertyOrExpr=propertyOrExpr}else{if(this._filterQueryOp!==FilterQueryOp.IsTypeOf){throw new Error("propertyOrExpr cannot be null except when using the 'IsTypeOf' operator")}}if(value!=null&&typeof value==="object"&&value.value!==undefined){this._dataType=value.dataType||DataType.fromValue(value.value);this._value=value.value;this._isLiteral=value.isLiteral}else{this._dataType=DataType.fromValue(value);this._value=value;this._isLiteral=undefined}};var proto=new Predicate({prototype:true});ctor.prototype=proto;proto.toOdataFragment=function(entityType){if(this._odataExpr){return this._odataExpr}if(this._filterQueryOp==FilterQueryOp.IsTypeOf){var oftype=entityType.metadataStore.getEntityType(this._value);var typeName=oftype.namespace+"."+oftype.shortName;return this._filterQueryOp.operator+"("+DataType.String.fmtOData(typeName)+")"}this.validate(entityType);var v1Expr=this._fnNode1&&this._fnNode1.toOdataFragment(entityType);var v2Expr;if(this._fnNode2){v2Expr=this._fnNode2.toOdataFragment(entityType)}else{var dataType=this._fnNode1.dataType||this._dataType;v2Expr=dataType.fmtOData(this._value)}if(this._filterQueryOp.isFunction){if(this._filterQueryOp==FilterQueryOp.Contains){return this._filterQueryOp.operator+"("+v2Expr+","+v1Expr+") eq true"}else{return this._filterQueryOp.operator+"("+v1Expr+","+v2Expr+") eq true"}}else{return v1Expr+" "+this._filterQueryOp.operator+" "+v2Expr}};proto.toFunction=function(entityType){if(this._odataExpr){throw new Exception("OData predicateexpressions cannot be interpreted locally")}this.validate(entityType);var dataType=this._fnNode1.dataType||this._dataType;var predFn=getPredicateFn(entityType,this._filterQueryOp,dataType);var v1Fn=this._fnNode1.fn;if(this._fnNode2){var v2Fn=this._fnNode2.fn;return function(entity){return predFn(v1Fn(entity),v2Fn(entity))}}else{var val=this._value;return function(entity){return predFn(v1Fn(entity),val)}}};proto.toString=function(){return __formatString("{%1} %2 {%3}",this._propertyOrExpr,this._filterQueryOp.operator,this._value)};proto.validate=function(entityType){if(this._fnNode1===undefined&&this._propertyOrExpr){this._fnNode1=FnNode.create(this._propertyOrExpr,entityType,this._filterQueryOp);this.dataType=this._fnNode1.dataType}if(this._fnNode2===undefined&&!this._isLiteral){this._fnNode2=FnNode.create(this._value,entityType)}};function getPredicateFn(entityType,filterQueryOp,dataType){var lqco=entityType.metadataStore.localQueryComparisonOptions;var mc=getComparableFn(dataType);var predFn;switch(filterQueryOp){case FilterQueryOp.Equals:predFn=function(v1,v2){if(v1&&typeof v1==="string"){return stringEquals(v1,v2,lqco)}else{return mc(v1)==mc(v2)}};break;case FilterQueryOp.NotEquals:predFn=function(v1,v2){if(v1&&typeof v1==="string"){return!stringEquals(v1,v2,lqco)}else{return mc(v1)!=mc(v2)}};break;case FilterQueryOp.GreaterThan:predFn=function(v1,v2){return mc(v1)>mc(v2)};break;case FilterQueryOp.GreaterThanOrEqual:predFn=function(v1,v2){return mc(v1)>=mc(v2)};break;case FilterQueryOp.LessThan:predFn=function(v1,v2){return mc(v1)<mc(v2)};break;case FilterQueryOp.LessThanOrEqual:predFn=function(v1,v2){return mc(v1)<=mc(v2)};break;case FilterQueryOp.StartsWith:predFn=function(v1,v2){return stringStartsWith(v1,v2,lqco)};break;case FilterQueryOp.EndsWith:predFn=function(v1,v2){return stringEndsWith(v1,v2,lqco)};break;case FilterQueryOp.Contains:predFn=function(v1,v2){return stringContains(v1,v2,lqco)};break;default:throw new Error("Unknown FilterQueryOp: "+filterQueryOp)}return predFn}function stringEquals(a,b,lqco){if(b==null)return false;if(typeof b!=="string"){b=b.toString()}if(lqco.usesSql92CompliantStringComparison){a=(a||"").trim();b=(b||"").trim()}if(!lqco.isCaseSensitive){a=(a||"").toLowerCase();b=(b||"").toLowerCase()}return a===b}function stringStartsWith(a,b,lqco){if(!lqco.isCaseSensitive){a=(a||"").toLowerCase();b=(b||"").toLowerCase()}return __stringStartsWith(a,b)}function stringEndsWith(a,b,lqco){if(!lqco.isCaseSensitive){a=(a||"").toLowerCase();b=(b||"").toLowerCase()}return __stringEndsWith(a,b)}function stringContains(a,b,lqco){if(!lqco.isCaseSensitive){a=(a||"").toLowerCase();b=(b||"").toLowerCase()}return a.indexOf(b)>=0}return ctor}();var CompositePredicate=function(){var ctor=function(booleanOperator,predicates){if(!Array.isArray(predicates)){throw new Error("predicates parameter must be an array")}this._booleanQueryOp=BooleanQueryOp.from(booleanOperator);if(!this._booleanQueryOp){throw new Error("Unknown query operation: "+booleanOperator)}if(this._booleanQueryOp===BooleanQueryOp.Not&&predicates.length!==1){throw new Error("Only a single predicate can be passed in with the 'Not' operator")}this._predicates=predicates};var proto=new Predicate({prototype:true});ctor.prototype=proto;proto.toOdataFragment=function(entityType){if(this._predicates.length==1){return this._booleanQueryOp.operator+" "+"("+this._predicates[0].toOdataFragment(entityType)+")"}else{var result=this._predicates.map(function(p){return"("+p.toOdataFragment(entityType)+")"}).join(" "+this._booleanQueryOp.operator+" ");return result}};proto.toFunction=function(entityType){return createFunction(entityType,this._booleanQueryOp,this._predicates)};proto.toString=function(){if(this._predicates.length==1){return this._booleanQueryOp.operator+" "+"("+this._predicates[0]+")"}else{var result=this._predicates.map(function(p){return"("+p.toString()+")"}).join(" "+this._booleanQueryOp.operator+" ");return result}};proto.validate=function(entityType){if(this._isValidated)return;this._predicates.every(function(p){p.validate(entityType)});this._isValidated=true};function createFunction(entityType,booleanQueryOp,predicates){var func,funcs;switch(booleanQueryOp){case BooleanQueryOp.Not:func=predicates[0].toFunction(entityType);return function(entity){return!func(entity)};case BooleanQueryOp.And:funcs=predicates.map(function(p){return p.toFunction(entityType)});return function(entity){var result=funcs.reduce(function(prev,cur){return prev&&cur(entity)},true);return result};case BooleanQueryOp.Or:funcs=predicates.map(function(p){return p.toFunction(entityType)});return function(entity){var result=funcs.reduce(function(prev,cur){return prev||cur(entity)},false);return result};default:throw new Error("Invalid boolean operator:"+booleanQueryOp)}}return ctor}();var OrderByClause=function(){var ctor=function(propertyPaths,isDesc){if(propertyPaths.prototype===true){return this}return ctor.create(propertyPaths,isDesc)};var proto=ctor.prototype;ctor.create=function(propertyPaths,isDesc){if(propertyPaths.length>1){var clauses=propertyPaths.map(function(pp){return new SimpleOrderByClause(pp,isDesc)});return new CompositeOrderByClause(clauses)}else{return new SimpleOrderByClause(propertyPaths[0],isDesc)}};ctor.combine=function(orderByClauses){return new CompositeOrderByClause(orderByClauses)};ctor.isOrderByClause=function(obj){return obj instanceof OrderByClause};proto.addClause=function(orderByClause){return new CompositeOrderByClause([this,orderByClause])};return ctor}();var SimpleOrderByClause=function(){var ctor=function(propertyPath,isDesc){if(!(typeof propertyPath==="string")){throw new Error("propertyPath is not a string")}propertyPath=propertyPath.trim();var parts=propertyPath.split(" ");if(parts.length>1&&isDesc!==true&&isDesc!==false){isDesc=__stringStartsWith(parts[1].toLowerCase(),"desc");if(!isDesc){var isAsc=__stringStartsWith(parts[1].toLowerCase(),"asc");if(!isAsc){throw new Error("the second word in the propertyPath must begin with 'desc' or 'asc'")}}}this.propertyPath=parts[0];this.isDesc=isDesc};var proto=new OrderByClause({prototype:true});ctor.prototype=proto;proto.validate=function(entityType){if(!entityType)return;this.lastProperty=entityType.getProperty(this.propertyPath,true)};proto.toOdataFragment=function(entityType){return entityType._clientPropertyPathToServer(this.propertyPath)+(this.isDesc?" desc":"")};proto.getComparer=function(entityType){if(!this.lastProperty)this.validate(entityType);if(this.lastProperty){var propDataType=this.lastProperty.dataType;var isCaseSensitive=this.lastProperty.parentType.metadataStore.localQueryComparisonOptions.isCaseSensitive}var propertyPath=this.propertyPath;var isDesc=this.isDesc;return function(entity1,entity2){var value1=getPropertyPathValue(entity1,propertyPath);var value2=getPropertyPathValue(entity2,propertyPath);var dataType=propDataType||value1&&DataType.fromValue(value1)||DataType.fromValue(value2);if(dataType===DataType.String){if(isCaseSensitive){value1=value1||"";value2=value2||""}else{value1=(value1||"").toLowerCase();value2=(value2||"").toLowerCase()}}else{var normalize=getComparableFn(dataType);value1=normalize(value1);value2=normalize(value2)}if(value1===value2){return 0}else if(value1>value2||value2===undefined){return isDesc?-1:1}else{return isDesc?1:-1}}};return ctor}();var CompositeOrderByClause=function(){var ctor=function(orderByClauses){var resultClauses=[];orderByClauses.forEach(function(obc){if(obc instanceof CompositeOrderByClause){resultClauses=resultClauses.concat(obc.orderByClauses)}else if(obc instanceof SimpleOrderByClause){resultClauses.push(obc)}else{throw new Error("Invalid argument to CompositeOrderByClause ctor.")}});this._orderByClauses=resultClauses};var proto=new OrderByClause({prototype:true});ctor.prototype=proto;proto.validate=function(entityType){this._orderByClauses.forEach(function(obc){obc.validate(entityType)})};proto.toOdataFragment=function(entityType){var strings=this._orderByClauses.map(function(obc){return obc.toOdataFragment(entityType)});return strings.join(",")};proto.getComparer=function(entityType){var orderByFuncs=this._orderByClauses.map(function(obc){return obc.getComparer(entityType)});return function(entity1,entity2){for(var i=0;i<orderByFuncs.length;i++){var result=orderByFuncs[i](entity1,entity2);if(result!==0){return result}}return 0}};return ctor}();var SelectClause=function(){var ctor=function(propertyPaths){this.propertyPaths=propertyPaths;this._pathNames=propertyPaths.map(function(pp){return pp.replace(".","_")})};var proto=ctor.prototype;proto.validate=function(entityType){if(!entityType){return}this.propertyPaths.forEach(function(path){entityType.getProperty(path,true)})};proto.toOdataFragment=function(entityType){var frag=this.propertyPaths.map(function(pp){return entityType._clientPropertyPathToServer(pp)}).join(",");return frag};proto.toFunction=function(entityType){var that=this;return function(entity){var result={};that.propertyPaths.forEach(function(path,i){result[that._pathNames[i]]=getPropertyPathValue(entity,path)});return result}};return ctor}();var ExpandClause=function(){var ctor=function(propertyPaths){this.propertyPaths=propertyPaths};var proto=ctor.prototype;proto.toOdataFragment=function(entityType){var frag=this.propertyPaths.map(function(pp){return entityType._clientPropertyPathToServer(pp)}).join(",");return frag};return ctor}();function getPropertyPathValue(obj,propertyPath){var properties;if(Array.isArray(propertyPath)){properties=propertyPath}else{properties=propertyPath.split(".")}if(properties.length===1){return obj.getProperty(propertyPath)}else{var nextValue=obj;for(var i=0;i<properties.length;i++){nextValue=nextValue.getProperty(properties[i]);if(nextValue==null){break}}return nextValue}}function getComparableFn(dataType){if(dataType&&dataType.isDate){return function(value){return value&&value.getTime()}}else if(dataType===DataType.Time){return function(value){return value&&__durationToSeconds(value)}}else{return function(value){return value}}}breeze.FilterQueryOp=FilterQueryOp;breeze.Predicate=Predicate;breeze.EntityQuery=EntityQuery;breeze.FnNode=FnNode;breeze.OrderByClause=OrderByClause;var MergeStrategy=function(){var MergeStrategy=new Enum("MergeStrategy");MergeStrategy.PreserveChanges=MergeStrategy.addSymbol();MergeStrategy.OverwriteChanges=MergeStrategy.addSymbol();MergeStrategy.seal();return MergeStrategy}();var FetchStrategy=function(){var FetchStrategy=new Enum("FetchStrategy");FetchStrategy.FromServer=FetchStrategy.addSymbol();FetchStrategy.FromLocalCache=FetchStrategy.addSymbol();FetchStrategy.seal();return FetchStrategy}();var QueryOptions=function(){var ctor=function(config){updateWithConfig(this,config)};var proto=ctor.prototype;proto._$typeName="QueryOptions";ctor.resolve=function(queryOptionsArray){return new QueryOptions(__resolveProperties(queryOptionsArray,["fetchStrategy","mergeStrategy"]))};ctor.defaultInstance=new ctor({fetchStrategy:FetchStrategy.FromServer,mergeStrategy:MergeStrategy.PreserveChanges});proto.using=function(config){if(!config)return this;var result=new QueryOptions(this);if(MergeStrategy.contains(config)){config={mergeStrategy:config}}else if(FetchStrategy.contains(config)){config={fetchStrategy:config}}return updateWithConfig(result,config)};proto.setAsDefault=function(){return __setAsDefault(this,ctor)};proto.toJSON=function(){return __toJson(this,{fetchStrategy:null,mergeStrategy:null})};ctor.fromJSON=function(json){return new QueryOptions({fetchStrategy:FetchStrategy.fromName(json.fetchStrategy),mergeStrategy:MergeStrategy.fromName(json.mergeStrategy)})};function updateWithConfig(obj,config){if(config){assertConfig(config).whereParam("fetchStrategy").isEnumOf(FetchStrategy).isOptional().whereParam("mergeStrategy").isEnumOf(MergeStrategy).isOptional().applyAll(obj)}return obj}return ctor}();breeze.QueryOptions=QueryOptions;breeze.FetchStrategy=FetchStrategy;breeze.MergeStrategy=MergeStrategy;var EntityGroup=function(){var __changedFilter=getFilter([EntityState.Added,EntityState.Modified,EntityState.Deleted]);var ctor=function(entityManager,entityType){this.entityManager=entityManager;this.entityType=entityType;this._indexMap={};this._entities=[];this._emptyIndexes=[]};var proto=ctor.prototype;proto.attachEntity=function(entity,entityState){var ix;var aspect=entity.entityAspect;if(!aspect._initialized){this.entityType._initializeInstance(entity)}delete aspect._initialized;var keyInGroup=aspect.getKey()._keyInGroup;ix=this._indexMap[keyInGroup];if(ix>=0){if(this._entities[ix]===entity){aspect.entityState=entityState;return entity}throw new Error("This key is already attached: "+aspect.getKey())}if(this._emptyIndexes.length===0){ix=this._entities.push(entity)-1}else{ix=this._emptyIndexes.pop();this._entities[ix]=entity}this._indexMap[keyInGroup]=ix;aspect.entityState=entityState;aspect.entityGroup=this;aspect.entityManager=this.entityManager;return entity};proto.detachEntity=function(entity){var aspect=entity.entityAspect;var keyInGroup=aspect.getKey()._keyInGroup;var ix=this._indexMap[keyInGroup];if(ix===undefined){throw new Error("internal error - entity cannot be found in group")}delete this._indexMap[keyInGroup];this._emptyIndexes.push(ix);this._entities[ix]=null;return entity};proto.findEntityByKey=function(entityKey){var keyInGroup;if(entityKey instanceof EntityKey){keyInGroup=entityKey._keyInGroup}else{keyInGroup=EntityKey.createKeyString(entityKey)}var ix=this._indexMap[keyInGroup];return ix!==undefined?this._entities[ix]:null};proto.hasChanges=function(){return this._entities.some(__changedFilter)};proto.getEntities=function(entityStates){var filter=getFilter(entityStates);return this._entities.filter(filter)};proto._clear=function(){this._entities.forEach(function(entity){if(entity!=null){entity.entityAspect._detach()}});this._entities=null;this._indexMap=null;this._emptyIndexes=null};proto._fixupKey=function(tempValue,realValue){var ix=this._indexMap[tempValue];if(ix===undefined){throw new Error("Internal Error in key fixup - unable to locate entity")}var entity=this._entities[ix];var keyPropName=entity.entityType.keyProperties[0].name;entity.setProperty(keyPropName,realValue);delete entity.entityAspect.hasTempKey;delete this._indexMap[tempValue];this._indexMap[realValue]=ix};proto._replaceKey=function(oldKey,newKey){var ix=this._indexMap[oldKey._keyInGroup];delete this._indexMap[oldKey._keyInGroup];this._indexMap[newKey._keyInGroup]=ix};function getFilter(entityStates){if(!entityStates){return function(e){return!!e}}else if(entityStates.length===1){var entityState=entityStates[0];return function(e){if(!e)return false;return e.entityAspect.entityState===entityState}}else{return function(e){if(!e)return false;return entityStates.some(function(es){return e.entityAspect.entityState===es})}}}return ctor}();var EntityManager=function(){var ctor=function(config){if(arguments.length>1){throw new Error("The EntityManager ctor has a single optional argument that is either a 'serviceName' or a configuration object.")}if(arguments.length===0){config={serviceName:""}}else if(typeof config==="string"){config={serviceName:config}}updateWithConfig(this,config,true);this.entityChanged=new Event("entityChanged",this);this.validationErrorsChanged=new Event("validationErrorsChanged",this);this.hasChangesChanged=new Event("hasChangesChanged",this);this.clear()};var proto=ctor.prototype;proto._$typeName="EntityManager";Event.bubbleEvent(proto,null);proto.setProperties=function(config){updateWithConfig(this,config,false)};function updateWithConfig(em,config,isCtor){var defaultQueryOptions=isCtor?QueryOptions.defaultInstance:em.queryOptions;var defaultSaveOptions=isCtor?SaveOptions.defaultInstance:em.saveOptions;var defaultValidationOptions=isCtor?ValidationOptions.defaultInstance:em.validationOptions;var configParam=assertConfig(config).whereParam("serviceName").isOptional().isString().whereParam("dataService").isOptional().isInstanceOf(DataService).whereParam("queryOptions").isInstanceOf(QueryOptions).isOptional().withDefault(defaultQueryOptions).whereParam("saveOptions").isInstanceOf(SaveOptions).isOptional().withDefault(defaultSaveOptions).whereParam("validationOptions").isInstanceOf(ValidationOptions).isOptional().withDefault(defaultValidationOptions).whereParam("keyGeneratorCtor").isFunction().isOptional();
if(isCtor){configParam=configParam.whereParam("metadataStore").isInstanceOf(MetadataStore).isOptional().withDefault(new MetadataStore)}configParam.applyAll(em);__updateWithDefaults(em.queryOptions,defaultQueryOptions);__updateWithDefaults(em.saveOptions,defaultSaveOptions);__updateWithDefaults(em.validationOptions,defaultValidationOptions);if(config.serviceName){em.dataService=new DataService({serviceName:em.serviceName})}em.serviceName=em.dataService&&em.dataService.serviceName;em.keyGeneratorCtor=em.keyGeneratorCtor||KeyGenerator;if(isCtor||config.keyGeneratorCtor){em.keyGenerator=new em.keyGeneratorCtor}}proto.createEntity=function(entityType,initialValues,entityState){assertParam(entityType,"entityType").isString().or().isInstanceOf(EntityType).check();if(typeof entityType==="string"){entityType=this.metadataStore._getEntityType(entityType)}entityState=entityState||EntityState.Added;var entity;__using(this,"isLoading",true,function(){entity=entityType.createEntity(initialValues)});if(entityState!==EntityState.Detached){this.attachEntity(entity,entityState)}return entity};ctor.importEntities=function(exportedString,config){var em=new EntityManager;em.importEntities(exportedString,config);return em};proto.exportEntities=function(entities){var exportBundle=exportEntityGroups(this,entities);var json={metadataStore:this.metadataStore.exportMetadata(),dataService:this.dataService,saveOptions:this.saveOptions,queryOptions:this.queryOptions,validationOptions:this.validationOptions,tempKeys:exportBundle.tempKeys,entityGroupMap:exportBundle.entityGroupMap};var result=JSON.stringify(json,null,__config.stringifyPad);return result};proto.importEntities=function(exportedString,config){config=config||{};assertConfig(config).whereParam("mergeStrategy").isEnumOf(MergeStrategy).isOptional().withDefault(this.queryOptions.mergeStrategy).applyAll(config);var that=this;var json=typeof exportedString==="string"?JSON.parse(exportedString):exportedString;this.metadataStore.importMetadata(json.metadataStore);this.dataService=json.dataService&&DataService.fromJSON(json.dataService)||new DataService({serviceName:json.serviceName});this.saveOptions=new SaveOptions(json.saveOptions);this.queryOptions=QueryOptions.fromJSON(json.queryOptions);this.validationOptions=new ValidationOptions(json.validationOptions);var tempKeyMap={};json.tempKeys.forEach(function(k){var oldKey=EntityKey.fromJSON(k,that.metadataStore);tempKeyMap[oldKey.toString()]=new EntityKey(oldKey.entityType,that.keyGenerator.generateTempKeyValue(oldKey.entityType,oldKey.values[0]))});var entitiesToLink=[];config.tempKeyMap=tempKeyMap;__wrapExecution(function(){that._pendingPubs=[]},function(state){that._pendingPubs.forEach(function(fn){fn()});that._pendingPubs=null},function(){__objectForEach(json.entityGroupMap,function(entityTypeName,jsonGroup){var entityType=that.metadataStore._getEntityType(entityTypeName,true);var targetEntityGroup=findOrCreateEntityGroup(that,entityType);var entities=importEntityGroup(targetEntityGroup,jsonGroup,config);Array.prototype.push.apply(entitiesToLink,entities)});entitiesToLink.forEach(function(entity){that._linkRelatedEntities(entity)})});return{entities:entitiesToLink,tempKeyMapping:tempKeyMap}};proto.clear=function(){__objectForEach(this._entityGroupMap,function(key,entityGroup){entityGroup._clear()});this._entityGroupMap={};this._unattachedChildrenMap=new UnattachedChildrenMap;this.keyGenerator=new this.keyGeneratorCtor;this.entityChanged.publish({entityAction:EntityAction.Clear});if(this._hasChanges){this._hasChanges=false;this.hasChangesChanged.publish({entityManager:this,hasChanges:false})}};proto.createEmptyCopy=function(){var copy=new ctor({dataService:this.dataService,metadataStore:this.metadataStore,queryOptions:this.queryOptions,saveOptions:this.saveOptions,validationOptions:this.validationOptions,keyGeneratorCtor:this.keyGeneratorCtor});return copy};proto.addEntity=function(entity){return this.attachEntity(entity,EntityState.Added)};proto.attachEntity=function(entity,entityState){assertParam(entity,"entity").isRequired().check();this.metadataStore._checkEntityType(entity);entityState=assertParam(entityState,"entityState").isEnumOf(EntityState).isOptional().check(EntityState.Unchanged);if(entity.entityType.metadataStore!==this.metadataStore){throw new Error("Cannot attach this entity because the EntityType and MetadataStore associated with this entity does not match this EntityManager's MetadataStore.")}var aspect=entity.entityAspect;if(!aspect){aspect=new EntityAspect(entity)}var manager=aspect.entityManager;if(manager){if(manager===this){return entity}else{throw new Error("This entity already belongs to another EntityManager")}}var that=this;__using(this,"isLoading",true,function(){if(entityState.isAdded()){checkEntityKey(that,entity)}attachEntityCore(that,entity,entityState);attachRelatedEntities(that,entity,entityState)});if(this.validationOptions.validateOnAttach){entity.entityAspect.validateEntity()}if(!entityState.isUnchanged()){this._notifyStateChange(entity,true)}this.entityChanged.publish({entityAction:EntityAction.Attach,entity:entity});return entity};proto.detachEntity=function(entity){assertParam(entity,"entity").isEntity().check();var aspect=entity.entityAspect;if(!aspect){return false}if(aspect.entityManager!==this){throw new Error("This entity does not belong to this EntityManager.")}return aspect.setDetached()};proto.fetchMetadata=function(dataService,callback,errorCallback){if(typeof dataService==="function"){errorCallback=callback;callback=dataService;dataService=null}else{assertParam(dataService,"dataService").isInstanceOf(DataService).isOptional().check();assertParam(callback,"callback").isFunction().isOptional().check();assertParam(errorCallback,"errorCallback").isFunction().isOptional().check()}var promise=this.metadataStore.fetchMetadata(dataService||this.dataService);return promiseWithCallbacks(promise,callback,errorCallback)};proto.executeQuery=function(query,callback,errorCallback){assertParam(query,"query").isInstanceOf(EntityQuery).or().isString().check();assertParam(callback,"callback").isFunction().isOptional().check();assertParam(errorCallback,"errorCallback").isFunction().isOptional().check();var promise;var queryOptions=QueryOptions.resolve([query.queryOptions,this.queryOptions,QueryOptions.defaultInstance]);var dataService=DataService.resolve([query.dataService,this.dataService]);if(!dataService.hasServerMetadata||this.metadataStore.hasMetadataFor(dataService.serviceName)){promise=executeQueryCore(this,query,queryOptions,dataService)}else{var that=this;promise=this.fetchMetadata(dataService).then(function(){return executeQueryCore(that,query,queryOptions,dataService)})}return promiseWithCallbacks(promise,callback,errorCallback)};proto.executeQueryLocally=function(query){assertParam(query,"query").isInstanceOf(EntityQuery).check();var metadataStore=this.metadataStore;var entityType=query._getFromEntityType(metadataStore,true);var groups=findOrCreateEntityGroups(this,entityType);var filterFunc=query._toFilterFunction(entityType);if(filterFunc){var newFilterFunc=function(entity){return entity&&!entity.entityAspect.entityState.isDeleted()&&filterFunc(entity)}}else{var newFilterFunc=function(entity){return entity&&!entity.entityAspect.entityState.isDeleted()}}var result=[];groups.forEach(function(group){result.push.apply(result,group._entities.filter(newFilterFunc))});var orderByComparer=query._toOrderByComparer(entityType);if(orderByComparer){result.sort(orderByComparer)}var skipCount=query.skipCount;if(skipCount){result=result.slice(skipCount)}var takeCount=query.takeCount;if(takeCount){result=result.slice(0,takeCount)}var selectClause=query.selectClause;if(selectClause){var selectFn=selectClause.toFunction();result=result.map(function(e){return selectFn(e)})}return result};proto.saveChanges=function(entities,saveOptions,callback,errorCallback){assertParam(entities,"entities").isOptional().isArray().isEntity().check();assertParam(saveOptions,"saveOptions").isInstanceOf(SaveOptions).isOptional().check();assertParam(callback,"callback").isFunction().isOptional().check();assertParam(errorCallback,"errorCallback").isFunction().isOptional().check();saveOptions=saveOptions||this.saveOptions||SaveOptions.defaultInstance;var isFullSave=entities==null;var entitiesToSave=getEntitiesToSave(this,entities);if(entitiesToSave.length===0){var saveResult={entities:[],keyMappings:[]};if(callback)callback(saveResult);return Q.resolve(saveResult)}if(!saveOptions.allowConcurrentSaves){var anyPendingSaves=entitiesToSave.some(function(entity){return entity.entityAspect.isBeingSaved});if(anyPendingSaves){var err=new Error("Concurrent saves not allowed - SaveOptions.allowConcurrentSaves is false");if(errorCallback)errorCallback(err);return Q.reject(err)}}clearServerErrors(entitiesToSave);if(this.validationOptions.validateOnSave){var failedEntities=entitiesToSave.filter(function(entity){var aspect=entity.entityAspect;var isValid=aspect.entityState.isDeleted()||aspect.validateEntity();return!isValid});if(failedEntities.length>0){var valError=new Error("Client side validation errors encountered - see the entityErrors collection on this object for more detail");valError.entityErrors=createEntityErrors(failedEntities);if(errorCallback)errorCallback(valError);return Q.reject(valError)}}updateConcurrencyProperties(entitiesToSave);var dataService=DataService.resolve([saveOptions.dataService,this.dataService]);var saveContext={entityManager:this,dataService:dataService,resourceName:saveOptions.resourceName||this.saveOptions.resourceName||"SaveChanges"};var queryOptions={mergeStrategy:MergeStrategy.OverwriteChanges};var saveBundle={entities:entitiesToSave,saveOptions:saveOptions};var that=this;return dataService.adapterInstance.saveChanges(saveContext,saveBundle).then(function(saveResult){fixupKeys(that,saveResult.keyMappings);var mappingContext={query:null,entityManager:that,queryOptions:queryOptions,dataService:dataService,refMap:{},deferredFns:[]};var savedEntities=saveResult.entities.map(function(rawEntity){return visitAndMerge(rawEntity,mappingContext,{nodeType:"root"})});markIsBeingSaved(entitiesToSave,false);that._hasChanges=isFullSave&&haveSameContents(entitiesToSave,savedEntities)?false:that._hasChangesCore();if(!that._hasChanges){that.hasChangesChanged.publish({entityManager:that,hasChanges:false})}saveResult.entities=savedEntities;if(callback)callback(saveResult);return Q.resolve(saveResult)},function(error){processServerErrors(saveContext,error);markIsBeingSaved(entitiesToSave,false);if(errorCallback)errorCallback(error);return Q.reject(error)})};function clearServerErrors(entities){entities.forEach(function(entity){var serverKeys=[];var valErrors=entity.entityAspect._validationErrors;__objectForEach(valErrors,function(key,ve){if(ve.isServerError)serverKeys.push(key)});if(serverKeys.length===0)return;serverKeys.forEach(function(key){delete valErrors[key]});entity.hasValidationErrors=!__isEmpty(valErrors)})}function createEntityErrors(entities){var entityErrors=[];entities.forEach(function(entity){__objectForEach(entity.entityAspect._validationErrors,function(key,ve){entityErrors.push({entity:entity,errorName:ve.validator.name,errorMessage:ve.errorMessage,propertyName:ve.propertyName,isServerError:ve.isServerError})})});return entityErrors}function processServerErrors(saveContext,error){var serverErrors=error.entityErrors;if(!serverErrors)return;var entityManager=saveContext.entityManager;var metadataStore=entityManager.metadataStore;error.entityErrors=serverErrors.map(function(serr){var entity=null;if(serr.keyValues){var entityType=metadataStore._getEntityType(serr.entityTypeName);var ekey=new EntityKey(entityType,serr.keyValues);entity=entityManager.findEntityByKey(ekey)}if(entity){var context=serr.propertyName?{propertyName:serr.propertyName,property:entityType.getProperty(serr.propertyName)}:{};var key=ValidationError.getKey(serr.errorName||serr.errorMessage,serr.propertyName);var ve=new ValidationError(null,context,serr.errorMessage,key);ve.isServerError=true;entity.entityAspect.addValidationError(ve)}var entityError={entity:entity,errorName:serr.errorName,errorMessage:serr.errorMessage,propertyName:serr.propertyName,isServerError:true};return entityError})}function haveSameContents(arr1,arr2){if(arr1.length!==arr2.length){return false}for(var i=0,c=arr1.length;i<c;i++){if(arr1[i]!==arr2[i])return false}return true}proto._findEntityGroup=function(entityType){return this._entityGroupMap[entityType.name]};proto.getEntityByKey=function(){var entityKey=createEntityKey(this,arguments).entityKey;var group;var subtypes=entityKey._subtypes;if(subtypes){for(var i=0,j=subtypes.length;i<j;i++){group=this._findEntityGroup(subtypes[i]);var ek=group&&group.findEntityByKey(entityKey);if(ek)return ek}}else{group=this._findEntityGroup(entityKey.entityType);return group&&group.findEntityByKey(entityKey)}};proto.fetchEntityByKey=function(){var tpl=createEntityKey(this,arguments);var entityKey=tpl.entityKey;var checkLocalCacheFirst=tpl.remainingArgs.length===0?false:!!tpl.remainingArgs[0];var entity;var isDeleted=false;if(checkLocalCacheFirst){entity=this.getEntityByKey(entityKey);isDeleted=entity&&entity.entityAspect.entityState.isDeleted();if(isDeleted){entity=null;if(this.queryOptions.mergeStrategy===MergeStrategy.OverwriteChanges){isDeleted=false}}}if(entity||isDeleted){return Q.resolve({entity:entity,entityKey:entityKey,fromCache:true})}else{return EntityQuery.fromEntityKey(entityKey).using(this).execute().then(function(data){entity=data.results.length===0?null:data.results[0];return Q.resolve({entity:entity,entityKey:entityKey,fromCache:false})})}};proto.findEntityByKey=function(entityKey){return this.getEntityByKey(entityKey)};proto.generateTempKeyValue=function(entity){assertParam(entity,"entity").isEntity().check();var entityType=entity.entityType;var nextKeyValue=this.keyGenerator.generateTempKeyValue(entityType);var keyProp=entityType.keyProperties[0];entity.setProperty(keyProp.name,nextKeyValue);entity.entityAspect.hasTempKey=true;return nextKeyValue};proto.hasChanges=function(entityTypes){if(!this._hasChanges)return false;if(entityTypes===undefined)return this._hasChanges;return this._hasChangesCore(entityTypes)};proto._hasChangesCore=function(entityTypes){entityTypes=checkEntityTypes(this,entityTypes);var entityGroups=getEntityGroups(this,entityTypes);return entityGroups.some(function(eg){return eg.hasChanges()})};proto.getChanges=function(entityTypes){entityTypes=checkEntityTypes(this,entityTypes);var entityStates=[EntityState.Added,EntityState.Modified,EntityState.Deleted];return getEntitiesCore(this,entityTypes,entityStates)};proto.rejectChanges=function(){if(!this._hasChanges)return[];var entityStates=[EntityState.Added,EntityState.Modified,EntityState.Deleted];var changes=getEntitiesCore(this,null,entityStates);this._hasChanges=false;changes.forEach(function(e){e.entityAspect.rejectChanges()});this.hasChangesChanged.publish({entityManager:this,hasChanges:false});return changes};proto.getEntities=function(entityTypes,entityStates){entityTypes=checkEntityTypes(this,entityTypes);assertParam(entityStates,"entityStates").isOptional().isEnumOf(EntityState).or().isNonEmptyArray().isEnumOf(EntityState).check();if(entityStates){entityStates=validateEntityStates(this,entityStates)}return getEntitiesCore(this,entityTypes,entityStates)};proto._notifyStateChange=function(entity,needsSave){this.entityChanged.publish({entityAction:EntityAction.EntityStateChange,entity:entity});if(needsSave){if(!this._hasChanges){this._hasChanges=true;this.hasChangesChanged.publish({entityManager:this,hasChanges:true})}}else{if(this._hasChanges){this._hasChanges=this._hasChangesCore();if(!this._hasChanges){this.hasChangesChanged.publish({entityManager:this,hasChanges:false})}}}};proto._linkRelatedEntities=function(entity){var em=this;var entityAspect=entity.entityAspect;__using(em,"isLoading",true,function(){var unattachedMap=em._unattachedChildrenMap;var entityKey=entityAspect.getKey();var tuples=unattachedMap.getTuples(entityKey);if(tuples){tuples.forEach(function(tpl){var unattachedChildren=tpl.children.filter(function(e){return e.entityAspect.entityState!==EntityState.Detached});var childToParentNp,parentToChildNp;var np=tpl.navigationProperty;if(np.inverse){childToParentNp=np;parentToChildNp=np.inverse;if(parentToChildNp.isScalar){var onlyChild=unattachedChildren[0];entity.setProperty(parentToChildNp.name,onlyChild);onlyChild.setProperty(childToParentNp.name,entity)}else{var currentChildren=entity.getProperty(parentToChildNp.name);unattachedChildren.forEach(function(child){currentChildren.push(child);child.setProperty(childToParentNp.name,entity)})}}else{if(np.parentType===entity.entityType){parentToChildNp=np;if(parentToChildNp.isScalar){entity.setProperty(parentToChildNp.name,unattachedChildren[0])}else{var currentChildren=entity.getProperty(parentToChildNp.name);unattachedChildren.forEach(function(child){currentChildren._push(child)})}}else{childToParentNp=np;unattachedChildren.forEach(function(child){child.setProperty(childToParentNp.name,entity)})}}unattachedMap.removeChildren(entityKey,childToParentNp)})}entity.entityType.navigationProperties.forEach(function(np){if(np.isScalar){var value=entity.getProperty(np.name);if(value)return}var parentKey=entityAspect.getParentKey(np);if(parentKey){if(parentKey._isEmpty())return;var parent=em.findEntityByKey(parentKey);if(parent){entity.setProperty(np.name,parent)}else{unattachedMap.addChild(parentKey,np,entity)}}});entity.entityType.foreignKeyProperties.forEach(function(fkProp){var invNp=fkProp.inverseNavigationProperty;if(!invNp)return;var fkValue=entity.getProperty(fkProp.name);var parentKey=new EntityKey(invNp.parentType,[fkValue]);var parent=em.findEntityByKey(parentKey);if(parent){if(invNp.isScalar){parent.setProperty(invNp.name,entity)}else{if(em.isLoading){parent.getProperty(invNp.name)._push(entity)}else{parent.getProperty(invNp.name).push(entity)}}}else{unattachedMap.addChild(parentKey,invNp,entity)}})})};function checkEntityTypes(em,entityTypes){assertParam(entityTypes,"entityTypes").isString().isOptional().or().isNonEmptyArray().isString().or().isInstanceOf(EntityType).or().isNonEmptyArray().isInstanceOf(EntityType).check();if(typeof entityTypes==="string"){entityTypes=em.metadataStore._getEntityType(entityTypes,false)}else if(Array.isArray(entityTypes)&&typeof entityTypes[0]==="string"){entityTypes=entityTypes.map(function(etName){return em.metadataStore._getEntityType(etName,false)})}return entityTypes}function getEntitiesCore(em,entityTypes,entityStates){var entityGroups=getEntityGroups(em,entityTypes);var selected;entityGroups.forEach(function(eg){if(!eg)return;var entities=eg.getEntities(entityStates);if(!selected){selected=entities}else{selected.push.apply(selected,entities)}});return selected||[]}function createEntityKey(em,args){if(args[0]instanceof EntityKey){return{entityKey:args[0],remainingArgs:__arraySlice(args,1)}}else if(typeof args[0]==="string"&&args.length>=2){var entityType=em.metadataStore._getEntityType(args[0],false);return{entityKey:new EntityKey(entityType,args[1]),remainingArgs:__arraySlice(args,2)}}else{throw new Error("This method requires as its initial parameters either an EntityKey or an entityType name followed by a value or an array of values.")}}function markIsBeingSaved(entities,flag){entities.forEach(function(entity){entity.entityAspect.isBeingSaved=flag})}function exportEntityGroups(em,entities){var entityGroupMap;if(entities){entityGroupMap={};entities.forEach(function(e){var group=entityGroupMap[e.entityType.name];if(!group){group={};group.entityType=e.entityType;group._entities=[];entityGroupMap[e.entityType.name]=group}group._entities.push(e)})}else{entityGroupMap=em._entityGroupMap}var tempKeys=[];var newGroupMap={};__objectForEach(entityGroupMap,function(entityTypeName,entityGroup){newGroupMap[entityTypeName]=exportEntityGroup(entityGroup,tempKeys)});return{entityGroupMap:newGroupMap,tempKeys:tempKeys}}function exportEntityGroup(entityGroup,tempKeys){var resultGroup={};var entityType=entityGroup.entityType;var dps=entityType.dataProperties;var rawEntities=[];entityGroup._entities.forEach(function(entity){if(entity){var rawEntity=structuralObjectToJson(entity,dps,tempKeys);rawEntities.push(rawEntity)}});resultGroup.entities=rawEntities;return resultGroup}function structuralObjectToJson(so,dps,tempKeys){var result={};dps.forEach(function(dp){var dpName=dp.name;var value=so.getProperty(dpName);if(value==null&&dp.defaultValue==null)return;if(value&&value.complexType){var newValue;var coDps=dp.dataType.dataProperties;if(Array.isArray(value)){if(value.length==0){result[dpName]=[]}else{result[dpName]=value.map(function(v){return structuralObjectToJson(v,coDps)})}}else{result[dpName]=structuralObjectToJson(value,coDps)}}else{result[dpName]=value}});var aspect,newAspect;if(so.entityAspect){aspect=so.entityAspect;var entityState=aspect.entityState;newAspect={tempNavPropNames:exportTempKeyInfo(aspect,tempKeys),entityState:entityState.name};if(entityState.isModified()||entityState.isDeleted()){newAspect.originalValuesMap=aspect.originalValues}result.entityAspect=newAspect}else{aspect=so.complexAspect;newAspect={};if(aspect.originalValues&&!__isEmpty(aspect.originalValues)){newAspect.originalValuesMap=aspect.originalValues}result.complexAspect=newAspect}return result}function exportTempKeyInfo(entityAspect,tempKeys){var entity=entityAspect.entity;if(entityAspect.hasTempKey){tempKeys.push(entityAspect.getKey().toJSON())}var tempNavPropNames;entity.entityType.navigationProperties.forEach(function(np){if(np.relatedDataProperties){var relatedValue=entity.getProperty(np.name);if(relatedValue&&relatedValue.entityAspect.hasTempKey){tempNavPropNames=tempNavPropNames||[];tempNavPropNames.push(np.name)}}});return tempNavPropNames}function importEntityGroup(entityGroup,jsonGroup,config){var tempKeyMap=config.tempKeyMap;var entityType=entityGroup.entityType;var shouldOverwrite=config.mergeStrategy===MergeStrategy.OverwriteChanges;var targetEntity=null;var dataProps=entityType.dataProperties;var keyProps=entityType.keyProperties;var em=entityGroup.entityManager;var entityChanged=em.entityChanged;var entitiesToLink=[];jsonGroup.entities.forEach(function(rawEntity){var newAspect=rawEntity.entityAspect;var entityKey=getEntityKeyFromRawEntity(rawEntity,entityType,true);var entityState=EntityState.fromName(newAspect.entityState);var newTempKey;if(entityState.isAdded()){newTempKey=tempKeyMap[entityKey.toString()];targetEntity=newTempKey===undefined?entityGroup.findEntityByKey(entityKey):null}else{targetEntity=entityGroup.findEntityByKey(entityKey)}if(targetEntity){var wasUnchanged=targetEntity.entityAspect.entityState.isUnchanged();if(shouldOverwrite||wasUnchanged){updateTargetFromRaw(targetEntity,rawEntity,dataProps,true);entityChanged.publish({entityAction:EntityAction.MergeOnImport,entity:targetEntity});if(wasUnchanged){if(!entityState.isUnchanged()){em._notifyStateChange(targetEntity,true)}}else{if(entityState.isUnchanged()){em._notifyStateChange(targetEntity,false)}}}else{entitiesToLink.push(targetEntity);targetEntity=null}}else{targetEntity=entityType._createInstanceCore();updateTargetFromRaw(targetEntity,rawEntity,dataProps,true);if(newTempKey!==undefined){targetEntity.setProperty(entityType.keyProperties[0].name,newTempKey.values[0]);if(newAspect.tempNavPropNames){newAspect.tempNavPropNames.forEach(function(npName){var np=entityType.getNavigationProperty(npName);var fkPropName=np.relatedDataProperties[0].name;var oldFkValue=targetEntity.getProperty(fkPropName);var fk=new EntityKey(np.entityType,[oldFkValue]);var newFk=tempKeyMap[fk.toString()];targetEntity.setProperty(fkPropName,newFk.values[0])})}}targetEntity=entityGroup.attachEntity(targetEntity,entityState);if(entityChanged){entityChanged.publish({entityAction:EntityAction.AttachOnImport,entity:targetEntity});if(!entityState.isUnchanged()){em._notifyStateChange(targetEntity,true)}}}if(targetEntity){targetEntity.entityAspect.entityState=entityState;if(entityState.isModified()){targetEntity.entityAspect.originalValuesMap=newAspect.originalValues}entitiesToLink.push(targetEntity)}});return entitiesToLink}function promiseWithCallbacks(promise,callback,errorCallback){promise=promise.then(function(data){if(callback)callback(data);return Q.resolve(data)}).fail(function(error){if(errorCallback)errorCallback(error);return Q.reject(error)});return promise}function getEntitiesToSave(em,entities){var entitiesToSave;if(entities){entitiesToSave=entities.filter(function(e){if(e.entityAspect.entityManager!==em){throw new Error("Only entities in this entityManager may be saved")}return!e.entityAspect.entityState.isDetached()})}else{entitiesToSave=em.getChanges()}return entitiesToSave}function fixupKeys(em,keyMappings){em._inKeyFixup=true;keyMappings.forEach(function(km){var group=em._entityGroupMap[km.entityTypeName];if(!group){throw new Error("Unable to locate the following fully qualified EntityType name: "+km.entityTypeName)}group._fixupKey(km.tempValue,km.realValue)});em._inKeyFixup=false}function getEntityGroups(em,entityTypes){var groupMap=em._entityGroupMap;if(entityTypes){if(entityTypes instanceof EntityType){return[groupMap[entityTypes.name]]}else if(Array.isArray(entityTypes)){return entityTypes.map(function(et){if(et instanceof EntityType){return groupMap[et.name]}else{throw createError()}})}else{throw createError()}}else{return __getOwnPropertyValues(groupMap)}function createError(){return new Error("The EntityManager.getChanges() 'entityTypes' parameter must be either an entityType or an array of entityTypes or null")}}function checkEntityKey(em,entity){var ek=entity.entityAspect.getKey();var keyPropsWithDefaultValues=__arrayZip(entity.entityType.keyProperties,ek.values,function(kp,kv){return kp.defaultValue===kv?kp:null}).filter(function(kp){return kp!==null});if(keyPropsWithDefaultValues.length){if(entity.entityType.autoGeneratedKeyType!==AutoGeneratedKeyType.None){em.generateTempKeyValue(entity)}else{if(keyPropsWithDefaultValues.length===ek.values.length){throw new Error("Cannot attach an object to an EntityManager without first setting its key or setting its entityType 'AutoGeneratedKeyType' property to something other than 'None'")}}}}function validateEntityStates(em,entityStates){if(!entityStates)return null;if(EntityState.contains(entityStates)){entityStates=[entityStates]}else if(Array.isArray(entityStates)){entityStates.forEach(function(es){if(!EntityState.contains(es)){throw createError()}})}else{throw createError()}return entityStates;function createError(){return new Error("The EntityManager.getChanges() 'entityStates' parameter must either be null, an entityState or an array of entityStates")}}function attachEntityCore(em,entity,entityState){var group=findOrCreateEntityGroup(em,entity.entityType);group.attachEntity(entity,entityState);em._linkRelatedEntities(entity)}function attachRelatedEntities(em,entity,entityState){var navProps=entity.entityType.navigationProperties;navProps.forEach(function(np){var related=entity.getProperty(np.name);if(np.isScalar){if(!related)return;em.attachEntity(related,entityState)}else{related.forEach(function(e){em.attachEntity(e,entityState)})}})}function executeQueryCore(em,query,queryOptions,dataService){try{var metadataStore=em.metadataStore;if(metadataStore.isEmpty()&&dataService.hasServerMetadata){throw new Error("cannot execute _executeQueryCore until metadataStore is populated.")}if(queryOptions.fetchStrategy===FetchStrategy.FromLocalCache){return Q.fcall(function(){var results=em.executeQueryLocally(query);return{results:results,query:query}})}var url=dataService.makeUrl(metadataStore.toQueryString(query));var mappingContext={url:url,query:query,entityManager:em,dataService:dataService,queryOptions:queryOptions,refMap:{},deferredFns:[]};var validateOnQuery=em.validationOptions.validateOnQuery;return dataService.adapterInstance.executeQuery(mappingContext).then(function(data){var result=__wrapExecution(function(){var state={isLoading:em.isLoading};em.isLoading=true;em._pendingPubs=[];return state},function(state){em.isLoading=state.isLoading;em._pendingPubs.forEach(function(fn){fn()});em._pendingPubs=null;query=null;mappingContext=null;if(state.error){Q.reject(state.error)}},function(){var nodes=dataService.jsonResultsAdapter.extractResults(data);if(!Array.isArray(nodes)){nodes=nodes==null?[]:[nodes]}var results=nodes.map(function(node){var r=visitAndMerge(node,mappingContext,{nodeType:"root"});if(validateOnQuery&&r.entityAspect){r.entityAspect.validateEntity()}return r});if(mappingContext.deferredFns.length>0){mappingContext.deferredFns.forEach(function(fn){fn()})}return{results:results,query:query,entityManager:em,XHR:data.XHR,inlineCount:data.inlineCount}});return Q.resolve(result)}).fail(function(e){if(e){e.query=query;e.entityManager=em}return Q.reject(e)})}catch(e){if(e){e.query=query}return Q.reject(e)}}function visitAndMerge(node,mappingContext,nodeContext){if(mappingContext.query==null&&node.entityAspect){if(node.entityAspect.entityState.isDeleted()){mappingContext.entityManager.detachEntity(node)}else{node.entityAspect.acceptChanges()}return node}nodeContext=nodeContext||{};var meta=mappingContext.dataService.jsonResultsAdapter.visitNode(node,mappingContext,nodeContext)||{};if(mappingContext.query&&nodeContext.nodeType==="root"&&!meta.entityType){meta.entityType=mappingContext.query._getToEntityType&&mappingContext.query._getToEntityType(mappingContext.entityManager.metadataStore)}return processMeta(node,mappingContext,meta)}function processMeta(node,mappingContext,meta,assignFn){if(meta.ignore||node==null){return null}else if(meta.nodeRefId){var refValue=resolveRefEntity(meta.nodeRefId,mappingContext);if(typeof refValue==="function"){mappingContext.deferredFns.push(function(){assignFn(refValue)});return undefined}return refValue}else if(meta.entityType){if(meta.entityType.isComplexType){return node}else{return mergeEntity(node,mappingContext,meta)}}else{if(meta.nodeId){mappingContext.refMap[meta.nodeId]=node}if(typeof node==="object"&&!__isDate(node)){return processAnonType(node,mappingContext)}else{return node}}}function resolveRefEntity(nodeRefId,mappingContext){var entity=mappingContext.refMap[nodeRefId];if(entity===undefined){return function(){return mappingContext.refMap[nodeRefId]}}else{return entity}}function mergeEntity(node,mappingContext,meta){node._$meta=meta;var em=mappingContext.entityManager;var entityType=meta.entityType;if(typeof entityType==="string"){entityType=em.metadataStore._getEntityType(entityType,false)}node.entityType=entityType;var mergeStrategy=mappingContext.queryOptions.mergeStrategy;var isSaving=mappingContext.query==null;var entityKey=getEntityKeyFromRawEntity(node,entityType,false);var targetEntity=em.findEntityByKey(entityKey);if(targetEntity){if(isSaving&&targetEntity.entityAspect.entityState.isDeleted()){em.detachEntity(targetEntity);return targetEntity}var targetEntityState=targetEntity.entityAspect.entityState;if(mergeStrategy===MergeStrategy.OverwriteChanges||targetEntityState.isUnchanged()){updateEntity(targetEntity,node,mappingContext);targetEntity.entityAspect.wasLoaded=true;if(meta.extra){targetEntity.entityAspect.extraMetadata=meta.extra}targetEntity.entityAspect.entityState=EntityState.Unchanged;targetEntity.entityAspect.originalValues={};targetEntity.entityAspect.propertyChanged.publish({entity:targetEntity,propertyName:null});var action=isSaving?EntityAction.MergeOnSave:EntityAction.MergeOnQuery;em.entityChanged.publish({entityAction:action,entity:targetEntity});if(!targetEntityState.isUnchanged){em._notifyStateChange(targetEntity,false)}}else{updateEntityRef(mappingContext,targetEntity,node);entityType.navigationProperties.forEach(function(np){if(np.isScalar){mergeRelatedEntityCore(node,np,mappingContext)}else{mergeRelatedEntitiesCore(node,np,mappingContext)}})}}else{targetEntity=entityType._createInstanceCore();
if(targetEntity.initializeFrom){targetEntity.initializeFrom(node)}updateEntity(targetEntity,node,mappingContext);if(meta.extra){targetEntity.entityAspect.extraMetadata=meta.extra}attachEntityCore(em,targetEntity,EntityState.Unchanged);targetEntity.entityAspect.wasLoaded=true;em.entityChanged.publish({entityAction:EntityAction.AttachOnQuery,entity:targetEntity})}return targetEntity}function processAnonType(node,mappingContext){var em=mappingContext.entityManager;var jsonResultsAdapter=mappingContext.dataService.jsonResultsAdapter;var keyFn=em.metadataStore.namingConvention.serverPropertyNameToClient;var result={};__objectForEach(node,function(key,value){var meta=jsonResultsAdapter.visitNode(value,mappingContext,{nodeType:"anonProp",propertyName:key})||{};if(meta.ignore)return;var newKey=keyFn(key);if(Array.isArray(value)){result[newKey]=value.map(function(v,ix){meta=jsonResultsAdapter.visitNode(v,mappingContext,{nodeType:"anonPropItem",propertyName:key})||{};return processMeta(v,mappingContext,meta,function(refValue){result[newKey][ix]=refValue()})})}else{result[newKey]=processMeta(value,mappingContext,meta,function(refValue){result[newKey]=refValue()})}});return result}function updateEntity(targetEntity,rawEntity,mappingContext){updateEntityRef(mappingContext,targetEntity,rawEntity);var entityType=targetEntity.entityType;updateTargetFromRaw(targetEntity,rawEntity,entityType.dataProperties,false);entityType.navigationProperties.forEach(function(np){if(np.isScalar){mergeRelatedEntity(np,targetEntity,rawEntity,mappingContext)}else{mergeRelatedEntities(np,targetEntity,rawEntity,mappingContext)}})}function updateTargetFromRaw(target,raw,dataProps,isClient){dataProps.forEach(function(dp){updateTargetPropertyFromRaw(target,raw,dp,isClient)});if(isClient){var aspectName=target.entityAspect?"entityAspect":"complexAspect";var originalValues=raw[aspectName].originalValuesMap;if(originalValues){target[aspectName].originalValues=originalValues}}}function updateTargetPropertyFromRaw(target,raw,dp,isClient){var fn=isClient?getPropertyFromClientRaw:getPropertyFromServerRaw;var rawVal=fn(raw,dp);if(rawVal===undefined)return;var oldVal;if(dp.isComplexProperty){oldVal=target.getProperty(dp.name);var complexType=dp.dataType;var cdataProps=complexType.dataProperties;if(dp.isScalar){updateTargetFromRaw(oldVal,rawVal,cdataProps,isClient)}else{oldVal.length=0;if(Array.isArray(rawVal)){rawVal.forEach(function(rawCo){var newCo=complexType._createInstanceCore(target,dp);updateTargetFromRaw(newCo,rawCo,cdataProps,isClient);complexType._initializeInstance(newCo);oldVal.push(newCo)})}}}else{var val;if(dp.isScalar){val=parseRawValue(dp,rawVal);target.setProperty(dp.name,val)}else{oldVal=target.getProperty(dp.name);oldVal.length=0;if(Array.isArray(rawVal)){rawVal.forEach(function(rv){val=parseRawValue(dp,rv);oldVal.push(val)})}}}}function getEntityKeyFromRawEntity(rawEntity,entityType,isClient){var fn=isClient?getPropertyFromClientRaw:getPropertyFromServerRaw;var keyValues=entityType.keyProperties.map(function(dp){return parseRawValue(dp,fn(rawEntity,dp))});return new EntityKey(entityType,keyValues)}function getPropertyFromClientRaw(rawEntity,dp){var val=rawEntity[dp.name];return val!==undefined?val:dp.defaultValue}function getPropertyFromServerRaw(rawEntity,dp){if(dp.isUnmapped){return rawEntity[dp.nameOnServer||dp.name]}else{var val=rawEntity[dp.nameOnServer];return val!==undefined?val:dp.defaultValue}}function parseRawValue(dp,val){if(val===undefined)return undefined;if(dp.dataType.isDate&&val){if(!__isDate(val)){val=DataType.parseDateFromServer(val)}}else if(dp.dataType===DataType.Binary){if(val&&val.$value!==undefined){val=val.$value}}return val}function updateEntityRef(mappingContext,targetEntity,rawEntity){var nodeId=rawEntity._$meta.nodeId;if(nodeId!=null){mappingContext.refMap[nodeId]=targetEntity}}function mergeRelatedEntity(navigationProperty,targetEntity,rawEntity,mappingContext){var relatedEntity=mergeRelatedEntityCore(rawEntity,navigationProperty,mappingContext);if(relatedEntity==null)return;if(typeof relatedEntity==="function"){mappingContext.deferredFns.push(function(){relatedEntity=relatedEntity();updateRelatedEntity(relatedEntity,targetEntity,navigationProperty)})}else{updateRelatedEntity(relatedEntity,targetEntity,navigationProperty)}}function mergeRelatedEntityCore(rawEntity,navigationProperty,mappingContext){var relatedRawEntity=rawEntity[navigationProperty.nameOnServer];if(!relatedRawEntity)return null;var relatedEntity=visitAndMerge(relatedRawEntity,mappingContext,{nodeType:"navProp",navigationProperty:navigationProperty});return relatedEntity}function updateRelatedEntity(relatedEntity,targetEntity,navigationProperty){if(!relatedEntity)return;var propName=navigationProperty.name;var currentRelatedEntity=targetEntity.getProperty(propName);if(currentRelatedEntity!==relatedEntity){targetEntity.setProperty(propName,relatedEntity);var inverseProperty=navigationProperty.inverse;if(!inverseProperty)return;if(inverseProperty.isScalar){relatedEntity.setProperty(inverseProperty.name,targetEntity)}else{var collection=relatedEntity.getProperty(inverseProperty.name);collection.push(targetEntity)}}}function mergeRelatedEntities(navigationProperty,targetEntity,rawEntity,mappingContext){var relatedEntities=mergeRelatedEntitiesCore(rawEntity,navigationProperty,mappingContext);if(relatedEntities==null)return;var inverseProperty=navigationProperty.inverse;if(!inverseProperty)return;var originalRelatedEntities=targetEntity.getProperty(navigationProperty.name);originalRelatedEntities.wasLoaded=true;relatedEntities.forEach(function(relatedEntity){if(typeof relatedEntity==="function"){mappingContext.deferredFns.push(function(){relatedEntity=relatedEntity();updateRelatedEntityInCollection(relatedEntity,originalRelatedEntities,targetEntity,inverseProperty)})}else{updateRelatedEntityInCollection(relatedEntity,originalRelatedEntities,targetEntity,inverseProperty)}})}function mergeRelatedEntitiesCore(rawEntity,navigationProperty,mappingContext){var relatedRawEntities=rawEntity[navigationProperty.nameOnServer];if(!relatedRawEntities)return null;if(!Array.isArray(relatedRawEntities))return null;var relatedEntities=relatedRawEntities.map(function(relatedRawEntity){return visitAndMerge(relatedRawEntity,mappingContext,{nodeType:"navPropItem",navigationProperty:navigationProperty})});return relatedEntities}function updateRelatedEntityInCollection(relatedEntity,relatedEntities,targetEntity,inverseProperty){if(!relatedEntity)return;var thisEntity=relatedEntity.getProperty(inverseProperty.name);if(thisEntity!==targetEntity){relatedEntities.push(relatedEntity);relatedEntity.setProperty(inverseProperty.name,targetEntity)}}function updateConcurrencyProperties(entities){var candidates=entities.filter(function(e){e.entityAspect.isBeingSaved=true;return e.entityAspect.entityState.isModified()&&e.entityType.concurrencyProperties.length>0});if(candidates.length===0)return;candidates.forEach(function(c){c.entityType.concurrencyProperties.forEach(function(cp){updateConcurrencyProperty(c,cp)})})}function updateConcurrencyProperty(entity,property){if(entity.entityAspect.originalValues[property.name])return;var value=entity.getProperty(property.name);if(!value)value=property.dataType.defaultValue;if(property.dataType.isNumeric){entity.setProperty(property.name,value+1)}else if(property.dataType.isDate){var dt=new Date;var dt2=new Date;while(dt.getTime()===dt2.getTime()){dt2=new Date}entity.setProperty(property.name,dt2)}else if(property.dataType===DataType.Guid){entity.setProperty(property.name,__getUuid())}else if(property.dataType===DataType.Binary){return}else{throw new Error("Unable to update the value of concurrency property before saving: "+property.name)}}function findOrCreateEntityGroup(em,entityType){var group=em._entityGroupMap[entityType.name];if(!group){group=new EntityGroup(em,entityType);em._entityGroupMap[entityType.name]=group}return group}function findOrCreateEntityGroups(em,entityType){var entityTypes=entityType.getSelfAndSubtypes();return entityTypes.map(function(et){return findOrCreateEntityGroup(em,et)})}proto.helper={unwrapInstance:unwrapInstance,unwrapOriginalValues:unwrapOriginalValues,unwrapChangedValues:unwrapChangedValues,getEntityKeyFromRawEntity:getEntityKeyFromRawEntity};function unwrapInstance(structObj,isOData){var rawObject={};var stype=structObj.entityType||structObj.complexType;stype.dataProperties.forEach(function(dp){if(dp.isUnmapped){if(isOData)return;var val=structObj.getProperty(dp.name);val=transformValue(val,dp,false);if(val!==undefined){rawObject.__unmapped=rawObject.__unmapped||{};rawObject.__unmapped[dp.name]=val}}else if(dp.isComplexProperty){if(dp.isScalar){rawObject[dp.nameOnServer]=unwrapInstance(structObj.getProperty(dp.name),isOData)}else{var complexObjs=structObj.getProperty(dp.name);rawObject[dp.nameOnServer]=complexObjs.map(function(co){return unwrapInstance(co,isOData)})}}else{var val=structObj.getProperty(dp.name);val=transformValue(val,dp,isOData);if(val!==undefined){rawObject[dp.nameOnServer]=val}}});return rawObject}function unwrapOriginalValues(target,metadataStore,isOData){var stype=target.entityType||target.complexType;var aspect=target.entityAspect||target.complexAspect;var fn=metadataStore.namingConvention.clientPropertyNameToServer;var result={};__objectForEach(aspect.originalValues,function(propName,val){var prop=stype.getProperty(propName);val=transformValue(val,prop,isOData);if(val!==undefined){result[fn(propName,prop)]=val}});stype.complexProperties.forEach(function(cp){var nextTarget=target.getProperty(cp.name);if(cp.isScalar){var unwrappedCo=unwrapOriginalValues(nextTarget,metadataStore,isOData);if(!__isEmpty(unwrappedCo)){result[fn(cp.name,cp)]=unwrappedCo}}else{var unwrappedCos=nextTarget.map(function(item){return unwrapOriginalValues(item,metadataStore,isOData)});result[fn(cp.name,cp)]=unwrappedCos}});return result}function unwrapChangedValues(target,metadataStore,isOData){var stype=target.entityType||target.complexType;var aspect=target.entityAspect||target.complexAspect;var fn=metadataStore.namingConvention.clientPropertyNameToServer;var result={};__objectForEach(aspect.originalValues,function(propName,value){var prop=stype.getProperty(propName);var val=target.getProperty(propName);val=transformValue(val,prop,isOData);if(val!==undefined){result[fn(propName,prop)]=val}});stype.complexProperties.forEach(function(cp){var nextTarget=target.getProperty(cp.name);if(cp.isScalar){var unwrappedCo=unwrapChangedValues(nextTarget,metadataStore);if(!__isEmpty(unwrappedCo)){result[fn(cp.name,cp)]=unwrappedCo}}else{var unwrappedCos=nextTarget.map(function(item){return unwrapChangedValues(item,metadataStore)});result[fn(cp.name,cp)]=unwrappedCos}});return result}function transformValue(val,prop,isOData){if(isOData){if(prop.isUnmapped)return;if(prop.dataType===DataType.DateTimeOffset){val=val&&new Date(val.getTime()-val.getTimezoneOffset()*6e4)}else if(prop.dataType.quoteJsonOData){val=val!=null?val.toString():val}}return val}function UnattachedChildrenMap(){this.map={}}UnattachedChildrenMap.prototype.addChild=function(parentEntityKey,navigationProperty,child){var tuple=this.getTuple(parentEntityKey,navigationProperty);if(!tuple){tuple={navigationProperty:navigationProperty,children:[]};__getArray(this.map,parentEntityKey.toString()).push(tuple)}tuple.children.push(child)};UnattachedChildrenMap.prototype.removeChildren=function(parentEntityKey,navigationProperty){var tuples=this.map[parentEntityKey.toString()];if(!tuples)return;__arrayRemoveItem(tuples,function(t){return t.navigationProperty===navigationProperty});if(!tuples.length){delete this.map[parentEntityKey.toString()]}};UnattachedChildrenMap.prototype.getChildren=function(parentEntityKey,navigationProperty){var tuple=this.getTuple(parentEntityKey,navigationProperty);if(tuple){return tuple.children.filter(function(child){return!child.entityAspect.entityState.isDetached()})}else{return null}};UnattachedChildrenMap.prototype.getTuple=function(parentEntityKey,navigationProperty){var tuples=this.map[parentEntityKey.toString()];if(!tuples)return null;var tuple=__arrayFirst(tuples,function(t){return t.navigationProperty===navigationProperty});return tuple};UnattachedChildrenMap.prototype.getTuples=function(parentEntityKey){return this.map[parentEntityKey.toString()]};return ctor}();breeze.EntityManager=EntityManager;var SaveOptions=function(){var ctor=function(config){updateWithConfig(this,config)};var proto=ctor.prototype;proto._$typeName="SaveOptions";proto.setAsDefault=function(){return __setAsDefault(this,ctor)};proto.using=function(config){return updateWithConfig(this,config)};function updateWithConfig(obj,config){if(config){assertConfig(config).whereParam("resourceName").isOptional().isString().whereParam("dataService").isOptional().isInstanceOf(DataService).whereParam("allowConcurrentSaves").isBoolean().isOptional().whereParam("tag").isOptional().applyAll(obj)}return obj}ctor.defaultInstance=new ctor({allowConcurrentSaves:false});return ctor}();breeze.SaveOptions=SaveOptions;breeze.AbstractDataServiceAdapter=function(){var ajaxImpl;var ctor=function(){};ctor.prototype.checkForRecomposition=function(interfaceInitializedArgs){if(interfaceInitializedArgs.interfaceName==="ajax"&&interfaceInitializedArgs.isDefault){this.initialize()}};ctor.prototype.initialize=function(){ajaxImpl=breeze.config.getAdapterInstance("ajax");if(!ajaxImpl){throw new Error("Unable to initialize ajax for WebApi.")}var ajax=ajaxImpl.ajax;if(!ajax){throw new Error("Breeze was unable to find an 'ajax' adapter")}};ctor.prototype.fetchMetadata=function(metadataStore,dataService){var serviceName=dataService.serviceName;var url=dataService.makeUrl("Metadata");var deferred=Q.defer();var that=this;ajaxImpl.ajax({url:url,dataType:"json",success:function(data,textStatus,XHR){var error;if(metadataStore.hasMetadataFor(serviceName)){return deferred.resolve("already fetched")}var metadata=typeof data==="string"?JSON.parse(data):data;if(metadata){try{metadataStore.importMetadata(metadata)}catch(e){error=new Error("Metadata import failed for "+url+"; Unable to process returned metadata:"+e.message)}}else{error=new Error("Metadata query failed for: "+url)}if(error){return deferred.reject(error)}if(!metadataStore.hasMetadataFor(serviceName)){metadataStore.addDataService(dataService)}XHR.onreadystatechange=null;XHR.abort=null;deferred.resolve(metadata)},error:function(XHR,textStatus,errorThrown){that._handleXHRError(deferred,XHR,"Metadata query failed for: "+url)}});return deferred.promise};ctor.prototype.executeQuery=function(mappingContext){var deferred=Q.defer();var that=this;var params={url:mappingContext.url,data:mappingContext.query.parameters,dataType:"json",success:function(data,textStatus,XHR){try{var rData;if(data&&data.Results){rData={results:data.Results,inlineCount:data.InlineCount,XHR:XHR}}else{rData={results:data,XHR:XHR}}deferred.resolve(rData);XHR.onreadystatechange=null;XHR.abort=null}catch(e){var error=e instanceof Error?e:that._createError(XHR);deferred.reject(error);XHR.onreadystatechange=null;XHR.abort=null}},error:function(XHR,textStatus,errorThrown){that._handleXHRError(deferred,XHR)}};if(mappingContext.dataService.useJsonp){params.dataType="jsonp";params.crossDomain=true}ajaxImpl.ajax(params);return deferred.promise};ctor.prototype.saveChanges=function(saveContext,saveBundle){var deferred=Q.defer();saveBundle=this._prepareSaveBundle(saveBundle,saveContext);var bundle=JSON.stringify(saveBundle);var url=saveContext.dataService.makeUrl(saveContext.resourceName);var that=this;ajaxImpl.ajax({url:url,type:"POST",dataType:"json",contentType:"application/json",data:bundle,success:function(data,textStatus,XHR){var entityErrors=data.Errors||data.errors;if(entityErrors){var err=prepareServerErrors(saveContext,entityErrors);deferred.reject(err)}else{var saveResult=that._prepareSaveResult(saveContext,data);deferred.resolve(saveResult)}},error:function(XHR,textStatus,errorThrown){var entityErrors=extractErrors(XHR);if(entityErrors){var err=prepareServerErrors(saveContext,entityErrors);deferred.reject(err)}else{that._handleXHRError(deferred,XHR)}}});return deferred.promise};function extractErrors(XHR){if(!XHR.responseText)return null;var responseObj=JSON.parse(XHR.responseText);return responseObj&&responseObj.EntityErrors}function prepareServerErrors(saveContext,entityErrors){var err=new Error;err.message="Server side errors encountered - see the entityErrors collection on this object for more detail";var propNameFn=saveContext.entityManager.metadataStore.namingConvention.serverPropertyNameToClient;err.entityErrors=entityErrors.map(function(e){return{errorName:e.ErrorName,entityTypeName:MetadataStore.normalizeTypeName(e.EntityTypeName),keyValues:e.KeyValues,propertyName:e.PropertyName&&propNameFn(e.PropertyName),errorMessage:e.ErrorMessage}});return err}ctor.prototype._prepareSaveBundle=function(saveBundle,saveContext){throw new Error("Need a concrete implementation of _prepareSaveBundle")};ctor.prototype._prepareSaveResult=function(saveContext,data){throw new Error("Need a concrete implementation of _prepareSaveResult")};ctor.prototype.jsonResultsAdapter=new JsonResultsAdapter({name:"noop",visitNode:function(node,mappingContext,nodeContext){return{}}});ctor.prototype._handleXHRError=function(deferred,XHR,messagePrefix){var err=this._createError(XHR);if(messagePrefix){err.message=messagePrefix+"; "+err.message}deferred.reject(err);XHR.onreadystatechange=null;XHR.abort=null};ctor.prototype._createError=function(XHR){var err=new Error;err.XHR=XHR;err.responseText=XHR.responseText;err.status=XHR.status;err.statusText=XHR.statusText;err.message=XHR.statusText;if(err.responseText){try{var responseObj=JSON.parse(XHR.responseText);err.detail=responseObj;var source=responseObj.InnerException||responseObj;err.message=source.ExceptionMessage||source.Message||XHR.responseText}catch(e){err.message=err.message+": "+err.responseText}}return err};return ctor}();(function(factory){if(breeze){factory(breeze)}else if(typeof require==="function"&&typeof exports==="object"&&typeof module==="object"){factory(require("breeze"))}else if(typeof define==="function"&&define["amd"]){define(["breeze"],factory)}})(function(breeze){var core=breeze.core;var jQuery;var ctor=function(){this.name="jQuery";this.defaultSettings={}};ctor.prototype.initialize=function(){jQuery=core.requireLib("jQuery")};ctor.prototype.ajax=function(settings){if(!jQuery){throw new Error("Unable to locate jQuery")}if(!core.isEmpty(this.defaultSettings)){var compositeSettings=core.extend({},this.defaultSettings);core.extend(compositeSettings,settings);jQuery.ajax(compositeSettings)}else{jQuery.ajax(settings)}};breeze.config.registerAdapter("ajax",ctor)});(function(factory){if(breeze){factory(breeze)}else if(typeof require==="function"&&typeof exports==="object"&&typeof module==="object"){factory(require("breeze"))}else if(typeof define==="function"&&define["amd"]&&!breeze){define(["breeze"],factory)}})(function(breeze){var core=breeze.core;var MetadataStore=breeze.MetadataStore;var JsonResultsAdapter=breeze.JsonResultsAdapter;var OData;var ctor=function(){this.name="OData"};ctor.prototype.initialize=function(){OData=core.requireLib("OData","Needed to support remote OData services");OData.jsonHandler.recognizeDates=true};ctor.prototype.executeQuery=function(mappingContext){var deferred=Q.defer();OData.read(mappingContext.url,function(data,response){return deferred.resolve({results:data.results,inlineCount:data.__count})},function(error){return deferred.reject(createError(error,mappingContext.url))});return deferred.promise};ctor.prototype.fetchMetadata=function(metadataStore,dataService){var deferred=Q.defer();var serviceName=dataService.serviceName;var url=dataService.makeUrl("$metadata");OData.read(url,function(data){if(!data||!data.dataServices){var error=new Error("Metadata query failed for: "+url);return deferred.reject(error)}var csdlMetadata=data.dataServices;if(!metadataStore.hasMetadataFor(serviceName)){try{metadataStore.importMetadata(csdlMetadata)}catch(e){return deferred.reject(new Error("Metadata query failed for "+url+"; Unable to process returned metadata: "+e.message))}metadataStore.addDataService(dataService)}return deferred.resolve(csdlMetadata)},function(error){var err=createError(error,url);err.message="Metadata query failed for: "+url+"; "+(err.message||"");return deferred.reject(err)},OData.metadataHandler);return deferred.promise};ctor.prototype.saveChanges=function(saveContext,saveBundle){var deferred=Q.defer();var helper=saveContext.entityManager.helper;var url=saveContext.dataService.makeUrl("$batch");var requestData=createChangeRequests(saveContext,saveBundle);var tempKeys=saveContext.tempKeys;var contentKeys=saveContext.contentKeys;OData.request({headers:{DataServiceVersion:"2.0"},requestUri:url,method:"POST",data:requestData},function(data,response){var entities=[];var keyMappings=[];var saveResult={entities:entities,keyMappings:keyMappings};data.__batchResponses.forEach(function(br){br.__changeResponses.forEach(function(cr){var response=cr.response||cr;var statusCode=response.statusCode;if(!statusCode||statusCode>=400){return deferred.reject(createError(cr,url))}var contentId=cr.headers["Content-ID"];var rawEntity=cr.data;if(rawEntity){var tempKey=tempKeys[contentId];if(tempKey){var entityType=tempKey.entityType;if(entityType.autoGeneratedKeyType!==AutoGeneratedKeyType.None){var tempValue=tempKey.values[0];var realKey=helper.getEntityKeyFromRawEntity(rawEntity,entityType,false);var keyMapping={entityTypeName:entityType.name,tempValue:tempValue,realValue:realKey.values[0]};keyMappings.push(keyMapping)}}entities.push(rawEntity)}else{var origEntity=contentKeys[contentId];entities.push(origEntity)}})});return deferred.resolve(saveResult)},function(err){return deferred.reject(createError(err,url))},OData.batchHandler);return deferred.promise};ctor.prototype.jsonResultsAdapter=new JsonResultsAdapter({name:"OData_default",visitNode:function(node,mappingContext,nodeContext){var result={};if(node==null)return result;if(node.__metadata!=null){var entityTypeName=MetadataStore.normalizeTypeName(node.__metadata.type);var et=entityTypeName&&mappingContext.entityManager.metadataStore.getEntityType(entityTypeName,true);if(et&&et._mappedPropertiesCount===Object.keys(node).length-1){result.entityType=et;result.extra=node.__metadata}}var propertyName=nodeContext.propertyName;result.ignore=node.__deferred!=null||propertyName==="__metadata"||propertyName==="EntityKey"&&node.$type&&core.stringStartsWith(node.$type,"System.Data");return result}});function createChangeRequests(saveContext,saveBundle){var changeRequests=[];var tempKeys=[];var contentKeys=[];var prefix=saveContext.dataService.serviceName;var entityManager=saveContext.entityManager;var helper=entityManager.helper;var id=0;saveBundle.entities.forEach(function(entity){var aspect=entity.entityAspect;id=id+1;var request={headers:{"Content-ID":id,DataServiceVersion:"2.0"}};contentKeys[id]=entity;if(aspect.entityState.isAdded()){request.requestUri=entity.entityType.defaultResourceName;request.method="POST";request.data=helper.unwrapInstance(entity,true);tempKeys[id]=aspect.getKey()}else if(aspect.entityState.isModified()){updateDeleteMergeRequest(request,aspect,prefix);request.method="MERGE";request.data=helper.unwrapChangedValues(entity,entityManager.metadataStore,true)}else if(aspect.entityState.isDeleted()){updateDeleteMergeRequest(request,aspect,prefix);request.method="DELETE"}else{return}changeRequests.push(request)});saveContext.contentKeys=contentKeys;saveContext.tempKeys=tempKeys;return{__batchRequests:[{__changeRequests:changeRequests}]}}function updateDeleteMergeRequest(request,aspect,prefix){var extraMetadata=aspect.extraMetadata;var uri=extraMetadata.uri;if(__stringStartsWith(uri,prefix)){uri=uri.substring(prefix.length)}request.requestUri=uri;if(extraMetadata.etag){request.headers["If-Match"]=extraMetadata.etag}}function createError(error,url){var result=new Error;var response=error.response;result.message=response.statusText;result.statusText=response.statusText;result.status=response.statusCode;if(url)result.url=url;result.body=response.body;if(response.body){var nextErr;try{var err=JSON.parse(response.body);result.body=err;var msg="";do{nextErr=err.error||err.innererror;if(!nextErr)msg=msg+getMessage(err);nextErr=nextErr||err.internalexception;err=nextErr||err}while(nextErr);if(msg.length>0){result.message=msg}}catch(e){}}return result}function getMessage(error){var msg=error.message;return msg==null?"":(typeof msg==="string"?msg:msg.value)+"; "}breeze.config.registerAdapter("dataService",ctor)});(function(factory){if(breeze){factory(breeze)}else if(typeof require==="function"&&typeof exports==="object"&&typeof module==="object"){factory(require("breeze"))}else if(typeof define==="function"&&define["amd"]&&!breeze){define(["breeze"],factory)}})(function(breeze){var core=breeze.core;var MetadataStore=breeze.MetadataStore;var JsonResultsAdapter=breeze.JsonResultsAdapter;var AbstractDataServiceAdapter=breeze.AbstractDataServiceAdapter;var ajaxImpl;var ctor=function(){this.name="webApi"};ctor.prototype=new AbstractDataServiceAdapter;ctor.prototype._prepareSaveBundle=function(saveBundle,saveContext){var em=saveContext.entityManager;var metadataStore=em.metadataStore;var helper=em.helper;saveBundle.entities=saveBundle.entities.map(function(e){var rawEntity=helper.unwrapInstance(e);var autoGeneratedKey=null;if(e.entityType.autoGeneratedKeyType!==AutoGeneratedKeyType.None){autoGeneratedKey={propertyName:e.entityType.keyProperties[0].nameOnServer,autoGeneratedKeyType:e.entityType.autoGeneratedKeyType.name}}var originalValuesOnServer=helper.unwrapOriginalValues(e,metadataStore);rawEntity.entityAspect={entityTypeName:e.entityType.name,defaultResourceName:e.entityType.defaultResourceName,entityState:e.entityAspect.entityState.name,originalValuesMap:originalValuesOnServer,autoGeneratedKey:autoGeneratedKey};return rawEntity});saveBundle.saveOptions={tag:saveBundle.saveOptions.tag};return saveBundle};ctor.prototype._prepareSaveResult=function(saveContext,data){var keyMappings=data.KeyMappings.map(function(km){var entityTypeName=MetadataStore.normalizeTypeName(km.EntityTypeName);return{entityTypeName:entityTypeName,tempValue:km.TempValue,realValue:km.RealValue}});return{entities:data.Entities,keyMappings:keyMappings,XHR:data.XHR}};ctor.prototype.jsonResultsAdapter=new JsonResultsAdapter({name:"webApi_default",visitNode:function(node,mappingContext,nodeContext){if(node==null)return{};var entityTypeName=MetadataStore.normalizeTypeName(node.$type);var entityType=entityTypeName&&mappingContext.entityManager.metadataStore._getEntityType(entityTypeName,true);var propertyName=nodeContext.propertyName;var ignore=propertyName&&propertyName.substr(0,1)==="$";return{entityType:entityType,nodeId:node.$id,nodeRefId:node.$ref,ignore:ignore}}});breeze.config.registerAdapter("dataService",ctor)});"use strict";(function(factory){if(breeze){factory(breeze)}else if(typeof require==="function"&&typeof exports==="object"&&typeof module==="object"){factory(require("breeze"))}else if(typeof define==="function"&&define["amd"]&&!breeze){define(["breeze"],factory)}})(function(breeze){var core=breeze.core;var ComplexAspect=breeze.ComplexAspect;var Backbone;var _;var bbSet,bbGet;var hasOwnProperty=Object.prototype.hasOwnProperty;var ctor=function(){this.name="backbone"};ctor.prototype.initialize=function(){Backbone=core.requireLib("Backbone");_=core.requireLib("_;underscore");bbSet=Backbone.Model.prototype.set;bbGet=Backbone.Model.prototype.get};ctor.prototype.createCtor=function(structuralType){var defaults={};structuralType.dataProperties.forEach(function(dp){defaults[dp.name]=dp.defaultValue});var modelCtor=Backbone.Model.extend({defaults:defaults,initialize:function(){if(structuralType.navigationProperties){var that=this;structuralType.navigationProperties.forEach(function(np){if(!np.isScalar){var val=breeze.makeRelationArray([],that,np);Backbone.Model.prototype.set.call(that,np.name,val)}})}}});return modelCtor};ctor.prototype.getTrackablePropertyNames=function(entity){var names=[];for(var p in entity.attributes){names.push(p)}return names};ctor.prototype.initializeEntityPrototype=function(proto){proto.getProperty=function(propertyName){return this.get(propertyName)};proto.setProperty=function(propertyName,value){this.set(propertyName,value);return this};proto.set=function(key,value,options){var aspect=this.entityAspect||this.complexAspect;if(!aspect){return bbSet.call(this,key,value,options)}var attrs,prop,propName;var that=this;var stype=this.entityType||this.complexType;if(_.isObject(key)||key==null){attrs=key;options=value;if(!this._validate(attrs,options))return false;for(propName in attrs){if(hasOwnProperty.call(attrs,propName)){prop=stype.getProperty(propName);if(prop==null){throw new Error("Unknown property: "+key)}var fn=function(pName){return function(pValue){if(arguments.length===0){return bbGet.call(that,pName)}else{return bbSet.call(that,pName,pValue,options)}}}(propName);this._$interceptor(prop,attrs[propName],fn)}}}else{attrs={};attrs[key]=value;options||(options={});if(!this._validate(attrs,options))return false;prop=stype.getProperty(key);if(prop==null){throw new Error("Unknown property: "+key)}propName=key;this._$interceptor(prop,value,function(pvalue){if(arguments.length===0){return bbGet.call(that,propName)}else{return bbSet.call(that,propName,pvalue,options)}})}return this}};ctor.prototype.startTracking=function(entity,proto){if(!(entity instanceof Backbone.Model)){throw new Error("This entity is not an Backbone.Model instance")}var stype=entity.entityType||entity.complexType;var attributes=entity.attributes;stype.dataProperties.forEach(function(dp){var propName=dp.name;var val=attributes[propName];if(dp.isComplexProperty){if(dp.isScalar){val=dp.dataType._createInstanceCore(entity,dp)}else{val=breeze.makeComplexArray([],entity,dp)}}else if(!dp.isScalar){val=breeze.makePrimitiveArray([],entity,dp)}else if(val===undefined){val=dp.defaultValue}bbSet.call(entity,propName,val)});if(stype.navigationProperties){stype.navigationProperties.forEach(function(np){var msg;if(np.name in attributes){var val=bbGet.call(entity,np.name);if(np.isScalar){if(val&&!val.entityType){msg=core.formatString("The value of the '%1' property for entityType: '%2' must be either null or another entity",np.name,entity.entityType.name);throw new Error(msg)}}else{if(val){if(!val.parentEntity){msg=core.formatString("The value of the '%1' property for entityType: '%2' must be either null or a Breeze relation array",np.name,entity.entityType.name);throw new Error(msg)}}else{val=breeze.makeRelationArray([],entity,np);bbSet.call(entity,np.name,val)}}}else{if(np.isScalar){bbSet.call(entity,np.name,null)}else{val=breeze.makeRelationArray([],entity,np);bbSet.call(entity,np.name,val)}}})}};breeze.config.registerAdapter("modelLibrary",ctor)});"use strict";(function(factory){if(breeze){factory(breeze)}else if(typeof require==="function"&&typeof exports==="object"&&typeof module==="object"){factory(require("breeze"))}else if(typeof define==="function"&&define["amd"]&&!breeze){define(["breeze"],factory)}})(function(breeze){var core=breeze.core;var ctor=function(){this.name="backingStore"};ctor.prototype.initialize=function(){};ctor.prototype.getTrackablePropertyNames=function(entity){var names=[];for(var p in entity){if(p==="entityType")continue;if(p==="_$typeName")continue;if(p==="_pendingSets")continue;if(p==="_backingStore")continue;if(p==="_$extra")continue;var val=entity[p];if(!core.isFunction(val)){names.push(p)}}return names};ctor.prototype.initializeEntityPrototype=function(proto){proto.getProperty=function(propertyName){return this[propertyName]};proto.setProperty=function(propertyName,value){if(!this._backingStore.hasOwnProperty(propertyName)){throw new Error("Unknown property name:"+propertyName)
}this[propertyName]=value;return this};proto.initializeFrom=function(rawEntity){var that=this;this.entityType.unmappedProperties.forEach(function(prop){var propName=prop.name;rawEntity[propName]=that[propName]});if(!this._backingStore){this._backingStore={}}};proto._pendingSets=[];proto._pendingSets.schedule=function(entity,propName,value){this.push({entity:entity,propName:propName,value:value});if(!this.isPending){this.isPending=true;var that=this;setTimeout(function(){that.process()})}};proto._pendingSets.process=function(){if(this.length===0)return;this.forEach(function(ps){if(!ps.entity._backingStore){ps.entity._backingStore={}}ps.entity._backingStore[ps.propName]=ps.value});this.length=0;this.isPending=false};movePropDefsToProto(proto)};ctor.prototype.startTracking=function(entity,proto){proto._pendingSets.process();var bs=movePropsToBackingStore(entity);var stype=entity.entityType||entity.complexType;stype.getProperties().forEach(function(prop){var propName=prop.name;var val=entity[propName];if(prop.isDataProperty){if(prop.isComplexProperty){if(prop.isScalar){val=prop.dataType._createInstanceCore(entity,prop)}else{val=breeze.makeComplexArray([],entity,prop)}}else if(!prop.isScalar){val=breeze.makePrimitiveArray([],entity,prop)}else if(val===undefined){val=prop.defaultValue}}else if(prop.isNavigationProperty){if(val!==undefined){throw new Error("Cannot assign a navigation property in an entity ctor.: "+prop.Name)}if(prop.isScalar){val=null}else{val=breeze.makeRelationArray([],entity,prop)}}else{throw new Error("unknown property: "+propName)}bs[propName]=val})};function movePropDefsToProto(proto){var extra=proto._$extra;var alreadyWrapped=extra.alreadyWrappedProps||{};var stype=proto.entityType||proto.complexType;stype.getProperties().forEach(function(prop){var propName=prop.name;if(alreadyWrapped[propName])return;if(propName in proto){wrapPropDescription(proto,prop)}else{makePropDescription(proto,prop)}alreadyWrapped[propName]=true});extra.alreadyWrappedProps=alreadyWrapped}function movePropsToBackingStore(instance){var proto=Object.getPrototypeOf(instance);if(!instance._backingStore){instance._backingStore={}}var stype=proto.entityType||proto.complexType;stype.getProperties().forEach(function(prop){var propName=prop.name;if(!instance.hasOwnProperty(propName))return;var value=instance[propName];delete instance[propName];instance[propName]=value});return instance._backingStore}function makePropDescription(proto,property){var propName=property.name;var getAccessorFn=function(backingStore){return function(){if(arguments.length==0){return backingStore[propName]}else{backingStore[propName]=arguments[0]}}};var descr={get:function(){var bs=this._backingStore;if(!bs){this._pendingSets.process();bs=this._backingStore;if(!bs)return}return bs[propName]},set:function(value){var bs=this._backingStore;if(!bs){this._pendingSets.schedule(this,propName,value);return}var accessorFn=getAccessorFn(bs);this._$interceptor(property,value,accessorFn)},enumerable:true,configurable:true};try{Object.defineProperty(proto,propName,descr)}catch(e){proto[propName]=descr}}function wrapPropDescription(proto,property){if(!proto.hasOwnProperty(property.name)){var nextProto=Object.getPrototypeOf(proto);wrapPropDescription(nextProto,property);return}var propDescr=Object.getOwnPropertyDescriptor(proto,property.name);if(!propDescr.configurable)return;if(propDescr.value)return;if(!propDescr.set)return;var getAccessorFn=function(entity){return function(){if(arguments.length==0){return propDescr.get.bind(entity)()}else{propDescr.set.bind(entity)(arguments[0])}}};var newDescr={get:function(){return propDescr.get.bind(this)()},set:function(value){this._$interceptor(property,value,getAccessorFn(this))},enumerable:propDescr.enumerable,configurable:true};try{Object.defineProperty(proto,property.name,newDescr)}catch(e){proto[property.name]=newDescr}}breeze.config.registerAdapter("modelLibrary",ctor)});"use strict";(function(factory){if(breeze){factory(breeze)}else if(typeof require==="function"&&typeof exports==="object"&&typeof module==="object"){factory(require("breeze"))}else if(typeof define==="function"&&define["amd"]&&!breeze){define(["breeze"],factory)}})(function(breeze){var core=breeze.core;var ko;var ctor=function(){this.name="ko"};ctor.prototype.initialize=function(){ko=core.requireLib("ko","The Knockout library");ko.extenders.intercept=function(target,interceptorOptions){var instance=interceptorOptions.instance;var property=interceptorOptions.property;var result;if(target.splice){result=ko.computed({read:target})}else{result=ko.computed({read:target,write:function(newValue){instance._$interceptor(property,newValue,target);return instance}})}return result}};ctor.prototype.getTrackablePropertyNames=function(entity){var names=[];for(var p in entity){if(p==="entityType")continue;if(p==="_$typeName")continue;if(p==="_$extra")continue;var val=entity[p];if(ko.isObservable(val)){names.push(p)}else if(!core.isFunction(val)){names.push(p)}}return names};ctor.prototype.initializeEntityPrototype=function(proto){proto.getProperty=function(propertyName){return this[propertyName]()};proto.setProperty=function(propertyName,value){this[propertyName](value);return this};isolateES5Props(proto)};function isolateES5Props(proto){var stype=proto.entityType||proto.complexType;es5Descriptors={};stype.getProperties().forEach(function(prop){propDescr=getES5PropDescriptor(proto,prop);if(propDescr){es5Descriptors[prop.name]=propDescr}});if(!__isEmpty(es5Descriptors)){var extra=proto._$extra;extra.es5Descriptors=es5Descriptors;extra.koDummy=ko.observable(null)}}function getES5PropDescriptor(proto,prop){var propName=prop.name;if(proto.hasOwnProperty(propName)){return Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(proto,propName)}else{var nextProto=Object.getPrototypeOf(proto);return nextProto?getES5PropDescriptor(nextProto,prop):null}}ctor.prototype.startTracking=function(entity,proto){var stype=entity.entityType||entity.complexType;var es5Descriptors=proto._$extra.es5Descriptors||{};stype.getProperties().sort(function(p1,p2){var v1=p1.isUnmapped?1:0;var v2=p2.isUnmapped?1:0;return v1-v2}).forEach(function(prop){var propName=prop.name;var val=entity[propName];var propDescr=es5Descriptors[propName];var koObj;if(propDescr){var getFn=propDescr.get.bind(entity);if(propDescr.set){var setFn=propDescr.set.bind(entity);var rawAccessorFn=function(newValue){if(arguments.length===0){return getFn()}else{setFn(newValue)}};koObj=ko.computed({read:function(){entity._$extra.koDummy();return getFn()},write:function(newValue){entity._$interceptor(prop,newValue,rawAccessorFn);entity._$extra.koDummy.valueHasMutated();return entity}})}else{koObj=ko.computed({read:getFn,write:function(){}})}}else if(ko.isObservable(val)){if(prop.isNavigationProperty){throw new Error("Cannot assign a navigation property in an entity ctor.: "+propName)}koObj=val}else{var val=initializeValueForProp(entity,prop,val);koObj=prop.isScalar?ko.observable(val):ko.observableArray(val)}if(prop.isScalar){if(propDescr){var tmpDescr={enumerable:true,configurable:true,writable:true,value:koObj};try{Object.defineProperty(entity,propName,tmpDescr)}catch(e){entity[propName]=tmpDescr}}else{var koExt=koObj.extend({intercept:{instance:entity,property:prop}});entity[propName]=koExt}}else{val._koObj=koObj;koObj.subscribe(onBeforeChange,null,"beforeChange");val.arrayChanged.subscribe(onArrayChanged);koObj.equalityComparer=function(){throw new Error("Collection navigation properties may NOT be set.")};entity[propName]=koObj}})};function initializeValueForProp(entity,prop,val){if(prop.isDataProperty){if(prop.isComplexProperty){if(prop.isScalar){val=prop.dataType._createInstanceCore(entity,prop)}else{val=breeze.makeComplexArray([],entity,prop)}}else if(!prop.isScalar){val=breeze.makePrimitiveArray([],entity,prop)}else if(val===undefined){val=prop.defaultValue}}else if(prop.isNavigationProperty){if(val!==undefined){throw new Error("Cannot assign a navigation property in an entity ctor.: "+prop.name)}if(prop.isScalar){val=null}else{val=breeze.makeRelationArray([],entity,prop)}}else{throw new Error("unknown property: "+prop.name)}return val}function onBeforeChange(args){args._koObj._suppressBreeze=true}function onArrayChanged(args){var koObj=args.array._koObj;if(koObj._suppressBreeze){koObj._suppressBreeze=false}else{koObj.valueHasMutated()}}breeze.config.registerAdapter("modelLibrary",ctor)});breeze.config.initializeAdapterInstances({dataService:"webApi",ajax:"jQuery"});var ko=__requireLibCore("ko");if(ko){breeze.config.initializeAdapterInstance("modelLibrary","ko")}else{breeze.config.initializeAdapterInstance("modelLibrary","backingStore")}if(this.window){this.window.breeze=breeze}return breeze});