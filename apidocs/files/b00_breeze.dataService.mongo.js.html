<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>b00_breeze.dataService.mongo.js - The Breeze API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.1&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
<!-- commenting out until beta goes live	<link rel="stylesheet" href="http://breezejs.com/sites/all/themes/omega/alpha/css/apha-reset.css"> 
-->    
	<link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.5.1&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">
<script type="text/javascript">
  var uvOptions = {};
  (function() {
    var uv = document.createElement('script'); uv.type = 'text/javascript'; uv.async = true;
    uv.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'widget.uservoice.com/GHug452CgVREu58xjoDg.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(uv, s);
  })();
</script>
<div id="wrap">

<div id="doc">
<div class="header">
<div class="logo">
	<a href="http://www.breezejs.com/home"><img src="http://www.breezejs.com/sites/all/themes/breeze/images/breeze_large.png" /></a>
	</div>

    <div class="primary-nav">
<ul>
		
		<li>
			<a href="http://www.breezejs.com/documentation/download" target="_blank">Download</a></li>
		<li>
			<a href="http://learn.breezejs.com/" target="_blank">Tutorials</a></li>	
		<li>
			<a href="http://www.breezejs.com/documentation/introduction">Docs</a></li>
		<li>
			<a href="http://www.breezejs.com/samples">Samples</a></li>
		<li>
			<a href="http://www.breezejs.com/sites/all/apidocs/index.html" target="_blank">API</a></li>
		<li>
			<a href="http://stackoverflow.com/questions/tagged/breeze?sort=newest" target="_blank">Forum</a></li>
		<li>
			<a href="http://www.breezejs.com/support" target="_blank">Support</a></li>	
		
	</ul>
</div>
</div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/AutoGeneratedKeyType.html">AutoGeneratedKeyType</a></li>
            
                <li><a href="..&#x2F;classes/ComplexAspect.html">ComplexAspect</a></li>
            
                <li><a href="..&#x2F;classes/ComplexType.html">ComplexType</a></li>
            
                <li><a href="..&#x2F;classes/config.html">config</a></li>
            
                <li><a href="..&#x2F;classes/DataProperty.html">DataProperty</a></li>
            
                <li><a href="..&#x2F;classes/DataService.html">DataService</a></li>
            
                <li><a href="..&#x2F;classes/DataType.html">DataType</a></li>
            
                <li><a href="..&#x2F;classes/EntityAction.html">EntityAction</a></li>
            
                <li><a href="..&#x2F;classes/EntityAspect.html">EntityAspect</a></li>
            
                <li><a href="..&#x2F;classes/EntityKey.html">EntityKey</a></li>
            
                <li><a href="..&#x2F;classes/EntityManager.html">EntityManager</a></li>
            
                <li><a href="..&#x2F;classes/EntityQuery.html">EntityQuery</a></li>
            
                <li><a href="..&#x2F;classes/EntityState.html">EntityState</a></li>
            
                <li><a href="..&#x2F;classes/EntityType.html">EntityType</a></li>
            
                <li><a href="..&#x2F;classes/Enum.html">Enum</a></li>
            
                <li><a href="..&#x2F;classes/EnumSymbol.html">EnumSymbol</a></li>
            
                <li><a href="..&#x2F;classes/Event.html">Event</a></li>
            
                <li><a href="..&#x2F;classes/FetchStrategy.html">FetchStrategy</a></li>
            
                <li><a href="..&#x2F;classes/FilterQueryOp.html">FilterQueryOp</a></li>
            
                <li><a href="..&#x2F;classes/JsonResultsAdapter.html">JsonResultsAdapter</a></li>
            
                <li><a href="..&#x2F;classes/LocalQueryComparisonOptions.html">LocalQueryComparisonOptions</a></li>
            
                <li><a href="..&#x2F;classes/MergeStrategy.html">MergeStrategy</a></li>
            
                <li><a href="..&#x2F;classes/MetadataStore.html">MetadataStore</a></li>
            
                <li><a href="..&#x2F;classes/NamingConvention.html">NamingConvention</a></li>
            
                <li><a href="..&#x2F;classes/NavigationProperty.html">NavigationProperty</a></li>
            
                <li><a href="..&#x2F;classes/Predicate.html">Predicate</a></li>
            
                <li><a href="..&#x2F;classes/Promise.html">Promise</a></li>
            
                <li><a href="..&#x2F;classes/QueryOptions.html">QueryOptions</a></li>
            
                <li><a href="..&#x2F;classes/SaveOptions.html">SaveOptions</a></li>
            
                <li><a href="..&#x2F;classes/ValidationError.html">ValidationError</a></li>
            
                <li><a href="..&#x2F;classes/ValidationOptions.html">ValidationOptions</a></li>
            
                <li><a href="..&#x2F;classes/Validator.html">Validator</a></li>
            
                <li><a href="..&#x2F;classes/ↈ_complexArray_.html">ↈ_complexArray_</a></li>
            
                <li><a href="..&#x2F;classes/ↈ_keyGenerator_interface.html">ↈ_keyGenerator_interface</a></li>
            
                <li><a href="..&#x2F;classes/ↈ_relationArray_.html">ↈ_relationArray_</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/breeze.html">breeze</a></li>
            
                <li><a href="..&#x2F;modules/core.html">core</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: b00_breeze.dataService.mongo.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
﻿(function(factory) {
    if (typeof require === &quot;function&quot; &amp;&amp; typeof exports === &quot;object&quot; &amp;&amp; typeof module === &quot;object&quot;) {
        &#x2F;&#x2F; CommonJS or Node: hard-coded dependency on &quot;breeze&quot;
        factory(require(&quot;breeze&quot;));
    } else if (typeof define === &quot;function&quot; &amp;&amp; define[&quot;amd&quot;] &amp;&amp; !breeze) {
        &#x2F;&#x2F; AMD anonymous module with hard-coded dependency on &quot;breeze&quot;
        define([&quot;breeze&quot;], factory);
    } else {
        &#x2F;&#x2F; &lt;script&gt; tag: use the global &#x60;breeze&#x60; object
        factory(breeze);
    }    
}(function(breeze) {
       
    var core = breeze.core;

    var MetadataStore = breeze.MetadataStore;
    var JsonResultsAdapter = breeze.JsonResultsAdapter;
    var AbstractDataServiceAdapter = breeze.AbstractDataServiceAdapter;

    var ajaxImpl;

    function fmtOData(val) {
        return val == null ? null : &quot;&#x27;&quot; + val + &quot;&#x27;&quot; ; 
    } 

    function getNextObjectId() {
        return new ObjectId().toString();
    }

    var ctor = function () {
        this.name = &quot;mongo&quot;;
        breeze.DataType.MongoObjectId = breeze.DataType.addSymbol({
            defaultValue: &quot;&quot;,
            fmtOData: fmtOData,
            getNext: getNextObjectId
        });
    };

    ctor.prototype = new AbstractDataServiceAdapter();
    
    ctor.prototype._prepareSaveBundle = function(saveBundle, saveContext) {
        var em = saveContext.entityManager;
        var metadataStore = em.metadataStore;
        var helper = em.helper;
        var metadata = {};
        
        saveBundle.entities = saveBundle.entities.map(function (e) {
            var rawEntity = helper.unwrapInstance(e);
            var entityTypeName = e.entityType.name;
            var etInfo = metadata[entityTypeName];
            if (!etInfo) {
                etInfo = {};
                var entityType = e.entityType;
                etInfo.dataProperties = entityType.dataProperties.map(function(dp) {
                    var p = { name: dp.nameOnServer, dataType: dp.dataType.name };
                    if (dp.relatedNavigationProperty != null) {
                        p.isFk = true;
                    }
                    if (dp.concurrencyMode &amp;&amp; dp.concurrencyMode === &quot;Fixed&quot;) {
                        p.isConcurrencyProp = true;
                    }
                    return p;
                });
                if (entityType.autoGeneratedKeyType !== AutoGeneratedKeyType.None) {
                    etInfo.autoGeneratedKey = {
                        propertyName: entityType.keyProperties[0].nameOnServer,
                        autoGeneratedKeyType: entityType.autoGeneratedKeyType.name
                    };
                }
                metadata[entityTypeName] = etInfo;
            }
            var originalValuesOnServer = helper.unwrapOriginalValues(e, metadataStore);
            var rawAspect = {
                entityTypeName: e.entityType.name,
                defaultResourceName: e.entityType.defaultResourceName,
                entityState: e.entityAspect.entityState.name,
                originalValuesMap: originalValuesOnServer
            };           
                
            rawEntity.entityAspect = rawAspect;
            return rawEntity;
        });

        saveBundle.metadata = metadata;
        saveBundle.saveOptions = { tag: saveBundle.saveOptions.tag };

        return saveBundle;
    }

    ctor.prototype._prepareSaveResult = function (saveContext, data) {
        
        var em = saveContext.entityManager;
        var keys = data.insertedKeys.concat(data.updatedKeys, data.deletedKeys);
        var entities = keys.map(function (key) {
            return em.getEntityByKey(key.entityTypeName, key._id);
        });
        return { entities: entities, keyMappings: data.keyMappings, XHR: data.XHR };
    }


    ctor.prototype.jsonResultsAdapter = new JsonResultsAdapter({
        name: &quot;mongo&quot;,

        visitNode: function (node, mappingContext, nodeContext) {
            if (node == null) return {};
            var result = {};
            &#x2F;&#x2F; this will only be set on saveResults and projections.
            if (node.$type) {
                result.entityType = mappingContext.entityManager.metadataStore._getEntityType(node.$type, true);
            }
            return result;
        }
    });

    &#x2F;*
    *
    * Copyright (c) 2011 Justin Dearing (zippy1981@gmail.com)
    * Dual licensed under the MIT (http:&#x2F;&#x2F;www.opensource.org&#x2F;licenses&#x2F;mit-license.php)
    * and GPL (http:&#x2F;&#x2F;www.opensource.org&#x2F;licenses&#x2F;gpl-license.php) version 2 licenses.
    * This software is not distributed under version 3 or later of the GPL.
    *
    * Version 1.0.0
    *
    *&#x2F;

    &#x2F;**
     * Javascript class that mimics how WCF serializes a object of type MongoDB.Bson.ObjectId
     * and converts between that format and the standard 24 character representation.
    *&#x2F;
    var ObjectId = (function () {
        var increment = 0;
        var pid = Math.floor(Math.random() * (32767));
        var machine = Math.floor(Math.random() * (16777216));

        if (typeof (localStorage) != &#x27;undefined&#x27;) {
            var mongoMachineId = parseInt(localStorage[&#x27;mongoMachineId&#x27;]);
            if (mongoMachineId &gt;= 0 &amp;&amp; mongoMachineId &lt;= 16777215) {
                machine = Math.floor(localStorage[&#x27;mongoMachineId&#x27;]);
            }
            &#x2F;&#x2F; Just always stick the value in.
            localStorage[&#x27;mongoMachineId&#x27;] = machine;
            document.cookie = &#x27;mongoMachineId=&#x27; + machine + &#x27;;expires=Tue, 19 Jan 2038 05:00:00 GMT&#x27;
        }
        else {
            var cookieList = document.cookie.split(&#x27;; &#x27;);
            for (var i in cookieList) {
                var cookie = cookieList[i].split(&#x27;=&#x27;);
                if (cookie[0] == &#x27;mongoMachineId&#x27; &amp;&amp; cookie[1] &gt;= 0 &amp;&amp; cookie[1] &lt;= 16777215) {
                    machine = cookie[1];
                    break;
                }
            }
            document.cookie = &#x27;mongoMachineId=&#x27; + machine + &#x27;;expires=Tue, 19 Jan 2038 05:00:00 GMT&#x27;;

        }

        return function () {
            if (!(this instanceof ObjectId)) {
                return new ObjectId(arguments[0], arguments[1], arguments[2], arguments[3]).toString();
            }

            if (typeof (arguments[0]) == &#x27;object&#x27;) {
                this.timestamp = arguments[0].timestamp;
                this.machine = arguments[0].machine;
                this.pid = arguments[0].pid;
                this.increment = arguments[0].increment;
            }
            else if (typeof (arguments[0]) == &#x27;string&#x27; &amp;&amp; arguments[0].length == 24) {
                this.timestamp = Number(&#x27;0x&#x27; + arguments[0].substr(0, 8)),
                this.machine = Number(&#x27;0x&#x27; + arguments[0].substr(8, 6)),
                this.pid = Number(&#x27;0x&#x27; + arguments[0].substr(14, 4)),
                this.increment = Number(&#x27;0x&#x27; + arguments[0].substr(18, 6))
            }
            else if (arguments.length == 4 &amp;&amp; arguments[0] != null) {
                this.timestamp = arguments[0];
                this.machine = arguments[1];
                this.pid = arguments[2];
                this.increment = arguments[3];
            }
            else {
                this.timestamp = Math.floor(new Date().valueOf() &#x2F; 1000);
                this.machine = machine;
                this.pid = pid;
                if (increment &gt; 0xffffff) {
                    increment = 0;
                }
                this.increment = increment++;

            }
        };
    })();

    ObjectId.prototype.getDate = function () {
        return new Date(this.timestamp * 1000);
    }

    &#x2F;**
    * Turns a WCF representation of a BSON ObjectId into a 24 character string representation.
    *&#x2F;
    ObjectId.prototype.toString = function () {
        var timestamp = this.timestamp.toString(16);
        var machine = this.machine.toString(16);
        var pid = this.pid.toString(16);
        var increment = this.increment.toString(16);
        return &#x27;00000000&#x27;.substr(0, 6 - timestamp.length) + timestamp +
               &#x27;000000&#x27;.substr(0, 6 - machine.length) + machine +
               &#x27;0000&#x27;.substr(0, 4 - pid.length) + pid +
               &#x27;000000&#x27;.substr(0, 6 - increment.length) + increment;
    }
    
    breeze.config.registerAdapter(&quot;dataService&quot;, ctor);

}));
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="primary-nav-foot">
	<ul>
		<li>
			<a href="http://www.breezejs.com/documentation/download" target="_blank">Download</a></li>
		<li>
			<a href="http://learn.breezejs.com/" target="_blank">Tutorials</a></li>	
		<li>
			<a href="http://www.breezejs.com/documentation/introduction">Docs</a></li>
		<li>
			<a href="http://www.breezejs.com/samples">Samples</a></li>
		<li>
			<a href="http://www.breezejs.com/sites/all/apidocs/index.html" target="_blank">API</a></li>
		<li>
			<a href="http://stackoverflow.com/questions/tagged/breeze?sort=newest" target="_blank">Forum</a></li>
		<li>
			<a href="http://www.breezejs.com/support" target="_blank">Support</a></li>
	</ul>
</div>
</div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
